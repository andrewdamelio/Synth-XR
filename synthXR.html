<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synth XR - Advanced Web Synthesizer</title>

    <link rel="apple-touch-icon" sizes="180x180" href="./icons/apple-touch-icon.png">
    <meta name="apple-mobile-web-app-title" content="Synth XR">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Standard Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16x16.png">
    <meta name="theme-color" content="#6200ea">
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Modern Color Scheme */
            --primary: #6200ea;
            --primary-light: #9d46ff;
            --primary-dark: #0a00b6;
            --secondary: #00e5ff;
            --secondary-light: #6effff;
            --secondary-dark: #00b2cc;
            --accent: #00b8d4;
            
            /* UI Colors */
            --background: #121212;
            --surface: #1e1e1e;
            --surface-light: #2a2a2a;
            --surface-dark: #181818;
            --panel: #252525;
            --text: #ffffff;
            --text-secondary: #b0b0b0;
            
            /* Functional Colors */
            --success: #00c853;
            --error: #ff1744;
            --warning: #ffab00;
            --info: #2196f3;
            
            /* Knob Colors */
            --knob-bg: #333333;
            --knob-indicator: var(--secondary);
            
            /* Animations */
            --transition-fast: 0.15s;
            --transition-normal: 0.3s;
            --transition-slow: 0.5s;
            
            /* Shadows */
            --shadow-small: 0 2px 5px rgba(0, 0, 0, 0.2);
            --shadow-normal: 0 4px 10px rgba(0, 0, 0, 0.3);
            --shadow-large: 0 8px 20px rgba(0, 0, 0, 0.4);
            
            /* Glows */
            --glow-primary: 0 0 10px rgba(157, 70, 255, 0.5);
            --glow-secondary: 0 0 10px rgba(0, 229, 255, 0.5);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', 'Roboto', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            padding: 20px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
        }
        
        .synth-container {
            width: 100%;
            max-width: 1400px;
            background: var(--surface);
            border-radius: 16px;
            box-shadow: var(--shadow-large), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-gap: 20px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }
        
        .synth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        
        .brand {
            grid-column: 1 / 13;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .brand-name {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-light), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }
        
        .version {
            color: var(--text-secondary);
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        .master-controls {
            grid-column: 1 / 13;
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .master-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            background: var(--surface-light);
            border: none;
            color: var(--text);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-small);
        }
        
        .master-button:hover {
            background: var(--primary);
            color: white;
            box-shadow: var(--glow-primary);
            transform: translateY(-1px);
        }
        
        .master-button.playing {
            background: var(--primary);
            color: white;
            box-shadow: var(--glow-primary);
        }
        
        .master-button.success {
            background: var(--success);
        }
        
        .master-button i {
            font-size: 1rem;
        }
        
        .spacer {
            flex-grow: 1;
        }
        
        .module {
            background: var(--panel);
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow-normal);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        .module::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary-dark));
            opacity: 0.8;
        }
        
        .module-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .module-title {
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .module-title i {
            color: var(--secondary);
            font-size: 0.9rem;
        }
        
        .main-modules {
            grid-column: 1 / 9;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 20px;
        }
        
        .oscillator-module { grid-column: 1 / 2; }
        .filter-module { grid-column: 2 / 3; }
        .effects-module { overflow: auto; height: 570px; grid-column: 3 / 4; }
        
        .adsr-module {
            grid-column: 1 / 4;
        }
        
        .visualization {
            grid-column: 9 / 13;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .oscilloscope-module {
            height: 100%;
            flex: 2;
        }
                
        .sequencer-container {
            grid-column: 1 / 13;
        }
        
        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            margin-bottom: 14px;
        }
        
        .control-group:last-child {
            margin-bottom: 0;
        }
        
        /* New effect group styles */
        .effect-group {
            border: 1px dotted rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 14px;
        }
        
        .effect-group-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .effect-group-label i {
            color: var(--secondary);
            font-size: 0.8rem;
        }
        
        .knob-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
            flex: 1;
            min-width: 80px;
        }
        
        .knob-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .knob {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--knob-bg);
            position: relative;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3),
                        inset 0 2px 3px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .knob-inner {
            width: 72%;
            height: 72%;
            border-radius: 50%;
            background: linear-gradient(135deg, #444, #222);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .knob::before {
            content: '';
            position: absolute;
            width: 4px;
            height: 20px;
            background: var(--knob-indicator);
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 2px;
            box-shadow: 0 0 5px var(--knob-indicator);
        }
        
        .knob::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--knob-indicator);
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 5px var(--knob-indicator);
            opacity: 0.8;
        }
        
        .knob-value {
            margin-top: 4px;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.8rem;
            color: var(--secondary);
            text-shadow: 0 0 5px rgba(0, 229, 255, 0.3);
        }
        
        .select-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }
        
        .select-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        select {
            background: var(--surface-dark);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 36px;
        }
        
        select:hover, select:focus {
            border-color: var(--primary);
            box-shadow: var(--glow-primary);
            outline: none;
        }
        
        /* Toggle switch styling */
        .toggle-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        
        .toggle-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--surface-dark);
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: var(--text);
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .toggle-state {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .oscilloscope {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            border-radius: 6px;
            background: var(--background);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .oscilloscope-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: center center;
            z-index: 1;
        }
        
        .oscilloscope canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
        }
        
        .vu-meter {
            height: 24px;
            background: var(--background);
            border-radius: 12px;
            margin-top: 16px;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .vu-meter-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--error));
            transition: width 0.05s;
            border-radius: 12px;
        }
        
        .vu-meter::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(90deg, transparent 9%, rgba(255, 255, 255, 0.1) 10%, transparent 11%),
                linear-gradient(90deg, transparent 24%, rgba(255, 255, 255, 0.1) 25%, transparent 26%),
                linear-gradient(90deg, transparent 49%, rgba(255, 255, 255, 0.1) 50%, transparent 51%),
                linear-gradient(90deg, transparent 74%, rgba(255, 255, 255, 0.1) 75%, transparent 76%),
                linear-gradient(90deg, transparent 89%, rgba(255, 255, 255, 0.1) 90%, transparent 91%);
            pointer-events: none;
        }
        
        .sequencer {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 6px;
            position: relative;
        }
        
        .step {
            background: var(--surface-dark);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 10px;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-small);
        }
        
        .step-led {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--knob-bg);
            align-self: center;
            transition: all var(--transition-fast);
            box-shadow: inset 0 0 3px rgba(0, 0, 0, 0.5);
        }
        
        .step select {
            padding: 6px;
            font-size: 0.8rem;
        }
        
        .step-toggle {
            background: var(--surface-light);
            color: var(--text-secondary);
            border: none;
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .step-toggle.active {
            background: var(--primary);
            color: white;
        }
        
        .step.active {
            background: var(--surface-light);
            box-shadow: 0 0 10px rgba(157, 70, 255, 0.3);
        }
        
        .step.active .step-led {
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary-light);
        }
        
        .step::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary-light);
            transform: scaleX(0);
            transition: transform var(--transition-fast);
            transform-origin: left;
        }
        
        .step.active::before {
            transform: scaleX(1);
        }
        
        .keyboard {
            display: flex;
            /* justify-content: center; */
            margin-top: 20px;
            height: 80px;
            position: relative;
            transform-style: preserve-3d;
            perspective: 500px;
        }
        
        .key {
            flex: 1;
            max-width: 40px;
            height: 100%;
            background: var(--surface-light);
            border: 1px solid var(--surface-dark);
            border-radius: 0 0 5px 5px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            transform-origin: top;
            transition: transform 0.1s, background 0.1s;
            position: relative;
            z-index: 1;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }
        
        .key:hover {
            background: var(--surface);
        }
        
        .key.active {
            transform: rotateX(10deg);
            background: var(--primary-light);
            color: white;
        }
        
        .black-key {
            position: absolute;
            width: 24px;
            height: 60%;
            background: var(--background);
            border-radius: 0 0 3px 3px;
            z-index: 2;
            cursor: pointer;
            transition: transform 0.1s, background 0.1s;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.4);
        }
        
        .black-key:hover {
            background: #000;
        }
        
        .black-key.active {
            transform: translateY(2px);
            background: var(--primary-dark);
        }
        
        .preset-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            max-height: 200px;
            padding-right: 8px;
        }
        
        .preset-item {
            background: var(--surface-dark);
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .preset-item:hover {
            background: var(--surface-light);
        }
        
        .preset-item.active {
            background: var(--primary-dark);
        }
        
        .preset-item i {
            color: var(--primary-light);
        }
        
        .preset-name {
            flex-grow: 1;
        }
        
        .preset-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .preset-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            background: var(--surface-light);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all var(--transition-fast);
        }
        
        .preset-actions button:hover {
            background: var(--primary);
            color: white;
        }
        
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: var(--surface-dark);
            color: var(--text);
            font-size: 0.7rem;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-fast);
            box-shadow: var(--shadow-small);
        }
        
        *:hover > .tooltip {
            opacity: 1;
        }
        
        /* Preset tag styles */
        .preset-tag {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .preset-tag.bass {
            background-color: #00796B;
            color: white;
        }
        
        .preset-tag.lead {
            background-color: #C2185B;
            color: white;
        }
        
        .preset-tag.pad {
            background-color: #303F9F;
            color: white;
        }
        
        .preset-tag.fx {
            background-color: #7B1FA2;
            color: white;
        }
        
        .preset-tag.pluck {
            background-color: #0288D1;
            color: white;
        }
        
        .preset-tag.keys {
            background-color: #689F38;
            color: white;
        }
        
        .preset-tag.custom {
            background-color: #FFA000;
            color: white;
        }

        /* Modal styles for preset naming */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow-large);
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .modal-overlay.active .modal {
            transform: translateY(0);
        }
        
        .modal-header {
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
            color: var(--text);
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-input {
            width: 100%;
            background: var(--surface-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 1rem;
            margin-top: 10px;
        }
        
        .modal-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow-primary);
        }

        .modal-select {
            width: 100%;
            background: var(--surface-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 1rem;
            margin-top: 10px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }
        
        .modal-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--glow-primary);
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .modal-button.cancel {
            background: var(--surface-light);
            color: var(--text);
        }
        
        .modal-button.confirm {
            background: var(--primary);
            color: white;
        }
        
        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-small);
        }
        
        .modal-button.cancel:hover {
            background: var(--surface);
        }
        
        .modal-button.confirm:hover {
            background: var(--primary-light);
            box-shadow: var(--glow-primary);
        }

        /* New visualizations */
        .adsr-visualizer {
            height: 70px;
            background: var(--background);
            border-radius: 6px;
            margin-top: 10px;
            position: relative;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .adsr-graph {
            height: 100%;
            width: 100%;
            position: relative;
        }

        .adsr-path {
            stroke: var(--secondary);
            stroke-width: 2;
            fill: none;
            filter: drop-shadow(0 0 2px var(--secondary));
        }

        .adsr-marker {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--secondary);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 5px var(--secondary);
        }

        .filter-response {
            height: 70px;
            background: var(--background);
            border-radius: 6px;
            margin-top: 10px;
            position: relative;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .filter-curve {
            stroke: var(--secondary);
            stroke-width: 2;
            fill: none;
            filter: drop-shadow(0 0 2px var(--secondary));
        }

        .filter-area {
            fill: rgba(0, 229, 255, 0.1);
        }

        .advanced-visualizers {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            overflow: hidden;
            transition: max-height 0.3s;
        }
        
        .visualizer-toggle {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px;
            background: var(--surface-dark);
            border-radius: 6px;
            margin-top: 10px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .visualizer-toggle:hover {
            background: var(--surface-light);
        }
        
        .visualizer-toggle i {
            margin-right: 8px;
            color: var(--secondary);
            transition: transform 0.3s;
        }
        
        .visualizer-toggle.active i {
            transform: rotate(180deg);
        }

        .spectrum-analyzer, 
        .waveform-3d, 
        .particle-system {
            height: 150px;
            background: var(--background);
            border-radius: 6px;
            position: relative;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            margin: auto;
        }

        .visualizer-title {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            z-index: 5;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            pointer-events: none;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--surface-dark);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-dark);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Sequencer key highlight animation */
        @keyframes keyHighlight {
            0% { background: var(--surface-light); }
            50% { background: var(--primary-light); }
            100% { background: var(--surface-light); }
        }

        input[type="range"] {
            display: none;
        }
        
        /* Responsive design */
        @media (max-width: 1200px) {
            .synth-container {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .brand {
                grid-column: 1 / 7;
            }
            
            .master-controls {
                grid-column: 1 / 7;
            }
            
            .main-modules {
                grid-column: 1 / 7;
                grid-template-columns: repeat(2, 1fr);
            }
            
            .oscillator-module { grid-column: 1 / 2; }
            .filter-module { grid-column: 2 / 3; }
            .effects-module { grid-column: 1 / 3; }
            .adsr-module { grid-column: 1 / 3; }
            
            .visualization {
                grid-column: 1 / 7;
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 20px;
            }
            
            .oscilloscope {
                height: 120px;
            }
            
            .oscilloscope-module {
                grid-column: 1 / 2;
            }
            
            .preset-module {
                grid-column: 2 / 3;
            }
            
            .sequencer-container {
                grid-column: 1 / 7;
            }
        }
        
        @media (max-width: 768px) {
            .synth-container {
                padding: 15px;
                grid-gap: 15px;
            }
            
            .main-modules {
                grid-template-columns: 1fr;
            }
            
            .oscillator-module,
            .filter-module,
            .effects-module,
            .adsr-module {
                grid-column: 1 / 7;
            }
            
            .visualization {
                grid-template-columns: 1fr;
            }
            
            .oscilloscope-module,
            .preset-module {
                grid-column: 1 / 7;
            }
            
            .control-group {
                gap: 15px;
            }
            
            .knob {
                width: 50px;
                height: 50px;
            }
            
            .sequencer {
                grid-template-columns: repeat(8, 1fr);
                grid-template-rows: repeat(2, auto);
            }
            
            .keyboard {
                height: 60px;
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            .key {
                min-width: 30px;
            }
        }
        
        @media (max-width: 480px) {
            .brand-name {
                font-size: 1.5rem;
            }
            
            .master-controls {
                flex-wrap: wrap;
            }
            
            .module {
                padding: 12px;
            }
            
            .module-title {
                font-size: 0.9rem;
            }
            
            .sequencer {
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: repeat(4, auto);
            }
            
            .knob-container {
                min-width: 60px;
            }
            
            .knob {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="synth-container">
        <div class="brand">
            <div class="brand-name">Synth XR</div>
            <div class="version">v4.0</div>
        </div>
        
        <div class="master-controls">
            <button class="master-button" id="startSequencer">
                <i class="fas fa-play"></i>
                <span>Start</span>
            </button>
            <button class="master-button" id="nudgeButton">
                <i class="fas fa-random"></i>
                <span>Nudge</span>
            </button>
            <button class="master-button" id="chaosButton">
                <i class="fas fa-bolt"></i>
                <span>Chaos</span>
            </button>
            
            <div class="spacer"></div>
            
            <button class="master-button" id="initPatchButton">
                <i class="fas fa-undo"></i>
                <span>Init Patch</span>
            </button>
        </div>
        
        <div class="main-modules">
            <div class="module oscillator-module">
                <div class="module-header">
                    <h3 class="module-title">
                        <i class="fas fa-wave-square"></i>
                        Oscillator
                    </h3>
                </div>
                <div class="control-group">
                    <div class="select-container">
                        <label class="select-label">Waveform</label>
                        <select id="waveform">
                            <option value="sine">Sine</option>
                            <option value="square">Square</option>
                            <option value="sawtooth">Sawtooth</option>
                            <option value="triangle">Triangle</option>
                            <option value="pulse">Pulse</option>
                            <option value="fmsine">FM Sine</option>
                            <option value="amsine">AM Sine</option>
                            <option value="fatsawtooth">Fat Saw</option>
                            <option value="fatsquare" selected>Fat Square</option>
                        </select>
                    </div>
                </div>
                <div class="control-group">
                    <div class="knob-container">
                        <label class="knob-label">Tempo</label>
                        <div class="knob" id="tempoKnob">
                            <div class="knob-inner"></div>
                            <div class="tooltip">Adjust tempo</div>
                        </div>
                        <input type="range" id="tempo" min="60" max="200" value="120">
                        <span class="knob-value" id="tempoValue">120 BPM</span>
                    </div>
                    <div class="select-container">
                        <label class="select-label">Voice Mode</label>
                        <select id="voiceMode">
                            <option value="poly">Polyphonic</option>
                            <option value="mono">Monophonic</option>
                        </select>
                    </div>
                </div>
                <!-- New control group for octave, semi, and level knobs -->
                <div class="control-group">
                    <div class="knob-container">
                        <label class="knob-label">Octave</label>
                        <div class="knob" id="oscillatorOctaveKnob">
                            <div class="knob-inner"></div>
                            <div class="tooltip">Adjust octave</div>
                        </div>
                        <input type="range" id="oscillatorOctave" min="-2" max="2" step="1" value="0">
                        <span class="knob-value" id="oscillatorOctaveValue">0</span>
                    </div>
                    <div class="knob-container">
                        <label class="knob-label">Semi</label>
                        <div class="knob" id="oscillatorSemiKnob">
                            <div class="knob-inner"></div>
                            <div class="tooltip">Adjust detune in semitones</div>
                        </div>
                        <input type="range" id="oscillatorSemi" min="-12" max="12" step="1" value="0">
                        <span class="knob-value" id="oscillatorSemiValue">0</span>
                    </div>
                    <div class="knob-container">
                        <label class="knob-label">Level</label>
                        <div class="knob" id="oscillatorLevelKnob">
                            <div class="knob-inner"></div>
                            <div class="tooltip">Adjust oscillator volume</div>
                        </div>
                        <input type="range" id="oscillatorLevel" min="0" max="1" step="0.01" value="0.8">
                        <span class="knob-value" id="oscillatorLevelValue">0.80</span>
                    </div>
                </div>
            </div>
            
            <div class="module filter-module">
                <div class="module-header">
                    <h3 class="module-title">
                        <i class="fas fa-filter"></i>
                        Filter
                    </h3>
                </div>
                <div class="control-group">
                    <!-- Added filter type toggle -->
                    <div class="toggle-container">
                        <label class="toggle-label">Filter Type</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="filterTypeToggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="toggle-state" id="filterTypeState">LP</div>
                    </div>
                </div>
                <div class="control-group">
                    <div class="knob-container">
                        <label class="knob-label">Cutoff</label>
                        <div class="knob" id="filterCutoffKnob">
                            <div class="knob-inner"></div>
                            <div class="tooltip">Adjust filter cutoff frequency</div>
                        </div>
                        <input type="range" id="filterCutoff" min="20" max="20000" value="2000">
                        <span class="knob-value" id="filterCutoffValue">2000 Hz</span>
                    </div>
                    <div class="knob-container">
                        <label class="knob-label">Resonance</label>
                        <div class="knob" id="filterResKnob">
                            <div class="knob-inner"></div>
                            <div class="tooltip">Adjust filter resonance</div>
                        </div>
                        <input type="range" id="filterRes" min="0" max="20" value="1">
                        <span class="knob-value" id="filterResValue">1</span>
                    </div>
                </div>
                
                <!-- Add Filter Response Curve -->
                <div class="filter-response">
                    <svg id="filterResponseSvg" width="100%" height="100%">
                        <defs>
                            <linearGradient id="filterGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" stop-color="rgba(0, 229, 255, 0.3)" />
                                <stop offset="100%" stop-color="rgba(0, 229, 255, 0)" />
                            </linearGradient>
                        </defs>
                        <path id="filterCurve" class="filter-curve" d="M0,50 L400,50" />
                        <path id="filterArea" class="filter-area" d="M0,70 L400,70 L400,50 L0,50 Z" fill="url(#filterGradient)" />
                    </svg>
                </div>
            </div>
            
            <div class="module effects-module">
                <div class="module-header">
                    <h3 class="module-title">
                        <i class="fas fa-magic"></i>
                        Effects
                    </h3>
                </div>
                <div style="overflow: auto; max-height: 520px;">
                    <!-- Reverb group with dotted border -->
                    <div class="effect-group">
                        <div class="effect-group-label">
                            <i class="fas fa-mountain"></i>
                            Reverb
                        </div>
                        <div class="control-group">
                            <div class="knob-container">
                                <label class="knob-label">Mix</label>
                                <div class="knob" id="reverbMixKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Adjust reverb mix</div>
                                </div>
                                <input type="range" id="reverbMix" min="0" max="1" step="0.01" value="0.3">
                                <span class="knob-value" id="reverbMixValue">0.30</span>
                            </div>
                            <!-- New reverb decay knob -->
                            <div class="knob-container">
                                <label class="knob-label">Decay</label>
                                <div class="knob" id="reverbDecayKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Adjust reverb decay/tail</div>
                                </div>
                                <input type="range" id="reverbDecay" min="0.1" max="10" step="0.1" value="2">
                                <span class="knob-value" id="reverbDecayValue">2.0s</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Delay group with dotted border -->
                    <div class="effect-group">
                        <div class="effect-group-label">
                            <i class="fas fa-clock"></i>
                            Delay
                        </div>
                        <div class="control-group">
                            <div class="knob-container">
                                <label class="knob-label">Time</label>
                                <div class="knob" id="delayTimeKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Adjust delay time</div>
                                </div>
                                <input type="range" id="delayTime" min="0" max="1" step="0.01" value="0.3">
                                <span class="knob-value" id="delayTimeValue">0.30</span>
                            </div>
                            <div class="knob-container">
                                <label class="knob-label">Feedback</label>
                                <div class="knob" id="delayFeedbackKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Adjust delay feedback</div>
                                </div>
                                <input type="range" id="delayFeedback" min="0" max="0.9" step="0.01" value="0.4">
                                <span class="knob-value" id="delayFeedbackValue">0.40</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New effects sections -->
                    <div class="effect-group">
                        <div class="effect-group-label">
                            <i class="fas fa-wave-square"></i>
                            Modulation
                        </div>
                        <div class="control-group">
                            <div class="knob-container">
                                <label class="knob-label">Chorus</label>
                                <div class="knob" id="chorusMixKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Adjust chorus mix</div>
                                </div>
                                <input type="range" id="chorusMix" min="0" max="1" step="0.01" value="0">
                                <span class="knob-value" id="chorusMixValue">0.00</span>
                            </div>
                            <div class="knob-container">
                                <label class="knob-label">Flanger</label>
                                <div class="knob" id="flangerMixKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Adjust flanger mix</div>
                                </div>
                                <input type="range" id="flangerMix" min="0" max="1" step="0.01" value="0">
                                <span class="knob-value" id="flangerMixValue">0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="effect-group">
                        <div class="effect-group-label">
                            <i class="fas fa-bolt"></i>
                            Character
                        </div>
                        <div class="control-group">
                            <div class="knob-container">
                                <label class="knob-label">Distortion</label>
                                <div class="knob" id="distortionMixKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Adjust distortion amount</div>
                                </div>
                                <input type="range" id="distortionMix" min="0" max="1" step="0.01" value="0">
                                <span class="knob-value" id="distortionMixValue">0.00</span>
                            </div>
                            <div class="knob-container">
                                <label class="knob-label">Phaser</label>
                                <div class="knob" id="phaserMixKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Adjust phaser mix</div>
                                </div>
                                <input type="range" id="phaserMix" min="0" max="1" step="0.01" value="0">
                                <span class="knob-value" id="phaserMixValue">0.00</span>
                            </div>
                        </div>
                    </div>
                </div>                
            </div>
            
            <div class="module adsr-module">
                <div class="module-header">
                    <h3 class="module-title">
                        <i class="fas fa-sliders-h"></i>
                        Envelope (ADSR)
                    </h3>
                </div>
                <div class="control-group">
                    <div class="knob-container">
                        <label class="knob-label">Attack</label>
                        <div class="knob" id="attackKnob">
                            <div class="knob-inner"></div>
                            <div class="tooltip">Adjust attack time</div>
                        </div>
                        <input type="range" id="attack" min="0" max="2" step="0.01" value="0.1">
                        <span class="knob-value" id="attackValue">0.10s</span>
                    </div>
                    <div class="knob-container">
                        <label class="knob-label">Decay</label>
                        <div class="knob" id="decayKnob">
                            <div class="knob-inner"></div>
                            <div class="tooltip">Adjust decay time</div>
                        </div>
                        <input type="range" id="decay" min="0" max="2" step="0.01" value="0.2">
                        <span class="knob-value" id="decayValue">0.20s</span>
                    </div>
                    <div class="knob-container">
                        <label class="knob-label">Sustain</label>
                        <div class="knob" id="sustainKnob">
                            <div class="knob-inner"></div>
                            <div class="tooltip">Adjust sustain level</div>
                        </div>
                        <input type="range" id="sustain" min="0" max="1" step="0.01" value="0.5">
                        <span class="knob-value" id="sustainValue">0.50</span>
                    </div>
                    <div class="knob-container">
                        <label class="knob-label">Release</label>
                        <div class="knob" id="releaseKnob">
                            <div class="knob-inner"></div>
                            <div class="tooltip">Adjust release time</div>
                        </div>
                        <input type="range" id="release" min="0" max="2" step="0.01" value="0.5">
                        <span class="knob-value" id="releaseValue">0.50s</span>
                    </div>
                </div>
                
                <!-- Add ADSR Envelope Visualizer -->
                <div class="adsr-visualizer">
                    <svg id="adsrVisualizerSvg" width="100%" height="100%">
                        <path id="adsrPath" class="adsr-path" d="M0,70 L0,70" />
                    </svg>
                    <div id="adsrMarker" class="adsr-marker" style="display: none;"></div>
                </div>
            </div>
        </div>
        
        <div class="visualization">
            <div class="module oscilloscope-module">
                <div class="module-header">
                    <h3 class="module-title">
                        <i class="fas fa-chart-line"></i>
                        Oscilloscope
                    </h3>
                </div>
                <div class="oscilloscope">
                    <div class="oscilloscope-grid"></div>
                    <canvas id="oscilloscope"></canvas>
                </div>
                <div class="vu-meter">
                    <div class="vu-meter-fill" id="vuMeter"></div>
                </div>
            </div>
            
            <div class="module preset-module">
                <div class="module-header">
                    <h3 class="module-title">
                        <i class="fas fa-bookmark"></i>
                        Presets
                    </h3>
                </div>
                <div class="preset-list" id="presetList">
                    <!-- Presets will be generated by JavaScript -->
                </div>
                <div class="preset-actions">
                    <button id="newPresetBtn">
                        <i class="fas fa-plus"></i>
                        <span>New</span>
                    </button>
                    <button id="deletePresetBtn">
                        <i class="fas fa-trash-alt"></i>
                        <span>Delete</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="module sequencer-container">
            <div class="module-header">
                <h3 class="module-title">
                    <i class="fas fa-step-forward"></i>
                    Sequencer
                </h3>
            </div>
            <div class="sequencer" id="sequencer">
                <!-- Steps will be generated by JavaScript -->
            </div>
            <div class="keyboard" id="keyboard">
                <!-- Keys will be generated by JavaScript -->
            </div>
            
            <!-- Toggle for advanced visualizers -->
            <div class="visualizer-toggle" id="visualizerToggle">
                <i class="fas fa-chevron-down"></i>
                <span>Show Advanced Visualizations</span>
            </div>
            
            <!-- Advanced visualizers (hidden by default) -->
            <div class="advanced-visualizers" id="advancedVisualizers" style="max-height: 0;">
                <div class="spectrum-analyzer">
                    <div class="visualizer-title">Frequency Spectrum</div>
                    <canvas id="spectrumAnalyzer"></canvas>
                </div>
                                
                <div class="particle-system">
                    <div class="visualizer-title">Particle System</div>
                    <canvas id="particleSystem"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for new preset -->
    <div class="modal-overlay" id="presetModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Save New Preset</h3>
            </div>
            <div class="modal-body">
                <label for="presetName">Preset Name</label>
                <input type="text" id="presetName" class="modal-input" placeholder="Enter a name for your preset">
                
                <label for="presetCategory">Category</label>
                <select id="presetCategory" class="modal-select">
                    <option value="bass">Bass</option>
                    <option value="lead">Lead</option>
                    <option value="pad">Pad</option>
                    <option value="fx">FX</option>
                    <option value="pluck">Pluck</option>
                    <option value="keys">Keys</option>
                    <option value="custom" selected>Custom</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="modal-button cancel" id="cancelPresetBtn">Cancel</button>
                <button class="modal-button confirm" id="savePresetBtn">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize audio processing components first
        let filter = new Tone.Filter(2000, "lowpass");
        let reverb = new Tone.Reverb(2);
        let delay = new Tone.FeedbackDelay("8n", 0.5);
        
        // Initialize new effects
        let chorus = new Tone.Chorus(4, 2.5, 0.5).start();
        let distortion = new Tone.Distortion(0.8);
        let flanger = new Tone.FeedbackDelay("8n", 0.5);
        let phaser = new Tone.Phaser({
            frequency: 0.5,
            octaves: 3,
            baseFrequency: 1000
        });
        
        // Initialize wet values to 0 (effects off)
        chorus.wet.value = 0;
        distortion.wet.value = 0;
        flanger.wet.value = 0;
        phaser.wet.value = 0;
        
        const waveform = new Tone.Waveform(1024);
        const fft = new Tone.FFT(1024);

        // Connect effects chain
        filter.connect(chorus);
        chorus.connect(distortion);
        distortion.connect(flanger);
        flanger.connect(phaser);
        phaser.connect(reverb);
        reverb.connect(delay);
        delay.connect(waveform);
        delay.connect(fft);
        delay.toDestination();

        // Initialize synth variables
        let synth;
        let currentMode = "poly";
        
        const activeNotes = new Set();
        const activeComputerKeys = new Set();

        // Keep track of sequencer active keys
        const sequencerActiveKeys = new Map();

        // Create envelope settings to reuse
        const synthSettings = {
            envelope: {
                attack: 0.1,
                decay: 0.2,
                sustain: 0.5,
                release: 0.5
            }
        };
        
        // Helper function to consistently handle mono note changes
        function handleMonoNoteChange(newNote) {
            if (currentMode !== "mono") return;
            
            // Release any currently playing note
            if (activeNotes.size > 0) {
                const oldNote = Array.from(activeNotes)[0];
                
                // Update UI for the old note
                const oldKeyElement = document.querySelector(`.key[data-note="${oldNote}"]`) ||
                                   document.querySelector(`.black-key[data-note="${oldNote}"]`);
                if (oldKeyElement) {
                    oldKeyElement.classList.remove('active');
                }
                
                // Important: Release the previous note sound
                synth.triggerRelease();
            }
            
            // Clear all active notes in mono mode
            activeNotes.clear();
            
            // Add and play the new note
            if (newNote) {
                activeNotes.add(newNote);
                synth.triggerAttack(newNote);
                updateVUMeter(0.8);
            }
        }

        // Function to update the detune value based on octave and semitone settings
        function updateDetune() {
            const octave = parseInt(document.getElementById('oscillatorOctave').value);
            const semi = parseInt(document.getElementById('oscillatorSemi').value);
            const detune = octave * 1200 + semi * 100; // Convert octaves and semitones to cents
            
            if (currentMode === "poly") {
                synth.set({ detune: detune });
            } else {
                synth.detune.value = detune;
            }
        }
        
        // Function to create the appropriate synth type
        function createSynth(mode) {
            // Dispose of old synth if it exists
            if (synth) {
                // Release all notes to prevent hanging notes when switching modes
                if (currentMode === "poly") {
                    synth.releaseAll();
                } else {
                    // For mono synth, trigger release without arguments to release any active note
                    synth.triggerRelease();
                }
                synth.disconnect();
                synth.dispose();
            }
            
            // Clear all active notes when switching synth types
            activeNotes.clear();
            activeComputerKeys.clear();
            
            // Remove active class from all keys
            document.querySelectorAll('.key.active, .black-key.active').forEach(key => {
                key.classList.remove('active');
            });
            
            // Create new synth based on mode
            if (mode === "poly") {
                synth = new Tone.PolySynth(Tone.Synth, synthSettings);
            } else {
                synth = new Tone.Synth(synthSettings);
            }
            
            // Connect to effects chain
            synth.connect(filter);
            
            // Apply current waveform
            const waveformType = document.getElementById('waveform').value;
            if (mode === "poly") {
                synth.set({ oscillator: { type: waveformType } });
            } else {
                synth.oscillator.type = waveformType;
            }
            
            // Apply detune (octave and semitone)
            updateDetune();
            
            // Apply level
            const level = parseFloat(document.getElementById('oscillatorLevel').value);
            if (mode === "poly") {
                synth.set({ volume: Tone.gainToDb(level) });
            } else {
                synth.volume.value = Tone.gainToDb(level);
            }
            
            return synth;
        }
        
        // Create initial synth (polyphonic by default)
        synth = createSynth("poly");
        // Setup oscilloscope
        const canvas = document.getElementById('oscilloscope');
        const ctx = canvas.getContext('2d');
        
        // Define color schemes for oscilloscope
        const colorSchemes = [
            { bg: 'rgba(18, 18, 18, 0.3)', wave: '#00e5ff', name: 'Cyan' },
            { bg: 'rgba(20, 20, 30, 0.3)', wave: '#9d46ff', name: 'Purple' },
            { bg: 'rgba(10, 30, 15, 0.3)', wave: '#00c853', name: 'Green' },
            { bg: 'rgba(30, 15, 10, 0.3)', wave: '#ff6d00', name: 'Orange' },
            { bg: 'rgba(30, 10, 15, 0.3)', wave: '#ff1744', name: 'Red' },
            { bg: 'rgba(25, 25, 10, 0.3)', wave: '#ffab00', name: 'Amber' },
            { bg: 'rgba(10, 25, 25, 0.3)', wave: '#18ffff', name: 'Teal' },
            { bg: 'rgba(30, 10, 30, 0.3)', wave: '#d500f9', name: 'Pink' }
        ];
        
        let currentColorSchemeIndex = 0;

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        function drawOscilloscope() {
            requestAnimationFrame(drawOscilloscope);

            const width = canvas.width;
            const height = canvas.height;
            const values = waveform.getValue();
            const currentScheme = colorSchemes[currentColorSchemeIndex];

            ctx.fillStyle = currentScheme.bg;
            ctx.fillRect(0, 0, width, height);

            ctx.beginPath();
            ctx.strokeStyle = currentScheme.wave;
            ctx.lineWidth = 2;

            for (let i = 0; i < values.length; i++) {
                const x = (i / values.length) * width;
                const y = ((values[i] + 1) / 2) * height;

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }

            ctx.stroke();
        }
        
        // Add click event to change color scheme
        document.querySelector('.oscilloscope').addEventListener('click', () => {
            currentColorSchemeIndex = (currentColorSchemeIndex + 1) % colorSchemes.length;
            
            // Show color scheme name
            const schemeName = colorSchemes[currentColorSchemeIndex].name;
            const notification = document.createElement('div');
            notification.style.position = 'absolute';
            notification.style.top = '50%';
            notification.style.left = '50%';
            notification.style.transform = 'translate(-50%, -50%)';
            notification.style.background = 'rgba(0, 0, 0, 0.7)';
            notification.style.color = colorSchemes[currentColorSchemeIndex].wave;
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '5px';
            notification.style.fontWeight = 'bold';
            notification.style.zIndex = '10';
            notification.textContent = schemeName;

            document.querySelector('.oscilloscope').appendChild(notification);
            
            // Remove notification after a short delay
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => notification.remove(), 500);
            }, 1500);
        });

        drawOscilloscope();

        // Helper function to highlight a key when a note plays in the sequencer
        function highlightKeyFromSequencer(note, duration = 0.25) {
            // Only proceed if it's a valid note
            if (!note) return;

            // Find the corresponding key element
            const keyElement = document.querySelector(`.key[data-note="${note}"]`);
            if (!keyElement) return;

            // Add the active class to highlight the key
            keyElement.classList.add('active');

            // Store the timeout ID so we can clear it if needed
            const timeoutId = setTimeout(() => {
                keyElement.classList.remove('active');
                sequencerActiveKeys.delete(note);
            }, duration * 1000);

            // Store the note and its timeout ID
            sequencerActiveKeys.set(note, timeoutId);
        }

        // Clear any active key highlights
        function clearSequencerKeyHighlights() {
            sequencerActiveKeys.forEach((timeoutId, note) => {
                clearTimeout(timeoutId);
                const keyElement = document.querySelector(`.key[data-note="${note}"]`);
                if (keyElement) {
                    keyElement.classList.remove('active');
                }
            });
            sequencerActiveKeys.clear();
        }

        // Generate notes from C3 to B4
        const generateNotes = () => {
            const notes = [];
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            for (let octave = 1; octave <= 6; octave++) {
                noteNames.forEach(note => {
                    notes.push(`${note}${octave}`);
                });
            }
            return notes;
        };

        // Create sequencer with proper note names
        const createSequencer = () => {
            const sequencerElement = document.getElementById('sequencer');
            const notes = generateNotes();
            
            // Clear existing steps
            sequencerElement.innerHTML = '';
            
            for (let i = 0; i < 16; i++) {
                const step = document.createElement('div');
                step.className = 'step';
                step.setAttribute('data-step', i + 1);
                
                const led = document.createElement('div');
                led.className = 'step-led';
                step.appendChild(led);
                
                const select = document.createElement('select');
                // Add a data attribute to help with identifying
                select.setAttribute('data-step-select', i);
                
                notes.forEach(note => {
                    const option = document.createElement('option');
                    option.value = note;
                    option.textContent = note;
                    select.appendChild(option);
                });
                
                // Set default notes in an interesting pattern
                const noteIndex = i % notes.length;
                select.value = notes[noteIndex];
                
                step.appendChild(select);
                
                const toggle = document.createElement('button');
                toggle.type = 'button';
                toggle.className = 'step-toggle active';
                toggle.textContent = 'On';
                toggle.onclick = () => {
                    toggle.classList.toggle('active');
                    toggle.textContent = toggle.classList.contains('active') ? 'On' : 'Off';
                };
                step.appendChild(toggle);
                
                sequencerElement.appendChild(step);
            }
        };

        // Create keyboard with polyphonic support
        const createKeyboard = () => {
            const keyboardElement = document.getElementById('keyboard');
            const notes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];

            // Make octave range responsive based on screen size
            const isMobile = window.innerWidth <= 768;
            const startOctave = 3;
            const endOctave = isMobile ? 4 : 7;
            
            // Clear keyboard
            keyboardElement.innerHTML = '';
            
            // Create white keys for each octave
            for (let octave = startOctave; octave <= endOctave; octave++) {
                // Only create C for the last octave
                const octaveNotes = octave === endOctave ? ['C'] : notes;
                
                for (let i = 0; i < octaveNotes.length; i++) {
                    const key = document.createElement('div');
                    key.className = 'key';
                    key.textContent = isMobile ? '' : `${octaveNotes[i]}${octave}`;
                    key.setAttribute('data-note', `${octaveNotes[i]}${octave}`);
                    keyboardElement.appendChild(key);
                    
                    // Add click event with support for both modes
                    key.addEventListener('mousedown', () => {
                        const note = `${octaveNotes[i]}${octave}`;
                        key.classList.add('active');
                        
                        if (currentMode === "poly") {
                            // For polyphonic mode, only trigger if not already playing
                            if (!activeNotes.has(note)) {
                                activeNotes.add(note);
                                synth.triggerAttack(note);
                                updateVUMeter(0.8);
                            }
                        } else {
                            // Use our helper function for mono mode
                            handleMonoNoteChange(note);
                        }
                    });
                    
                    key.addEventListener('mouseup', () => {
                        const note = `${octaveNotes[i]}${octave}`;
                        key.classList.remove('active');
                        
                        if (currentMode === "poly") {
                            if (activeNotes.has(note)) {
                                activeNotes.delete(note);
                                synth.triggerRelease(note);
                            }
                        } else {
                            // For mono mode, clean up active note and release
                            if (activeNotes.has(note)) {
                                activeNotes.delete(note);
                                synth.triggerRelease(); // No parameter needed for mono synth
                            }
                        }
                    });
                    
                    key.addEventListener('mouseleave', () => {
                        const note = `${octaveNotes[i]}${octave}`;
                        if (key.classList.contains('active')) {
                            key.classList.remove('active');
                            
                            if (currentMode === "poly") {
                                if (activeNotes.has(note)) {
                                    activeNotes.delete(note);
                                    synth.triggerRelease(note);
                                }
                            } else {
                                // For mono mode
                                if (activeNotes.has(note)) {
                                    activeNotes.delete(note);
                                    synth.triggerRelease(); // No parameter needed for mono synth
                                }
                            }
                        }
                    });
                }
                
                // Create black keys for this octave
                // Skip black keys after B
                if (octave < endOctave || (octave === endOctave && octaveNotes.length > 1)) {
                    const blackKeyPositions = [
                        { after: 'C', note: 'C#' },
                        { after: 'D', note: 'D#' },
                        { after: 'F', note: 'F#' },
                        { after: 'G', note: 'G#' },
                        { after: 'A', note: 'A#' }
                    ];
                    
                    for (let i = 0; i < octaveNotes.length; i++) {
                        const whiteNote = octaveNotes[i];
                        const blackKeyInfo = blackKeyPositions.find(pos => pos.after === whiteNote);
                        
                        if (blackKeyInfo) {
                            const blackKey = document.createElement('div');
                            blackKey.className = 'black-key';
                            blackKey.textContent = '';
                            blackKey.setAttribute('data-note', `${blackKeyInfo.note}${octave}`);
                            
                            // Position the black key
                            const whiteKeyWidth = document.querySelector('.key').offsetWidth;
                            const whiteKeyIndex = Array.from(keyboardElement.querySelectorAll('.key')).findIndex(
                                key => key.getAttribute('data-note') === `${whiteNote}${octave}`
                            );
                            
                            if (whiteKeyIndex !== -1) {
                                const whiteKeyRect = keyboardElement.querySelectorAll('.key')[whiteKeyIndex].getBoundingClientRect();
                                const keyboardRect = keyboardElement.getBoundingClientRect();
                                
                                blackKey.style.left = `${whiteKeyRect.right - keyboardRect.left - whiteKeyWidth/4}px`;
                                keyboardElement.appendChild(blackKey);
                                
                                // Add click event with polyphony support
                                blackKey.addEventListener('mousedown', () => {
                                    const note = `${blackKeyInfo.note}${octave}`;
                                    blackKey.classList.add('active');
                                    
                                    if (currentMode === "poly") {
                                        if (!activeNotes.has(note)) {
                                            activeNotes.add(note);
                                            synth.triggerAttack(note);
                                            updateVUMeter(0.8);
                                        }
                                    } else {
                                        // Use our helper function for mono mode
                                        handleMonoNoteChange(note);
                                    }
                                });
                                
                                blackKey.addEventListener('mouseup', () => {
                                    const note = `${blackKeyInfo.note}${octave}`;
                                    blackKey.classList.remove('active');
                                    
                                    if (currentMode === "poly") {
                                        if (activeNotes.has(note)) {
                                            activeNotes.delete(note);
                                            synth.triggerRelease(note);
                                        }
                                    } else {
                                        // For mono mode
                                        if (activeNotes.has(note)) {
                                            activeNotes.delete(note);
                                            synth.triggerRelease(); // No parameter needed for mono synth
                                        }
                                    }
                                });
                                
                                blackKey.addEventListener('mouseleave', () => {
                                    const note = `${blackKeyInfo.note}${octave}`;
                                    if (blackKey.classList.contains('active')) {
                                        blackKey.classList.remove('active');
                                        
                                        if (currentMode === "poly") {
                                            if (activeNotes.has(note)) {
                                                activeNotes.delete(note);
                                                synth.triggerRelease(note);
                                            }
                                        } else {
                                            // For mono mode
                                            if (activeNotes.has(note)) {
                                                activeNotes.delete(note);
                                                synth.triggerRelease(); // No parameter needed for mono synth
                                            }
                                        }
                                    }
                                });
                            }
                        }
                    }
                }
            }
        };

        // Update sequencer visuals
        const updateSequencer = (currentStep) => {
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, i) => {
                step.classList.toggle('active', i === currentStep);
            });
        };

        // VU meter animation
        const updateVUMeter = (value) => {
            const vuMeter = document.getElementById('vuMeter');
            gsap.to(vuMeter, {
                width: `${value * 100}%`,
                duration: 0.1,
                onComplete: () => {
                    gsap.to(vuMeter, {
                        width: '0%',
                        duration: 0.3,
                        ease: "power2.out"
                    });
                }
            });
        };

        // Knob control functionality
        const setupKnob = (knobId, inputId) => {
            const knob = document.getElementById(knobId);
            const input = document.getElementById(inputId);
            let isDragging = false;
            let startY;
            let startValue;

            const updateKnobRotation = (value) => {
                const min = parseFloat(input.min);
                const max = parseFloat(input.max);
                const rotation = ((value - min) / (max - min)) * 270 - 135;
                gsap.to(knob, {
                    rotation: rotation,
                    duration: 0.1
                });
            };

            knob.addEventListener('mousedown', (e) => {
                isDragging = true;
                startY = e.clientY;
                startValue = parseFloat(input.value);
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                e.preventDefault(); // Prevent text selection
            });

            const handleMouseMove = (e) => {
                if (!isDragging) return;
                
                const deltaY = startY - e.clientY;
                const range = parseFloat(input.max) - parseFloat(input.min);
                const valueChange = (deltaY / 100) * range;
                
                let newValue = startValue + valueChange;
                newValue = Math.max(parseFloat(input.min), Math.min(parseFloat(input.max), newValue));
                
                input.value = newValue;
                updateKnobRotation(newValue);
                input.dispatchEvent(new Event('input'));
            };

            const handleMouseUp = () => {
                isDragging = false;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            };

            // Touch support
            knob.addEventListener('touchstart', (e) => {
                isDragging = true;
                startY = e.touches[0].clientY;
                startValue = parseFloat(input.value);
                document.addEventListener('touchmove', handleTouchMove);
                document.addEventListener('touchend', handleTouchEnd);
                e.preventDefault(); // Prevent scrolling
            });

            const handleTouchMove = (e) => {
                if (!isDragging) return;
                
                const deltaY = startY - e.touches[0].clientY;
                const range = parseFloat(input.max) - parseFloat(input.min);
                const valueChange = (deltaY / 100) * range;
                
                let newValue = startValue + valueChange;
                newValue = Math.max(parseFloat(input.min), Math.min(parseFloat(input.max), newValue));
                
                input.value = newValue;
                updateKnobRotation(newValue);
                input.dispatchEvent(new Event('input'));
                e.preventDefault(); // Prevent scrolling
            };

            const handleTouchEnd = () => {
                isDragging = false;
                document.removeEventListener('touchmove', handleTouchMove);
                document.removeEventListener('touchend', handleTouchEnd);
            };

            // Initialize knob rotation
            updateKnobRotation(input.value);

            // Add input event listener to update knob when value changes
            input.addEventListener('input', () => {
                updateKnobRotation(input.value);
            });

            return updateKnobRotation;
        };

        // Setup all knobs and store their update functions
        const knobUpdaters = {};
        const knobs = [
            ['filterCutoffKnob', 'filterCutoff'],
            ['filterResKnob', 'filterRes'],
            ['attackKnob', 'attack'],
            ['decayKnob', 'decay'],
            ['sustainKnob', 'sustain'],
            ['releaseKnob', 'release'],
            ['reverbMixKnob', 'reverbMix'],
            ['reverbDecayKnob', 'reverbDecay'],
            ['delayTimeKnob', 'delayTime'],
            ['delayFeedbackKnob', 'delayFeedback'],
            ['tempoKnob', 'tempo'],
            ['oscillatorOctaveKnob', 'oscillatorOctave'],
            ['oscillatorSemiKnob', 'oscillatorSemi'],
            ['oscillatorLevelKnob', 'oscillatorLevel'],
            ['chorusMixKnob', 'chorusMix'],
            ['distortionMixKnob', 'distortionMix'],
            ['flangerMixKnob', 'flangerMix'],
            ['phaserMixKnob', 'phaserMix']
        ];

        knobs.forEach(([knobId, inputId]) => {
            knobUpdaters[inputId] = setupKnob(knobId, inputId);
        });

        // ADSR Envelope Visualizer
        function updateADSRVisualizer() {
            const svg = document.getElementById('adsrVisualizerSvg');
            const width = svg.clientWidth;
            const height = svg.clientHeight;
            
            const attack = parseFloat(document.getElementById('attack').value);
            const decay = parseFloat(document.getElementById('decay').value);
            const sustain = parseFloat(document.getElementById('sustain').value);
            const release = parseFloat(document.getElementById('release').value);
            
            // Calculate widths for each segment
            const totalTime = attack + decay + 1 + release; // Add 1 for sustain display
            const attackWidth = (attack / totalTime) * width;
            const decayWidth = (decay / totalTime) * width;
            const sustainWidth = (1 / totalTime) * width;
            const releaseWidth = (release / totalTime) * width;
            
            // Calculate y positions (inverted, as 0,0 is top-left)
            const startY = height - 10; // Start near bottom
            const peakY = 10; // Attack peak near top
            const sustainY = height - 10 - (sustain * (height - 20)); // Sustain level
            
            // Create path
            const path = [
                `M0,${startY}`, // Start
                `L${attackWidth},${peakY}`, // Attack
                `L${attackWidth + decayWidth},${sustainY}`, // Decay
                `L${attackWidth + decayWidth + sustainWidth},${sustainY}`, // Sustain
                `L${attackWidth + decayWidth + sustainWidth + releaseWidth},${startY}` // Release
            ].join(' ');
            
            document.getElementById('adsrPath').setAttribute('d', path);
        }

        // Filter Response Curve
        function updateFilterResponse() {
            const svg = document.getElementById('filterResponseSvg');
            const width = svg.clientWidth;
            const height = svg.clientHeight;
            
            const filterType = document.getElementById('filterTypeToggle').checked ? "highpass" : "lowpass";
            const cutoff = parseFloat(document.getElementById('filterCutoff').value);
            const resonance = parseFloat(document.getElementById('filterRes').value);
            
            // Calculate log scale for x-axis (frequency)
            const frequencyToX = (freq) => {
                const minLog = Math.log10(20);
                const maxLog = Math.log10(20000);
                const logPos = (Math.log10(freq) - minLog) / (maxLog - minLog);
                return logPos * width;
            };
            
            // Generate points for the filter curve
            const points = [];
            for (let freq = 20; freq <= 20000; freq = freq * 1.1) {
                const x = frequencyToX(freq);
                
                // Calculate filter response at this frequency
                let response = 0;
                if (filterType === "lowpass") {
                    if (freq < cutoff) {
                        response = 1;
                    } else {
                        // Simple rolloff model with resonance peak
                        const ratio = cutoff / freq;
                        response = ratio;
                        if (Math.abs(freq - cutoff) < cutoff * 0.2) {
                            response += (resonance / 10) * (1 - Math.abs((freq - cutoff) / (cutoff * 0.2)));
                        }
                    }
                } else { // highpass
                    if (freq > cutoff) {
                        response = 1;
                    } else {
                        // Simple rolloff model with resonance peak
                        const ratio = freq / cutoff;
                        response = ratio;
                        if (Math.abs(freq - cutoff) < cutoff * 0.2) {
                            response += (resonance / 10) * (1 - Math.abs((freq - cutoff) / (cutoff * 0.2)));
                        }
                    }
                }
                
                // Clamp response between 0 and 1.5 (for resonance peaks)
                response = Math.max(0, Math.min(1.5, response));
                
                // Convert to y coordinate (inverted, as 0,0 is top-left)
                const y = height - (response * (height * 0.8));
                points.push(`${x},${y}`);
            }
            
            // Create the filter curve path
            const path = `M0,${height} L${points.join(' L')} L${width},${height}`;
            document.getElementById('filterCurve').setAttribute('d', `M${points.join(' L')}`);
            
            // Create the filled area for the filter curve
            document.getElementById('filterArea').setAttribute('d', `M0,${height} L${points.join(' L')} L${width},${height} Z`);
        }

        // Spectrum Analyzer
        function setupSpectrumAnalyzer() {
            const canvas = document.getElementById('spectrumAnalyzer');
            const ctx = canvas.getContext('2d');
            
            function resizeSpectrumCanvas() {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            }
            
            resizeSpectrumCanvas();
            window.addEventListener('resize', resizeSpectrumCanvas);
            
            function drawSpectrumAnalyzer() {
                requestAnimationFrame(drawSpectrumAnalyzer);
                
                if (!canvas.width || !fft) return; // Skip if canvas not visible or fft not available
                
                const width = canvas.width;
                const height = canvas.height;
                const spectrumValues = fft.getValue();
                
                // Clear canvas
                ctx.clearRect(0, 0, width, height);
                ctx.fillStyle = 'rgba(18, 18, 18, 0.2)';
                ctx.fillRect(0, 0, width, height);
                        
                // Draw frequency bins
                const binWidth = width / (spectrumValues.length / 2);
                
                // Create gradient for bars
                const gradient = ctx.createLinearGradient(0, height, 0, 0);
                gradient.addColorStop(0, 'rgba(98, 0, 234, 0.8)');
                gradient.addColorStop(0.5, 'rgba(0, 229, 255, 0.8)');
                gradient.addColorStop(1, 'rgba(255, 23, 68, 0.8)');
                
                ctx.fillStyle = gradient;
                
                // Draw only the first half of FFT data (up to Nyquist frequency)
                for (let i = 0; i < spectrumValues.length / 2; i++) {
                    // Convert dB value to height
                    // FFT values are typically in dB scale (-100 to 0)
                    const value = spectrumValues[i];
                    const dbValue = 20 * Math.log10(Math.abs(value) + 0.00001); // Avoid log(0)
                    const normalizedValue = (dbValue + 100) / 100; // Normalize -100dB..0dB to 0..1
                    
                    const barHeight = normalizedValue * height;
                    
                    // Draw bar
                    ctx.fillRect(i * binWidth, height - barHeight, binWidth * 0.8, barHeight);
                }
                
                // Add frequency markers
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.font = '10px sans-serif';
                
                const freqMarkers = [100, 1000, 10000];
                freqMarkers.forEach(freq => {
                    // Convert frequency to bin index
                    const binIndex = Math.floor((freq / (Tone.context.sampleRate / 2)) * (spectrumValues.length / 2));
                    const x = binIndex * binWidth;
                    
                    // Draw marker line
                    ctx.fillRect(x, 0, 1, height);
                    
                    // Draw label
                    let label;
                    if (freq >= 1000) {
                        label = `${freq/1000}kHz`;
                    } else {
                        label = `${freq}Hz`;
                    }
                    ctx.fillText(label, x + 3, 12);
                });
            }
            
            drawSpectrumAnalyzer();
        }

        // Particle System
        function setupParticleSystem() {
            const canvas = document.getElementById('particleSystem');
            const ctx = canvas.getContext('2d');
            
            function resizeParticleCanvas() {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            }
            
            resizeParticleCanvas();
            window.addEventListener('resize', resizeParticleCanvas);
            
            // Create particles
            const particles = [];
            const particleCount = 100;
            
            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 4 + 1,
                    speedX: Math.random() * 2 - 1,
                    speedY: Math.random() * 2 - 1,
                    hue: Math.random() * 60 + 200, // Blue to purple range
                    opacity: Math.random() * 0.5 + 0.2
                });
            }
            
            function updateParticles() {
                requestAnimationFrame(updateParticles);
                
                if (!canvas.width) return; // Skip if canvas not visible
                
                // Get audio data for reactivity
                const waveformData = waveform.getValue();
                const fftData = fft.getValue();
                
                // Calculate overall amplitude
                let sum = 0;
                for (let i = 0; i < waveformData.length; i++) {
                    sum += Math.abs(waveformData[i]);
                }
                const averageAmplitude = sum / waveformData.length;
                
                // Get bass and treble energy
                const bassEnergy = Math.abs(fftData[5]) + Math.abs(fftData[10]) + Math.abs(fftData[15]);
                const trebleEnergy = Math.abs(fftData[100]) + Math.abs(fftData[150]) + Math.abs(fftData[200]);
                
                // Clear canvas with fade effect
                ctx.fillStyle = 'rgba(18, 18, 18, 0.1)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Update and draw particles
                particles.forEach(p => {
                    // Apply audio reactivity
                    p.size = p.size * 0.95 + (p.size * averageAmplitude * 5) * 0.05;
                    p.speedX += (Math.random() * 2 - 1) * bassEnergy * 0.02;
                    p.speedY += (Math.random() * 2 - 1) * trebleEnergy * 0.02;
                    
                    // Update position
                    p.x += p.speedX;
                    p.y += p.speedY;
                    
                    // Apply damping
                    p.speedX *= 0.99;
                    p.speedY *= 0.99;
                    
                    // Wrap around edges
                    if (p.x < 0) p.x = canvas.width;
                    if (p.x > canvas.width) p.x = 0;
                    if (p.y < 0) p.y = canvas.height;
                    if (p.y > canvas.height) p.y = 0;
                    
                    // Draw particle
                    ctx.globalAlpha = p.opacity;
                    ctx.fillStyle = `hsla(${p.hue}, 100%, 60%, ${p.opacity})`;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw connections between nearby particles
                    particles.forEach(p2 => {
                        const dx = p.x - p2.x;
                        const dy = p.y - p2.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 50) {
                            ctx.globalAlpha = (1 - distance / 50) * 0.2;
                            ctx.strokeStyle = `hsla(${(p.hue + p2.hue) / 2}, 100%, 60%, ${ctx.globalAlpha})`;
                            ctx.lineWidth = 1;
                            ctx.beginPath();
                            ctx.moveTo(p.x, p.y);
                            ctx.lineTo(p2.x, p2.y);
                            ctx.stroke();
                        }
                    });
                });
                
                ctx.globalAlpha = 1; // Reset alpha
            }
            
            updateParticles();
        }

        createSequencer();
        
        // Create keyboard after DOM is fully loaded
        window.addEventListener('DOMContentLoaded', () => {
            createKeyboard();
            // Initialize presets
            initializePresets();
            
            // Initialize ADSR Visualizer
            updateADSRVisualizer();
            
            // Initialize Filter Response Curve
            updateFilterResponse();
            
            // Set up visualizers toggle
            document.getElementById('visualizerToggle').addEventListener('click', function() {
                const advancedVisualizers = document.getElementById('advancedVisualizers');
                const isExpanded = this.classList.toggle('active');
                
                if (isExpanded) {
                    // Show visualizers
                    advancedVisualizers.style.maxHeight = '500px';
                    this.querySelector('span').textContent = 'Hide Advanced Visualizations';
                    
                    // Short delay to ensure the container is visible before initializing
                    setTimeout(() => {
                        // Initialize visualizers when shown
                        setupSpectrumAnalyzer();
                        setupParticleSystem();
                    }, 100);
                } else {
                    // Hide visualizers
                    advancedVisualizers.style.maxHeight = '0';
                    this.querySelector('span').textContent = 'Show Advanced Visualizations';
                }
            });
        });
        
        // Recalculate keyboard positions on window resize
        window.addEventListener('resize', () => {
            // Small delay to ensure DOM has updated
            setTimeout(createKeyboard, 100);
        });

        let isPlaying = false;
        let currentStep = 0;

        // Connect UI controls to synth parameters
        document.getElementById('waveform').addEventListener('change', e => {
            if (currentMode === "poly") {
                synth.set({ oscillator: { type: e.target.value } });
            } else {
                synth.oscillator.type = e.target.value;
            }
        });

        // Filter type toggle
        document.getElementById('filterTypeToggle').addEventListener('change', e => {
            const filterType = e.target.checked ? "highpass" : "lowpass";
            filter.type = filterType;
            document.getElementById('filterTypeState').textContent = e.target.checked ? "HP" : "LP";
            updateFilterResponse();
        });

        document.getElementById('filterCutoff').addEventListener('input', e => {
            filter.frequency.value = e.target.value;
            document.getElementById('filterCutoffValue').textContent = `${Math.round(e.target.value)} Hz`;
            updateFilterResponse();
        });

        document.getElementById('filterRes').addEventListener('input', e => {
            filter.Q.value = e.target.value;
            document.getElementById('filterResValue').textContent = parseFloat(e.target.value).toFixed(1);
            updateFilterResponse();
        });

        document.getElementById('reverbMix').addEventListener('input', e => {
            reverb.wet.value = e.target.value;
            document.getElementById('reverbMixValue').textContent = parseFloat(e.target.value).toFixed(2);
        });
        
        // New reverb decay control
        document.getElementById('reverbDecay').addEventListener('input', e => {
            const value = parseFloat(e.target.value);
            
            // Update the display immediately for better UX
            document.getElementById('reverbDecayValue').textContent = `${value.toFixed(1)}s`;
            
            // We'll use a debounce approach to avoid recreating the reverb on every tiny change
            // Clear any pending reverb update
            if (window.reverbUpdateTimeout) {
                clearTimeout(window.reverbUpdateTimeout);
            }
            
            // Set a new timeout to update the reverb after a short delay
            window.reverbUpdateTimeout = setTimeout(() => {
                // Store the current wet value
                const currentWet = reverb.wet.value;
                
                // Create a new reverb with the new decay value
                const newReverb = new Tone.Reverb({
                    decay: value,
                    preDelay: 0.01
                });
                
                // Generate the impulse response before swapping
                newReverb.generate().then(() => {
                    // Set the wet value to match the previous reverb
                    newReverb.wet.value = currentWet;
                    
                    // Temporarily disconnect reverb from the chain
                    phaser.disconnect(reverb);
                    reverb.disconnect(delay);
                    
                    // Connect the new reverb
                    phaser.connect(newReverb);
                    newReverb.connect(delay);
                    
                    // Dispose the old reverb
                    reverb.dispose();
                    
                    // Replace the reverb reference
                    reverb = newReverb;
                });
            }, 300); // 300ms debounce
        });

        document.getElementById('delayTime').addEventListener('input', e => {
            delay.delayTime.value = e.target.value;
            document.getElementById('delayTimeValue').textContent = parseFloat(e.target.value).toFixed(2);
        });

        document.getElementById('delayFeedback').addEventListener('input', e => {
            delay.feedback.value = e.target.value;
            document.getElementById('delayFeedbackValue').textContent = parseFloat(e.target.value).toFixed(2);
        });
        
        // New effect controls
        document.getElementById('chorusMix').addEventListener('input', e => {
            chorus.wet.value = e.target.value;
            document.getElementById('chorusMixValue').textContent = parseFloat(e.target.value).toFixed(2);
        });
        
        document.getElementById('distortionMix').addEventListener('input', e => {
            distortion.wet.value = e.target.value;
            document.getElementById('distortionMixValue').textContent = parseFloat(e.target.value).toFixed(2);
        });
        
        document.getElementById('flangerMix').addEventListener('input', e => {
            flanger.wet.value = e.target.value;
            document.getElementById('flangerMixValue').textContent = parseFloat(e.target.value).toFixed(2);
        });
        
        document.getElementById('phaserMix').addEventListener('input', e => {
            phaser.wet.value = e.target.value;
            document.getElementById('phaserMixValue').textContent = parseFloat(e.target.value).toFixed(2);
        });

        // New oscillator control event listeners
        document.getElementById('oscillatorOctave').addEventListener('input', e => {
            const value = parseInt(e.target.value);
            document.getElementById('oscillatorOctaveValue').textContent = value;
            updateDetune();
        });

        document.getElementById('oscillatorSemi').addEventListener('input', e => {
            const value = parseInt(e.target.value);
            document.getElementById('oscillatorSemiValue').textContent = value;
            updateDetune();
        });

        document.getElementById('oscillatorLevel').addEventListener('input', e => {
            const value = parseFloat(e.target.value);
            if (currentMode === "poly") {
                synth.set({ volume: Tone.gainToDb(value) });
            } else {
                synth.volume.value = Tone.gainToDb(value);
            }
            document.getElementById('oscillatorLevelValue').textContent = value.toFixed(2);
        });

        // ADSR controls
        document.getElementById('attack').addEventListener('input', e => {
            const value = parseFloat(e.target.value);
            if (currentMode === "poly") {
                synth.set({ envelope: { attack: value } });
            } else {
                synth.envelope.attack = value;
            }
            // Update common settings for recreating synths
            synthSettings.envelope.attack = value;
            document.getElementById('attackValue').textContent = `${value.toFixed(2)}s`;
            updateADSRVisualizer();
        });

        document.getElementById('decay').addEventListener('input', e => {
            const value = parseFloat(e.target.value);
            if (currentMode === "poly") {
                synth.set({ envelope: { decay: value } });
            } else {
                synth.envelope.decay = value;
            }
            // Update common settings for recreating synths
            synthSettings.envelope.decay = value;
            document.getElementById('decayValue').textContent = `${value.toFixed(2)}s`;
            updateADSRVisualizer();
        });

        document.getElementById('sustain').addEventListener('input', e => {
            const value = parseFloat(e.target.value);
            if (currentMode === "poly") {
                synth.set({ envelope: { sustain: value } });
            } else {
                synth.envelope.sustain = value;
            }
            // Update common settings for recreating synths
            synthSettings.envelope.sustain = value;
            document.getElementById('sustainValue').textContent = value.toFixed(2);
            updateADSRVisualizer();
        });

        document.getElementById('release').addEventListener('input', e => {
            const value = parseFloat(e.target.value);
            if (currentMode === "poly") {
                synth.set({ envelope: { release: value } });
            } else {
                synth.envelope.release = value;
            }
            // Update common settings for recreating synths
            synthSettings.envelope.release = value;
            document.getElementById('releaseValue').textContent = `${value.toFixed(2)}s`;
            updateADSRVisualizer();
        });

        document.getElementById('startSequencer').addEventListener('click', async function() {
            if (!isPlaying) {
                await Tone.start();
                Tone.Transport.start();
                isPlaying = true;
                this.innerHTML = '<i class="fas fa-stop"></i><span>Stop</span>';
                this.classList.add('playing');
            } else {
                Tone.Transport.stop();
                isPlaying = false;
                this.innerHTML = '<i class="fas fa-play"></i><span>Start</span>';
                this.classList.remove('playing');
                // Clear any active key highlights when stopping
                clearSequencerKeyHighlights();
            }
        });

        // The init patch with basic settings
        const initPatch = {
            voiceMode: "poly",
            waveform: "sine",
            filterCutoff: "8000",
            filterRes: "1",
            filterType: false,
            reverbMix: "0.1",
            reverbDecay: "1.5",
            delayTime: "0.1",
            delayFeedback: "0.1",
            tempo: "120",
            attack: "0.01",
            decay: "0.1",
            sustain: "0.5",
            release: "0.5",
            oscillatorOctave: "0",
            oscillatorSemi: "0",
            oscillatorLevel: "0.8",
            chorusMix: "0",
            distortionMix: "0",
            flangerMix: "0",
            phaserMix: "0",
            sequencer: [
                {"note": "C4", "active": true},
                {"note": "C4", "active": false},
                {"note": "C4", "active": true},
                {"note": "C4", "active": false},
                {"note": "C4", "active": true},
                {"note": "C4", "active": false},
                {"note": "C4", "active": true},
                {"note": "C4", "active": false},
                {"note": "C4", "active": true},
                {"note": "C4", "active": false},
                {"note": "C4", "active": true},
                {"note": "C4", "active": false},
                {"note": "C4", "active": true},
                {"note": "C4", "active": false},
                {"note": "C4", "active": true},
                {"note": "C4", "active": false}
            ]
        };

        // Init Patch button
        document.getElementById('initPatchButton').addEventListener('click', function() {
            applyPreset(initPatch);
            
            // Visual feedback
            this.classList.add('success');
            setTimeout(() => {
                this.classList.remove('success');
            }, 1000);
        });

        // Preset management functionality
        const builtInPresets = [
            {
                name: "Default",
                category: "pad", // Using 'pad' category like the other ambient presets
                settings: {
                    voiceMode: "poly",
                    waveform: "triangle",
                    filterCutoff: "900",
                    filterRes: "5",
                    filterType: false,
                    reverbMix: "0.6",
                    reverbDecay: "3.5", // Adding this since it's in our new synthesizer
                    delayTime: "0.33",
                    delayFeedback: "0.55",
                    tempo: "96",
                    attack: "0.02",
                    decay: "0.18",
                    sustain: "0.35",
                    release: "1.4",
                    oscillatorOctave: "0", // Adding new synth parameters
                    oscillatorSemi: "0",
                    oscillatorLevel: "0.8",
                    chorusMix: "0.1",
                    distortionMix: "0",
                    flangerMix: "0",
                    phaserMix: "0",
                    sequencer: [
                        {"note": "E3", "active": true},
                        {"note": "B3", "active": true},
                        {"note": "G3", "active": true},
                        {"note": "B3", "active": false},
                        {"note": "A3", "active": true},
                        {"note": "E4", "active": true},
                        {"note": "B3", "active": true},
                        {"note": "C4", "active": false},
                        {"note": "G3", "active": true},
                        {"note": "D4", "active": true},
                        {"note": "B3", "active": true},
                        {"note": "D4", "active": false},
                        {"note": "F#3", "active": true},
                        {"note": "A3", "active": true},
                        {"note": "E3", "active": true},
                        {"note": "B3", "active": true}
                    ]
                }
            },            
            {
                name: "Default Ambient",
                category: "pad",
                settings: {
                    voiceMode: "poly",
                    waveform: "triangle",
                    filterCutoff: "900",
                    filterRes: "5",
                    filterType: false,
                    reverbMix: "0.6",
                    reverbDecay: "3.5",
                    delayTime: "0.33",
                    delayFeedback: "0.55",
                    tempo: "96",
                    attack: "0.02",
                    decay: "0.18",
                    sustain: "0.35",
                    release: "1.4",
                    oscillatorOctave: "0",
                    oscillatorSemi: "0",
                    oscillatorLevel: "0.8",
                    chorusMix: "0.1",
                    distortionMix: "0",
                    flangerMix: "0",
                    phaserMix: "0",
                    sequencer: [
                        {"note": "E3", "active": true},
                        {"note": "B3", "active": true},
                        {"note": "G3", "active": true},
                        {"note": "B3", "active": false},
                        {"note": "A3", "active": true},
                        {"note": "E4", "active": true},
                        {"note": "B3", "active": true},
                        {"note": "C4", "active": false},
                        {"note": "G3", "active": true},
                        {"note": "D4", "active": true},
                        {"note": "B3", "active": true},
                        {"note": "D4", "active": false},
                        {"note": "F#3", "active": true},
                        {"note": "A3", "active": true},
                        {"note": "E3", "active": true},
                        {"note": "B3", "active": true}
                    ]
                }
            },
            {
                name: "Deep Bass",
                category: "bass",
                settings: {
                    voiceMode: "mono",
                    waveform: "fatsawtooth",
                    filterCutoff: "500",
                    filterRes: "8",
                    filterType: false,
                    reverbMix: "0.05",
                    reverbDecay: "1.2",
                    delayTime: "0.25",
                    delayFeedback: "0.2",
                    tempo: "120",
                    attack: "0.01",
                    decay: "0.2",
                    sustain: "0.8",
                    release: "0.4",
                    oscillatorOctave: "-1",
                    oscillatorSemi: "0",
                    oscillatorLevel: "0.9",
                    chorusMix: "0",
                    distortionMix: "0.3",
                    flangerMix: "0",
                    phaserMix: "0",
                    sequencer: [
                        {"note": "C2", "active": true},
                        {"note": "G2", "active": false},
                        {"note": "C2", "active": true},
                        {"note": "G2", "active": false},
                        {"note": "A#1", "active": true},
                        {"note": "F2", "active": false},
                        {"note": "A#1", "active": true},
                        {"note": "F2", "active": false},
                        {"note": "G#1", "active": true},
                        {"note": "D#2", "active": false},
                        {"note": "G#1", "active": true},
                        {"note": "D#2", "active": false},
                        {"note": "G1", "active": true},
                        {"note": "D2", "active": false},
                        {"note": "G1", "active": true},
                        {"note": "D2", "active": false}
                    ]
                }
            },
            {
                name: "Plucky Lead",
                category: "lead",
                settings: {
                    voiceMode: "poly",
                    waveform: "square",
                    filterCutoff: "3000",
                    filterRes: "6",
                    filterType: false,
                    reverbMix: "0.2",
                    reverbDecay: "1.5",
                    delayTime: "0.375",
                    delayFeedback: "0.4",
                    tempo: "130",
                    attack: "0.005",
                    decay: "0.1",
                    sustain: "0.2",
                    release: "0.3",
                    oscillatorOctave: "1",
                    oscillatorSemi: "0",
                    oscillatorLevel: "0.75",
                    chorusMix: "0.1",
                    distortionMix: "0.05",
                    flangerMix: "0",
                    phaserMix: "0",
                    sequencer: [
                        {"note": "E4", "active": true},
                        {"note": "G4", "active": true},
                        {"note": "B4", "active": true},
                        {"note": "D5", "active": true},
                        {"note": "E4", "active": false},
                        {"note": "G4", "active": false},
                        {"note": "B4", "active": true},
                        {"note": "D5", "active": true},
                        {"note": "E4", "active": true},
                        {"note": "G4", "active": true},
                        {"note": "B4", "active": false},
                        {"note": "D5", "active": false},
                        {"note": "E4", "active": true},
                        {"note": "G4", "active": true},
                        {"note": "B4", "active": true},
                        {"note": "D5", "active": true}
                    ]
                }
            },
            {
                name: "Dreamy Pad",
                category: "pad",
                settings: {
                    voiceMode: "poly",
                    waveform: "sine",
                    filterCutoff: "1200",
                    filterRes: "2",
                    filterType: false,
                    reverbMix: "0.7",
                    reverbDecay: "5",
                    delayTime: "0.5",
                    delayFeedback: "0.3",
                    tempo: "80",
                    attack: "0.8",
                    decay: "1",
                    sustain: "0.8",
                    release: "1.5",
                    oscillatorOctave: "0",
                    oscillatorSemi: "0",
                    oscillatorLevel: "0.7",
                    chorusMix: "0.3",
                    distortionMix: "0",
                    flangerMix: "0.15",
                    phaserMix: "0.1",
                    sequencer: [
                        {"note": "C3", "active": true},
                        {"note": "E3", "active": false},
                        {"note": "G3", "active": false},
                        {"note": "B3", "active": true},
                        {"note": "C3", "active": false},
                        {"note": "E3", "active": true},
                        {"note": "G3", "active": false},
                        {"note": "B3", "active": false},
                        {"note": "A2", "active": true},
                        {"note": "C3", "active": false},
                        {"note": "E3", "active": false},
                        {"note": "G3", "active": true},
                        {"note": "A2", "active": false},
                        {"note": "C3", "active": true},
                        {"note": "E3", "active": false},
                        {"note": "G3", "active": false}
                    ]
                }
            },
            {
                name: "Arpeggiator",
                category: "pluck",
                settings: {
                    voiceMode: "poly",
                    waveform: "triangle",
                    filterCutoff: "4000",
                    filterRes: "3",
                    filterType: false,
                    reverbMix: "0.3",
                    reverbDecay: "2",
                    delayTime: "0.25",
                    delayFeedback: "0.6",
                    tempo: "140",
                    attack: "0.005",
                    decay: "0.2",
                    sustain: "0.3",
                    release: "0.2",
                    oscillatorOctave: "0",
                    oscillatorSemi: "0",
                    oscillatorLevel: "0.75",
                    chorusMix: "0.05",
                    distortionMix: "0",
                    flangerMix: "0",
                    phaserMix: "0",
                    sequencer: [
                        {"note": "C3", "active": true},
                        {"note": "E3", "active": true},
                        {"note": "G3", "active": true},
                        {"note": "C4", "active": true},
                        {"note": "E4", "active": true},
                        {"note": "G4", "active": true},
                        {"note": "C5", "active": true},
                        {"note": "G4", "active": true},
                        {"note": "E4", "active": true},
                        {"note": "C4", "active": true},
                        {"note": "G3", "active": true},
                        {"note": "E3", "active": true},
                        {"note": "C3", "active": true},
                        {"note": "E3", "active": true},
                        {"note": "G3", "active": true},
                        {"note": "C4", "active": true}
                    ]
                }
            },
            {
                name: "Ambient FX",
                category: "fx",
                settings: {
                    voiceMode: "poly",
                    waveform: "fmsine",
                    filterCutoff: "2000",
                    filterRes: "10",
                    filterType: true,
                    reverbMix: "0.8",
                    reverbDecay: "8",
                    delayTime: "0.7",
                    delayFeedback: "0.6",
                    tempo: "60",
                    attack: "0.3",
                    decay: "1",
                    sustain: "0.5",
                    release: "3",
                    oscillatorOctave: "1",
                    oscillatorSemi: "7",
                    oscillatorLevel: "0.6",
                    chorusMix: "0.4",
                    distortionMix: "0.1",
                    flangerMix: "0.2",
                    phaserMix: "0.3",
                    sequencer: [
                        {"note": "E3", "active": true},
                        {"note": "B3", "active": false},
                        {"note": "E4", "active": false},
                        {"note": "F#4", "active": true},
                        {"note": "E3", "active": false},
                        {"note": "B3", "active": true},
                        {"note": "E4", "active": false},
                        {"note": "F#4", "active": false},
                        {"note": "A3", "active": true},
                        {"note": "E4", "active": false},
                        {"note": "A4", "active": false},
                        {"note": "B4", "active": true},
                        {"note": "A3", "active": false},
                        {"note": "E4", "active": true},
                        {"note": "A4", "active": false},
                        {"note": "B4", "active": false}
                    ]
                }
            },
            {
                name: "Warm Keys",
                category: "keys",
                settings: {
                    voiceMode: "poly",
                    waveform: "sine",
                    filterCutoff: "3500",
                    filterRes: "1",
                    filterType: false,
                    reverbMix: "0.4",
                    reverbDecay: "2.5",
                    delayTime: "0.2",
                    delayFeedback: "0.2",
                    tempo: "100",
                    attack: "0.05",
                    decay: "0.2",
                    sustain: "0.7",
                    release: "0.6",
                    oscillatorOctave: "0",
                    oscillatorSemi: "0",
                    oscillatorLevel: "0.8",
                    chorusMix: "0.15",
                    distortionMix: "0",
                    flangerMix: "0",
                    phaserMix: "0.1",
                    sequencer: [
                        {"note": "C3", "active": true},
                        {"note": "E3", "active": true},
                        {"note": "G3", "active": true},
                        {"note": "C3", "active": false},
                        {"note": "F3", "active": true},
                        {"note": "A3", "active": true},
                        {"note": "C4", "active": true},
                        {"note": "F3", "active": false},
                        {"note": "G3", "active": true},
                        {"note": "B3", "active": true},
                        {"note": "D4", "active": true},
                        {"note": "G3", "active": false},
                        {"note": "A3", "active": true},
                        {"note": "C4", "active": true},
                        {"note": "E4", "active": true},
                        {"note": "A3", "active": false}
                    ]
                }
            },
            {
                name: "Wobble Bass",
                category: "bass",
                settings: {
                    voiceMode: "mono",
                    waveform: "fatsquare",
                    filterCutoff: "800",
                    filterRes: "15",
                    filterType: false,
                    reverbMix: "0.1",
                    reverbDecay: "1",
                    delayTime: "0.125",
                    delayFeedback: "0.3",
                    tempo: "135",
                    attack: "0.01",
                    decay: "0.1",
                    sustain: "0.9",
                    release: "0.2",
                    oscillatorOctave: "-1",
                    oscillatorSemi: "0",
                    oscillatorLevel: "0.85",
                    chorusMix: "0",
                    distortionMix: "0.4",
                    flangerMix: "0.2",
                    phaserMix: "0.1",
                    sequencer: [
                        {"note": "C2", "active": true},
                        {"note": "C2", "active": true},
                        {"note": "G2", "active": true},
                        {"note": "G2", "active": true},
                        {"note": "A#1", "active": true},
                        {"note": "A#1", "active": true},
                        {"note": "F2", "active": true},
                        {"note": "F2", "active": true},
                        {"note": "D#2", "active": true},
                        {"note": "D#2", "active": true},
                        {"note": "A#2", "active": true},
                        {"note": "A#2", "active": true},
                        {"note": "G#1", "active": true},
                        {"note": "G#1", "active": true},
                        {"note": "D#2", "active": true},
                        {"note": "D#2", "active": true}
                    ]
                }
            },
            {
                name: "Bright Lead",
                category: "lead",
                settings: {
                    voiceMode: "mono",
                    waveform: "sawtooth",
                    filterCutoff: "5000",
                    filterRes: "4",
                    filterType: false,
                    reverbMix: "0.2",
                    reverbDecay: "1.2",
                    delayTime: "0.33",
                    delayFeedback: "0.4",
                    tempo: "120",
                    attack: "0.005",
                    decay: "0.1",
                    sustain: "0.6",
                    release: "0.2",
                    oscillatorOctave: "1",
                    oscillatorSemi: "0",
                    oscillatorLevel: "0.8",
                    chorusMix: "0",
                    distortionMix: "0.15",
                    flangerMix: "0",
                    phaserMix: "0.1",
                    sequencer: [
                        {"note": "E4", "active": true},
                        {"note": "G4", "active": false},
                        {"note": "A4", "active": true},
                        {"note": "B4", "active": false},
                        {"note": "D5", "active": true},
                        {"note": "B4", "active": false},
                        {"note": "A4", "active": true},
                        {"note": "G4", "active": false},
                        {"note": "E4", "active": true},
                        {"note": "G4", "active": false},
                        {"note": "A4", "active": true},
                        {"note": "B4", "active": false},
                        {"note": "D5", "active": true},
                        {"note": "B4", "active": false},
                        {"note": "A4", "active": true},
                        {"note": "G4", "active": false}
                    ]
                }
            },
            {
                name: "Spacey Atmosphere",
                category: "pad",
                settings: {
                    voiceMode: "poly",
                    waveform: "amsine",
                    filterCutoff: "1500",
                    filterRes: "3",
                    filterType: true,
                    reverbMix: "0.9",
                    reverbDecay: "10",
                    delayTime: "0.5",
                    delayFeedback: "0.7",
                    tempo: "70",
                    attack: "1",
                    decay: "1",
                    sustain: "0.8",
                    release: "3",
                    oscillatorOctave: "0",
                    oscillatorSemi: "5",
                    oscillatorLevel: "0.65",
                    chorusMix: "0.4",
                    distortionMix: "0",
                    flangerMix: "0.3",
                    phaserMix: "0.2",
                    sequencer: [
                        {"note": "A2", "active": true},
                        {"note": "E3", "active": false},
                        {"note": "A3", "active": false},
                        {"note": "C4", "active": false},
                        {"note": "E4", "active": true},
                        {"note": "C4", "active": false},
                        {"note": "A3", "active": false},
                        {"note": "E3", "active": false},
                        {"note": "G2", "active": true},
                        {"note": "D3", "active": false},
                        {"note": "G3", "active": false},
                        {"note": "B3", "active": false},
                        {"note": "D4", "active": true},
                        {"note": "B3", "active": false},
                        {"note": "G3", "active": false},
                        {"note": "D3", "active": false}
                    ]
                }
            },
            {
                name: "Glitch FX",
                category: "fx",
                settings: {
                    voiceMode: "poly",
                    waveform: "pulse",
                    filterCutoff: "1000",
                    filterRes: "18",
                    filterType: true,
                    reverbMix: "0.5",
                    reverbDecay: "3",
                    delayTime: "0.16",
                    delayFeedback: "0.8",
                    tempo: "145",
                    attack: "0.005",
                    decay: "0.1",
                    sustain: "0.3",
                    release: "0.2",
                    oscillatorOctave: "2",
                    oscillatorSemi: "-5",
                    oscillatorLevel: "0.7",
                    chorusMix: "0.2",
                    distortionMix: "0.3",
                    flangerMix: "0.2",
                    phaserMix: "0.3",
                    sequencer: [
                        {"note": "C5", "active": true},
                        {"note": "C5", "active": false},
                        {"note": "G4", "active": true},
                        {"note": "G4", "active": false},
                        {"note": "C5", "active": true},
                        {"note": "C5", "active": false},
                        {"note": "D#5", "active": true},
                        {"note": "D#5", "active": false},
                        {"note": "A#4", "active": true},
                        {"note": "A#4", "active": false},
                        {"note": "F5", "active": true},
                        {"note": "F5", "active": false},
                        {"note": "G5", "active": true},
                        {"note": "G5", "active": false},
                        {"note": "G#5", "active": true},
                        {"note": "G#5", "active": false}
                    ]
                }
            },
            {
                name: "Classic Pluck",
                category: "pluck",
                settings: {
                    voiceMode: "poly",
                    waveform: "triangle",
                    filterCutoff: "2500",
                    filterRes: "2",
                    filterType: false,
                    reverbMix: "0.25",
                    reverbDecay: "1.5",
                    delayTime: "0.33",
                    delayFeedback: "0.3",
                    tempo: "110",
                    attack: "0.005",
                    decay: "0.15",
                    sustain: "0.2",
                    release: "0.3",
                    oscillatorOctave: "0",
                    oscillatorSemi: "0",
                    oscillatorLevel: "0.8",
                    chorusMix: "0.05",
                    distortionMix: "0",
                    flangerMix: "0",
                    phaserMix: "0",
                    sequencer: [
                        {"note": "E4", "active": true},
                        {"note": "B3", "active": true},
                        {"note": "E4", "active": true},
                        {"note": "G4", "active": true},
                        {"note": "F#4", "active": true},
                        {"note": "B3", "active": true},
                        {"note": "F#4", "active": true},
                        {"note": "A4", "active": true},
                        {"note": "D4", "active": true},
                        {"note": "A3", "active": true},
                        {"note": "D4", "active": true},
                        {"note": "F#4", "active": true},
                        {"note": "E4", "active": true},
                        {"note": "B3", "active": true},
                        {"note": "E4", "active": true},
                        {"note": "G4", "active": true}
                    ]
                }
            },
            {
                name: "Electric Piano",
                category: "keys",
                settings: {
                    voiceMode: "poly",
                    waveform: "sine",
                    filterCutoff: "4000",
                    filterRes: "1",
                    filterType: false,
                    reverbMix: "0.35",
                    reverbDecay: "2",
                    delayTime: "0.15",
                    delayFeedback: "0.15",
                    tempo: "100",
                    attack: "0.01",
                    decay: "0.5",
                    sustain: "0.5",
                    release: "0.5",
                    oscillatorOctave: "0",
                    oscillatorSemi: "0",
                    oscillatorLevel: "0.8",
                    chorusMix: "0.1",
                    distortionMix: "0.05",
                    flangerMix: "0",
                    phaserMix: "0.15",
                    sequencer: [
                        {"note": "C4", "active": true},
                        {"note": "G3", "active": true},
                        {"note": "E3", "active": true},
                        {"note": "G3", "active": true},
                        {"note": "C4", "active": true},
                        {"note": "G3", "active": true},
                        {"note": "E3", "active": true},
                        {"note": "G3", "active": true},
                        {"note": "A3", "active": true},
                        {"note": "E3", "active": true},
                        {"note": "C3", "active": true},
                        {"note": "E3", "active": true},
                        {"note": "F3", "active": true},
                        {"note": "C3", "active": true},
                        {"note": "A2", "active": true},
                        {"note": "C3", "active": true}
                    ]
                }
            }
        ];

        // The currently active preset name
        let activePresetName = null;

        // Initialize presets
        function initializePresets() {
            // Apply the default preset from builtInPresets
            applyPreset(builtInPresets[0].settings);
            activePresetName = builtInPresets[0].name;
            
            // Render the presets list
            renderPresetList();
        }

        // Render the preset list
        function renderPresetList() {
            const presetList = document.getElementById('presetList');
            presetList.innerHTML = '';
            
            // Add built-in presets
            builtInPresets.forEach(preset => {
                const presetItem = document.createElement('div');
                presetItem.className = 'preset-item' + (activePresetName === preset.name ? ' active' : '');
                presetItem.innerHTML = `
                    <i class="fas fa-music"></i>
                    <span class="preset-name">${preset.name}</span>
                    <span class="preset-tag ${preset.category}">${preset.category}</span>
                `;
                presetItem.addEventListener('click', () => {
                    // Set as active
                    document.querySelectorAll('.preset-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    presetItem.classList.add('active');
                    activePresetName = preset.name;
                    
                    // Apply the preset
                    applyPreset(preset.settings);
                });
                presetList.appendChild(presetItem);
            });
            
            // Add custom presets
            const customPresets = JSON.parse(localStorage.getItem('customPresets') || '[]');
            customPresets.forEach(preset => {
                const presetItem = document.createElement('div');
                presetItem.className = 'preset-item' + (activePresetName === preset.name ? ' active' : '');
                presetItem.innerHTML = `
                    <i class="fas fa-music"></i>
                    <span class="preset-name">${preset.name}</span>
                    <span class="preset-tag ${preset.category}">${preset.category}</span>
                `;
                presetItem.addEventListener('click', () => {
                    // Set as active
                    document.querySelectorAll('.preset-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    presetItem.classList.add('active');
                    activePresetName = preset.name;
                    
                    // Apply the preset
                    applyPreset(preset.settings);
                });
                presetList.appendChild(presetItem);
            });
        }

        // Apply a preset to the synth
        function applyPreset(settings) {
            // Update all parameters and trigger input events to update visuals
            Object.entries(settings).forEach(([key, value]) => {
                if (key !== 'sequencer') {
                    if (key === 'filterType') {
                        // Handle toggle separately
                        document.getElementById('filterTypeToggle').checked = value;
                        document.getElementById('filterTypeToggle').dispatchEvent(new Event('change'));
                    } else {
                        const input = document.getElementById(key);
                        if (input) {
                            input.value = value;
                            input.dispatchEvent(new Event('input'));
                            
                            // Special handling for voice mode
                            if (key === 'voiceMode' && value !== currentMode) {
                                currentMode = value;
                                createSynth(currentMode);
                            }
                        }
                    }
                }
            });

            // Update sequencer if available
            if (settings.sequencer) {
                const steps = document.querySelectorAll('.step');
                settings.sequencer.forEach((stepSetup, i) => {
                    if (i < steps.length) {
                        const step = steps[i];
                        const select = step.querySelector('select');
                        if (select && stepSetup.note) {
                            select.value = stepSetup.note;
                        }
                        
                        const toggle = step.querySelector('.step-toggle');
                        if (toggle) {
                            toggle.classList.toggle('active', stepSetup.active);
                            toggle.textContent = stepSetup.active ? 'On' : 'Off';
                        }
                    }
                });
            }
            
            // Ensure synth settings is updated for recreating synths
            synthSettings.envelope.attack = parseFloat(document.getElementById('attack').value);
            synthSettings.envelope.decay = parseFloat(document.getElementById('decay').value);
            synthSettings.envelope.sustain = parseFloat(document.getElementById('sustain').value);
            synthSettings.envelope.release = parseFloat(document.getElementById('release').value);

            // Then recreate the synth to apply all settings consistently
            createSynth(currentMode);
            
            // Update ADSR Visualizer
            updateADSRVisualizer();
            
            // Update Filter Response Curve
            updateFilterResponse();
            
            // Update VU meter to provide visual feedback that preset was loaded
            updateVUMeter(0.6);
        }
        
        // Get the current setup
        function getCurrentSetup() {
            const steps = document.querySelectorAll('.step');
            
            return {
                voiceMode: document.getElementById('voiceMode').value,
                waveform: document.getElementById('waveform').value,
                filterCutoff: document.getElementById('filterCutoff').value,
                filterRes: document.getElementById('filterRes').value,
                filterType: document.getElementById('filterTypeToggle').checked,
                reverbMix: document.getElementById('reverbMix').value,
                reverbDecay: document.getElementById('reverbDecay').value,
                delayTime: document.getElementById('delayTime').value,
                delayFeedback: document.getElementById('delayFeedback').value,
                tempo: document.getElementById('tempo').value,
                attack: document.getElementById('attack').value,
                decay: document.getElementById('decay').value,
                sustain: document.getElementById('sustain').value,
                release: document.getElementById('release').value,
                oscillatorOctave: document.getElementById('oscillatorOctave').value,
                oscillatorSemi: document.getElementById('oscillatorSemi').value,
                oscillatorLevel: document.getElementById('oscillatorLevel').value,
                chorusMix: document.getElementById('chorusMix').value,
                distortionMix: document.getElementById('distortionMix').value,
                flangerMix: document.getElementById('flangerMix').value,
                phaserMix: document.getElementById('phaserMix').value,
                sequencer: Array.from(steps).map(step => ({
                    note: step.querySelector('select').value,
                    active: step.querySelector('.step-toggle').classList.contains('active')
                }))
            };
        }

        // Modal handling for new preset
        const presetModal = document.getElementById('presetModal');
        const presetNameInput = document.getElementById('presetName');
        const presetCategorySelect = document.getElementById('presetCategory');
        
        document.getElementById('newPresetBtn').addEventListener('click', () => {
            presetModal.classList.add('active');
            presetNameInput.value = '';
            presetNameInput.focus();
        });
        
        document.getElementById('cancelPresetBtn').addEventListener('click', () => {
            presetModal.classList.remove('active');
        });
        
        document.getElementById('savePresetBtn').addEventListener('click', () => {
            const name = presetNameInput.value.trim();
            if (!name) {
                alert('Please enter a name for your preset');
                return;
            }
            
            const category = presetCategorySelect.value;
            
            // Get current custom presets
            const customPresets = JSON.parse(localStorage.getItem('customPresets') || '[]');
            
            // Check if a preset with this name already exists
            const existingIndex = customPresets.findIndex(p => p.name === name);
            
            // Create the new preset
            const newPreset = {
                name,
                category,
                settings: getCurrentSetup()
            };
            
            // Update or add to the presets array
            if (existingIndex >= 0) {
                customPresets[existingIndex] = newPreset;
            } else {
                customPresets.push(newPreset);
            }
            
            // Save back to localStorage
            localStorage.setItem('customPresets', JSON.stringify(customPresets));
            
            // Close modal
            presetModal.classList.remove('active');
            
            // Set as active preset
            activePresetName = name;
            
            // Refresh the preset list
            renderPresetList();
            
            // Visual feedback
            const savePresetBtn = document.getElementById('newPresetBtn');
            savePresetBtn.classList.add('success');
            setTimeout(() => {
                savePresetBtn.classList.remove('success');
            }, 1000);
        });
        
        // Delete preset functionality
        document.getElementById('deletePresetBtn').addEventListener('click', () => {
            // Check if a preset is selected and it's a custom preset (not built-in)
            const isBuiltIn = builtInPresets.some(p => p.name === activePresetName);
            if (!activePresetName || isBuiltIn) {
                alert('Please select a custom preset to delete');
                return;
            }
            
            if (confirm(`Are you sure you want to delete the preset "${activePresetName}"?`)) {
                // Get current custom presets
                const customPresets = JSON.parse(localStorage.getItem('customPresets') || '[]');
                
                // Remove the preset
                const filteredPresets = customPresets.filter(p => p.name !== activePresetName);
                
                // Save back to localStorage
                localStorage.setItem('customPresets', JSON.stringify(filteredPresets));
                
                // Reset active preset to first built-in preset
                activePresetName = builtInPresets[0].name;
                
                // Apply first built-in preset
                applyPreset(builtInPresets[0].settings);
                
                // Refresh the preset list
                renderPresetList();
                
                // Visual feedback
                const deletePresetBtn = document.getElementById('deletePresetBtn');
                deletePresetBtn.classList.add('success');
                setTimeout(() => {
                    deletePresetBtn.classList.remove('success');
                }, 1000);
            }
        });

        // Chaos button functionality - Updated to include new oscillator parameters and effects
        document.getElementById('chaosButton').addEventListener('click', () => {
            // Randomize waveform
            const waveforms = ['sine', 'square', 'sawtooth', 'triangle', 'pulse', 'fmsine', 'amsine', 'fatsawtooth', 'fatsquare'];
            const randomWaveform = waveforms[Math.floor(Math.random() * waveforms.length)];
            const waveformInput = document.getElementById('waveform');
            waveformInput.value = randomWaveform;
            waveformInput.dispatchEvent(new Event('change'));
            
            // Randomize filter type
            document.getElementById('filterTypeToggle').checked = Math.random() > 0.5;
            document.getElementById('filterTypeToggle').dispatchEvent(new Event('change'));

            // Randomize all knob values
            knobs.forEach(([knobId, inputId]) => {
                const input = document.getElementById(inputId);
                const min = parseFloat(input.min);
                const max = parseFloat(input.max);
                const randomValue = Math.random() * (max - min) + min;
                input.value = randomValue;
                input.dispatchEvent(new Event('input'));
            });

            // Randomize sequencer notes
            const notes = generateNotes();
            document.querySelectorAll('.step select').forEach(select => {
                const randomNote = notes[Math.floor(Math.random() * notes.length)];
                select.value = randomNote;
            });

            // Randomize step toggles
            document.querySelectorAll('.step-toggle').forEach(toggle => {
                const shouldBeActive = Math.random() > 0.5;
                toggle.classList.toggle('active', shouldBeActive);
                toggle.textContent = shouldBeActive ? 'On' : 'Off';
            });
            
            // Visual feedback
            const chaosButton = document.getElementById('chaosButton');
            gsap.to(chaosButton, {
                scale: 1.1,
                duration: 0.1,
                yoyo: true,
                repeat: 1
            });
        });

        // Nudge button functionality - Updated to include new parameters
        document.getElementById('nudgeButton').addEventListener('click', () => {
            const notes = generateNotes();
            const parameters = [
                { type: 'filter', elements: ['filterCutoff', 'filterRes'] },
                { type: 'reverb', elements: ['reverbMix', 'reverbDecay'] },
                { type: 'delay', elements: ['delayTime', 'delayFeedback'] },
                { type: 'oscillator', elements: ['oscillatorOctave', 'oscillatorSemi', 'oscillatorLevel'] },
                { type: 'modulation', elements: ['chorusMix', 'flangerMix', 'phaserMix', 'distortionMix'] },
                { type: 'notes', elements: Array.from(document.querySelectorAll('.step select')) },
                { type: 'filter type', elements: ['filterTypeToggle'] }
            ];
            
            // Randomly select 1-2 parameter groups to modify
            const numChanges = Math.floor(Math.random() * 2) + 1;
            const selectedParams = parameters
                .sort(() => Math.random() - 0.5)
                .slice(0, numChanges);

            selectedParams.forEach(param => {
                if (param.type === 'notes') {
                    // Modify 1-2 random step notes
                    const numNoteChanges = Math.floor(Math.random() * 2) + 1;
                    const stepSelects = param.elements
                        .sort(() => Math.random() - 0.5)
                        .slice(0, numNoteChanges);

                    stepSelects.forEach(select => {
                        const currentNote = select.value;
                        const currentIndex = notes.indexOf(currentNote);
                        const variation = Math.floor(Math.random() * 5) - 2; // -2 to +2 steps
                        const newIndex = Math.max(0, Math.min(notes.length - 1, currentIndex + variation));
                        select.value = notes[newIndex];
                        
                        // Visual feedback
                        gsap.to(select, {
                            backgroundColor: 'rgba(98, 0, 234, 0.3)',
                            duration: 0.2,
                            yoyo: true,
                            repeat: 1
                        });
                    });
                } else if (param.type === 'filter type') {
                    // Handle toggle type controls
                    const element = param.elements[Math.floor(Math.random() * param.elements.length)];
                    const input = document.getElementById(element);
                    input.checked = Math.random() > 0.5;
                    input.dispatchEvent(new Event('change'));
                    
                    // Visual feedback for toggle
                    const toggleContainer = input.closest('.toggle-container');
                    gsap.to(toggleContainer, {
                        opacity: 0.5,
                        duration: 0.2,
                        yoyo: true,
                        repeat: 1
                    });
                } else {
                    // Modify one random parameter in the group
                    const element = param.elements[Math.floor(Math.random() * param.elements.length)];
                    const input = document.getElementById(element);
                    const currentValue = parseFloat(input.value);
                    const range = parseFloat(input.max) - parseFloat(input.min);
                    const variation = (Math.random() * 0.2 - 0.1) * range; // ±10% variation
                    const newValue = Math.max(
                        parseFloat(input.min),
                        Math.min(parseFloat(input.max), currentValue + variation)
                    );
                    input.value = newValue;
                    input.dispatchEvent(new Event('input'));
                    
                    // Visual feedback
                    const knob = document.getElementById(`${element}Knob`);
                    if (knob) {
                        gsap.to(knob, {
                            boxShadow: '0 0 15px rgba(0, 229, 255, 0.8)',
                            duration: 0.3,
                            yoyo: true,
                            repeat: 1
                        });
                    }
                }
            });
            
            // Visual feedback
            const nudgeButton = document.getElementById('nudgeButton');
            gsap.to(nudgeButton, {
                scale: 1.1,
                duration: 0.1,
                yoyo: true,
                repeat: 1
            });
        });

        // Set up sequencer loop
        Tone.Transport.scheduleRepeat((time) => {
            const steps = document.querySelectorAll('.step');
            const step = steps[currentStep];
            const select = step.querySelector('select');
            const toggle = step.querySelector('.step-toggle');
            
            if (toggle.classList.contains('active')) {
                // Both mono and poly synths can use triggerAttackRelease in the same way for sequencer notes
                const note = select.value;
                synth.triggerAttackRelease(note, '8n', time);
                updateVUMeter(0.8);
                
                // Highlight the corresponding key on the keyboard
                highlightKeyFromSequencer(note, 0.25); // 250ms highlight duration
                
                // Visual feedback
                gsap.to(step, {
                    scale: 1.03,
                    duration: 0.1,
                    yoyo: true,
                    repeat: 1
                });
            }
            
            updateSequencer(currentStep);
            currentStep = (currentStep + 1) % 16;
        }, '8n');

        // Update tempo
        document.getElementById('tempo').addEventListener('input', (e) => {
            const tempo = parseInt(e.target.value);
            document.getElementById('tempoValue').textContent = `${tempo} BPM`;
            Tone.Transport.bpm.value = tempo;
        });

        // Set initial tempo
        Tone.Transport.bpm.value = 120;

        // Add octave control with polyphony support
        let currentOctave = 4;

        document.addEventListener('keydown', e => {
            if (e.repeat) return; // Prevent repeat triggers
            
            // Handle octave shifting
            if (e.key === 'z' && currentOctave > 2) {
                currentOctave--;
                return;
            }
            if (e.key === 'x' && currentOctave < 7) {
                currentOctave++;
                return;
            }
            
            const keyMap = {
                'a': `C${currentOctave}`, 
                'w': `C#${currentOctave}`, 
                's': `D${currentOctave}`, 
                'e': `D#${currentOctave}`, 
                'd': `E${currentOctave}`,
                'f': `F${currentOctave}`, 
                't': `F#${currentOctave}`, 
                'g': `G${currentOctave}`, 
                'y': `G#${currentOctave}`, 
                'h': `A${currentOctave}`,
                'u': `A#${currentOctave}`, 
                'j': `B${currentOctave}`,
                'k': `C${currentOctave+1}`, 
                'l': `D${currentOctave+1}`                
            };
            
            if (keyMap[e.key]) {
                const note = keyMap[e.key];
                
                if (currentMode === "poly") {
                    // Polyphonic mode - add new note if not already active
                    if (!activeComputerKeys.has(e.key)) {
                        activeComputerKeys.add(e.key);
                        activeNotes.add(note);
                        synth.triggerAttack(note);
                        updateVUMeter(0.8);
                        
                        // Update visual keyboard
                        const keyElement = document.querySelector(`.key[data-note="${note}"]`) ||
                                        document.querySelector(`.black-key[data-note="${note}"]`);
                                        
                        if (keyElement) {
                            keyElement.classList.add('active');
                        }
                    }
                } else {
                    // Monophonic mode - use our consistent helper function
                    if (!activeComputerKeys.has(e.key)) {
                        // Clear all active computer keys in mono mode
                        activeComputerKeys.clear();
                        activeComputerKeys.add(e.key);
                        
                        // Use our helper function for consistent handling
                        handleMonoNoteChange(note);
                        
                        // Update visual keyboard for new note
                        const keyElement = document.querySelector(`.key[data-note="${note}"]`) ||
                                        document.querySelector(`.black-key[data-note="${note}"]`);
                        if (keyElement) {
                            keyElement.classList.add('active');
                        }
                    }
                }
            }
        });

        document.addEventListener('keyup', e => {
            const keyMap = {
                'a': `C${currentOctave}`, 
                'w': `C#${currentOctave}`, 
                's': `D${currentOctave}`, 
                'e': `D#${currentOctave}`, 
                'd': `E${currentOctave}`,
                'f': `F${currentOctave}`, 
                't': `F#${currentOctave}`, 
                'g': `G${currentOctave}`, 
                'y': `G#${currentOctave}`, 
                'h': `A${currentOctave}`,
                'u': `A#${currentOctave}`, 
                'j': `B${currentOctave}`,
                'k': `C${currentOctave+1}`, 
                'l': `D${currentOctave+1}`
            };
            
            if (keyMap[e.key]) {
                const note = keyMap[e.key];
                
                if (activeComputerKeys.has(e.key)) {
                    activeComputerKeys.delete(e.key);
                    
                    if (currentMode === "poly") {
                        activeNotes.delete(note);
                        synth.triggerRelease(note);
                    } else {
                        // For mono mode
                        activeNotes.delete(note);
                        synth.triggerRelease(); // No parameter for mono
                    }
                    
                    // Update visual keyboard
                    const keyElement = document.querySelector(`.key[data-note="${note}"]`) ||
                                    document.querySelector(`.black-key[data-note="${note}"]`);
                                    
                    if (keyElement) {
                        keyElement.classList.remove('active');
                    }
                }
            }
        });
    </script>
</body>
</html>