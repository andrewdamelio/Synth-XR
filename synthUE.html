<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synth XR - Ultimate Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ml5js/0.12.2/ml5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webmidi/3.1.6/webmidi.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
    <div class="loading-indicator" id="loadingIndicator"></div>
    
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <div class="notification-content">
            <div class="notification-text">Notification text</div>
        </div>
    </div>
    
    <div class="modal-overlay" id="shortcutsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Keyboard Shortcuts</h3>
                <button class="modal-close" id="closeShortcutsModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-description">
                    Use these keyboard shortcuts to speed up your workflow in Synth XR.
                </div>
                
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
                    <tr>
                        <th style="text-align: left; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary);">Action</th>
                        <th style="text-align: right; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary);">Shortcut</th>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">Start/Stop Sequencer</td>
                        <td style="text-align: right; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);"><kbd style="background: var(--surface-dark); padding: 2px 5px; border-radius: 3px; font-family: monospace;">Space</kbd></td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">Save Preset</td>
                        <td style="text-align: right; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);"><kbd style="background: var(--surface-dark); padding: 2px 5px; border-radius: 3px; font-family: monospace;">Ctrl</kbd> + <kbd style="background: var(--surface-dark); padding: 2px 5px; border-radius: 3px; font-family: monospace;">S</kbd></td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">Octave Up</td>
                        <td style="text-align: right; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);"><kbd style="background: var(--surface-dark); padding: 2px 5px; border-radius: 3px; font-family: monospace;">X</kbd></td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">Octave Down</td>
                        <td style="text-align: right; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);"><kbd style="background: var(--surface-dark); padding: 2px 5px; border-radius: 3px; font-family: monospace;">Z</kbd></td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">Play C Major Chord</td>
                        <td style="text-align: right; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);"><kbd style="background: var(--surface-dark); padding: 2px 5px; border-radius: 3px; font-family: monospace;">1</kbd></td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">Play G Major Chord</td>
                        <td style="text-align: right; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);"><kbd style="background: var(--surface-dark); padding: 2px 5px; border-radius: 3px; font-family: monospace;">2</kbd></td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">Record</td>
                        <td style="text-align: right; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);"><kbd style="background: var(--surface-dark); padding: 2px 5px; border-radius: 3px; font-family: monospace;">R</kbd></td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">Piano Keys</td>
                        <td style="text-align: right; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);"><kbd style="background: var(--surface-dark); padding: 2px 5px; border-radius: 3px; font-family: monospace;">A</kbd> <kbd style="background: var(--surface-dark); padding: 2px 5px; border-radius: 3px; font-family: monospace;">S</kbd> <kbd style="background: var(--surface-dark); padding: 2px 5px; border-radius: 3px; font-family: monospace;">D</kbd> <kbd style="background: var(--surface-dark); padding: 2px 5px; border-radius: 3px; font-family: monospace;">F</kbd> ...</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">Toggle Chaos Mode</td>
                        <td style="text-align: right; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);"><kbd style="background: var(--surface-dark); padding: 2px 5px; border-radius: 3px; font-family: monospace;">C</kbd></td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">Toggle MIDI Learn</td>
                        <td style="text-align: right; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);"><kbd style="background: var(--surface-dark); padding: 2px 5px; border-radius: 3px; font-family: monospace;">M</kbd></td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">Show/Hide This Window</td>
                        <td style="text-align: right; padding: 8px;"><kbd style="background: var(--surface-dark); padding: 2px 5px; border-radius: 3px; font-family: monospace;">?</kbd> or <kbd style="background: var(--surface-dark); padding: 2px 5px; border-radius: 3px; font-family: monospace;">F1</kbd></td>
                    </tr>
                </table>
            </div>
            <div class="modal-footer">
                <button class="modal-button secondary" id="closeShortcutsBtn">Close</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Share Your Sound</h3>
                <button class="modal-close" id="closeShareModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-description">
                    Create a shareable link to your current synth settings or export your sound as a file.
                </div>
                
                <div class="modal-form-group">
                    <label class="modal-label">Shareable Link</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="modal-input" id="shareLink" readonly value="https://synthxr.com/s/ab12cd34ef56">
                        <button class="modal-button secondary" id="copyLinkBtn" style="flex-shrink: 0;">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="modal-form-group">
                    <label class="modal-label">Export Options</label>
                    <select class="modal-input" id="exportFormat">
                        <option value="preset">Preset File (.sxp)</option>
                        <option value="midi">MIDI File (.mid)</option>
                        <option value="wav">Audio File (.wav)</option>
                        <option value="project">Project File (.sxproj)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button secondary" id="closeShareBtn">Cancel</button>
                <button class="modal-button primary" id="exportBtn">Export</button>
            </div>
        </div>
    </div>

    <!-- MIDI Learn Modal -->
    <div class="modal-overlay" id="midiLearnModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">MIDI Learn</h3>
                <button class="modal-close" id="closeMidiLearnModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-description">
                    Select a parameter, then move a controller on your MIDI device to create a mapping.
                </div>
                
                <div id="midiLearnStatus" style="padding: 10px; text-align: center; background: var(--panel-dark); border-radius: 4px; margin-bottom: 15px;">
                    Waiting for MIDI input...
                </div>
                
                <div class="modal-form-group">
                    <label class="modal-label">MIDI Mappings</label>
                    <div id="midiMappingsList" style="max-height: 200px; overflow-y: auto; background: var(--surface-dark); border-radius: 6px; padding: 10px;">
                        <div style="padding: 5px; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span>Master Volume</span>
                            <span>CC 7</span>
                            <button class="mod-remove"><i class="fas fa-times"></i></button>
                        </div>
                        <div style="padding: 5px; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span>Filter Cutoff</span>
                            <span>CC 74</span>
                            <button class="mod-remove"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button secondary" id="clearAllMappingsBtn">Clear All</button>
                <button class="modal-button primary" id="saveMidiMappingsBtn">Save Mappings</button>
            </div>
        </div>
    </div>

    <!-- Add Effect Modal -->
    <div class="modal-overlay" id="addEffectModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Effect</h3>
                <button class="modal-close" id="closeAddEffectModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-description">
                    Select an effect to add to your signal chain.
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div class="effect-option" data-effect="reverb">
                        <i class="fas fa-water"></i>
                        Reverb
                    </div>
                    <div class="effect-option" data-effect="delay">
                        <i class="fas fa-repeat"></i>
                        Delay
                    </div>
                    <div class="effect-option" data-effect="distortion">
                        <i class="fas fa-compress-alt"></i>
                        Distortion
                    </div>
                    <div class="effect-option" data-effect="chorus">
                        <i class="fas fa-wave-square"></i>
                        Chorus
                    </div>
                    <div class="effect-option" data-effect="phaser">
                        <i class="fas fa-sync-alt"></i>
                        Phaser
                    </div>
                    <div class="effect-option" data-effect="flanger">
                        <i class="fas fa-random"></i>
                        Flanger
                    </div>
                    <div class="effect-option" data-effect="eq">
                        <i class="fas fa-sliders-h"></i>
                        EQ
                    </div>
                    <div class="effect-option" data-effect="compressor">
                        <i class="fas fa-compress"></i>
                        Compressor
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Parameter Display -->
    <div class="parameter-display" id="parameterDisplay">
        <div class="parameter-display-title">Filter Cutoff</div>
        <div class="parameter-display-value">1200 Hz</div>
    </div>

    <div class="synth-container">
        <div class="brand">
            <div class="brand-name">
                <div class="brand-logo">SYNTH XR</div>
                <div class="version">ULTIMATE EDITION v3.0</div>
            </div>
            
            <div class="master-controls">
                <button class="master-button" id="startSequencer">
                    <i class="fas fa-play"></i>
                    <span>Start</span>
                </button>
                <button class="master-button" id="midiButton">
                    <i class="fas fa-music"></i>
                    <span>MIDI</span>
                    <div class="tooltip">Connect MIDI devices</div>
                </button>
                <button class="master-button" id="midiLearnButton">
                    <i class="fas fa-plug"></i>
                    <span>MIDI Learn</span>
                    <div class="tooltip">Map MIDI controllers</div>
                </button>
                <button class="master-button" id="recButton">
                    <i class="fas fa-microphone"></i>
                    <span>Audio In</span>
                    <div class="tooltip">Use microphone input</div>
                </button>
                <button class="master-button" id="shareButton">
                    <i class="fas fa-share-alt"></i>
                    <span>Share</span>
                    <div class="tooltip">Share your sound</div>
                </button>
                <button class="master-button" id="helpButton">
                    <i class="fas fa-question-circle"></i>
                    <span>Help</span>
                    <div class="tooltip">View keyboard shortcuts</div>
                </button>
            </div>
        </div>
        
        <div class="engine-controls">
            <div class="module oscillator-module">
                <div class="module-header">
                    <h3 class="module-title">
                        <i class="fas fa-wave-square"></i>
                        Oscillators
                    </h3>
                    <div class="module-tabs">
                        <button class="module-tab active" data-tab="osc1">OSC 1</button>
                        <button class="module-tab" data-tab="osc2">OSC 2</button>
                        <button class="module-tab" data-tab="osc3">OSC 3</button>
                    </div>
                </div>
                
                <div class="tab-content active" id="osc1">
                    <div class="control-group">
                        <div class="select-container">
                            <label class="select-label">Waveform</label>
                            <select id="osc1Type">
                                <option value="sine">Sine</option>
                                <option value="square">Square</option>
                                <option value="sawtooth">Sawtooth</option>
                                <option value="triangle">Triangle</option>
                                <option value="pulse">Pulse</option>
                                <option value="fmsine">FM Sine</option>
                                <option value="amsine">AM Sine</option>
                                <option value="fatsawtooth">Fat Saw</option>
                                <option value="fatsquare" selected>Fat Square</option>
                            </select>
                        </div>
                        <div class="switch-container">
                            <label class="switch-label">Active</label>
                            <label class="switch">
                                <input type="checkbox" id="osc1Active" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="knob-row">
                        <div class="knob-container">
                            <label class="knob-label">Octave</label>
                            <div class="knob osc1" id="osc1OctaveKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Adjust octave</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="osc1Octave" min="-2" max="2" step="1" value="0">
                            <span class="knob-value" id="osc1OctaveValue">0</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Semi</label>
                            <div class="knob osc1" id="osc1SemiKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Adjust semitones</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="osc1Semi" min="-12" max="12" step="1" value="0">
                            <span class="knob-value" id="osc1SemiValue">0</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Detune</label>
                            <div class="knob osc1" id="osc1DetuneKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Fine-tune detune</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="osc1Detune" min="-50" max="50" step="1" value="0">
                            <span class="knob-value" id="osc1DetuneValue">0 ct</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Level</label>
                            <div class="knob osc1" id="osc1LevelKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Adjust volume</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="osc1Level" min="0" max="1" step="0.01" value="1">
                            <span class="knob-value" id="osc1LevelValue">100%</span>
                        </div>
                    </div>
                    
                    <!-- New FM controls for OSC1 -->
                    <div class="fm-controls">
                        <div class="knob-container">
                            <label class="knob-label">FM Amt</label>
                            <div class="knob osc1" id="osc1FMAmountKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">FM modulation amount</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="osc1FMAmount" min="0" max="100" step="1" value="0">
                            <span class="knob-value" id="osc1FMAmountValue">0%</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">FM Ratio</label>
                            <div class="knob osc1" id="osc1FMRatioKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">FM frequency ratio</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="osc1FMRatio" min="0.1" max="10" step="0.1" value="2">
                            <span class="knob-value" id="osc1FMRatioValue">2.0</span>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="osc2">
                    <!-- OSC 2 content similar to OSC 1 -->
                    <div class="control-group">
                        <div class="select-container">
                            <label class="select-label">Waveform</label>
                            <select id="osc2Type">
                                <option value="sine">Sine</option>
                                <option value="square">Square</option>
                                <option value="sawtooth" selected>Sawtooth</option>
                                <option value="triangle">Triangle</option>
                                <option value="pulse">Pulse</option>
                                <option value="fmsine">FM Sine</option>
                                <option value="amsine">AM Sine</option>
                                <option value="fatsawtooth">Fat Saw</option>
                                <option value="fatsquare">Fat Square</option>
                            </select>
                        </div>
                        <div class="switch-container">
                            <label class="switch-label">Active</label>
                            <label class="switch">
                                <input type="checkbox" id="osc2Active">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="knob-row">
                        <div class="knob-container">
                            <label class="knob-label">Octave</label>
                            <div class="knob osc2" id="osc2OctaveKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Adjust octave</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="osc2Octave" min="-2" max="2" step="1" value="0">
                            <span class="knob-value" id="osc2OctaveValue">0</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Semi</label>
                            <div class="knob osc2" id="osc2SemiKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Adjust semitones</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="osc2Semi" min="-12" max="12" step="1" value="0">
                            <span class="knob-value" id="osc2SemiValue">0</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Detune</label>
                            <div class="knob osc2" id="osc2DetuneKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Fine-tune detune</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="osc2Detune" min="-50" max="50" step="1" value="0">
                            <span class="knob-value" id="osc2DetuneValue">0 ct</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Level</label>
                            <div class="knob osc2" id="osc2LevelKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Adjust volume</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="osc2Level" min="0" max="1" step="0.01" value="0.8">
                            <span class="knob-value" id="osc2LevelValue">80%</span>
                        </div>
                    </div>
                    
                    <!-- New oscillator sync feature -->
                    <div class="oscillator-sync">
                        <div class="switch-container">
                            <label class="switch-label">Sync to OSC1</label>
                            <label class="switch">
                                <input type="checkbox" id="osc2Sync">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="knob-container">
                            <label class="knob-label">Sync Amt</label>
                            <div class="knob osc2" id="osc2SyncAmountKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Sync intensity</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="osc2SyncAmount" min="0" max="100" step="1" value="50">
                            <span class="knob-value" id="osc2SyncAmountValue">50%</span>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="osc3">
                    <!-- OSC 3 content similar to OSC 1 -->
                    <div class="control-group">
                        <div class="select-container">
                            <label class="select-label">Waveform</label>
                            <select id="osc3Type">
                                <option value="sine">Sine</option>
                                <option value="square">Square</option>
                                <option value="sawtooth">Sawtooth</option>
                                <option value="triangle" selected>Triangle</option>
                                <option value="pulse">Pulse</option>
                                <option value="fmsine">FM Sine</option>
                                <option value="amsine">AM Sine</option>
                                <option value="fatsawtooth">Fat Saw</option>
                                <option value="fatsquare">Fat Square</option>
                            </select>
                        </div>
                        <div class="switch-container">
                            <label class="switch-label">Active</label>
                            <label class="switch">
                                <input type="checkbox" id="osc3Active">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="knob-row">
                        <div class="knob-container">
                            <label class="knob-label">Octave</label>
                            <div class="knob osc3" id="osc3OctaveKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Adjust octave</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="osc3Octave" min="-2" max="2" step="1" value="-1">
                            <span class="knob-value" id="osc3OctaveValue">-1</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Semi</label>
                            <div class="knob osc3" id="osc3SemiKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Adjust semitones</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="osc3Semi" min="-12" max="12" step="1" value="0">
                            <span class="knob-value" id="osc3SemiValue">0</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Detune</label>
                            <div class="knob osc3" id="osc3DetuneKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Fine-tune detune</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="osc3Detune" min="-50" max="50" step="1" value="0">
                            <span class="knob-value" id="osc3DetuneValue">0 ct</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Level</label>
                            <div class="knob osc3" id="osc3LevelKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Adjust volume</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="osc3Level" min="0" max="1" step="0.01" value="0.6">
                            <span class="knob-value" id="osc3LevelValue">60%</span>
                        </div>
                    </div>
                    
                    <!-- New oscillator ringmod feature -->
                    <div class="oscillator-sync">
                        <div class="switch-container">
                            <label class="switch-label">Ring Mod</label>
                            <label class="switch">
                                <input type="checkbox" id="osc3RingMod">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="select-container">
                            <label class="select-label">Source</label>
                            <select id="osc3RingModSource">
                                <option value="osc1">Osc 1</option>
                                <option value="osc2">Osc 2</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="submodule">
                    <div class="submodule-header">
                        <div class="submodule-title">
                            <i class="fas fa-sliders-h"></i>
                            Voice Settings
                        </div>
                    </div>
                    
                    <div class="voice-settings">
                        <div class="select-container">
                            <label class="select-label">Voice Mode</label>
                            <select id="voiceMode">
                                <option value="poly">Polyphonic</option>
                                <option value="mono">Monophonic</option>
                                <option value="legato">Legato</option>
                                <option value="unison">Unison</option>
                            </select>
                        </div>
                        
                        <div class="select-container">
                            <label class="select-label">Unison Voices</label>
                            <select id="unisonVoices">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="6">6</option>
                                <option value="8">8</option>
                                <option value="12">12</option>
                                <option value="16">16</option>
                            </select>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Spread</label>
                            <div class="knob osc1" id="unisonSpreadKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Unison detune spread</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="unisonSpread" min="0" max="100" step="1" value="20">
                            <span class="knob-value" id="unisonSpreadValue">20%</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Glide</label>
                            <div class="knob osc1" id="portamentoKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Note transition time</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="portamento" min="0" max="1" step="0.01" value="0">
                            <span class="knob-value" id="portamentoValue">0.00s</span>
                        </div>
                        
                        <div class="voice-counter">
                            <i class="fas fa-microchip"></i> Voices: <span id="voiceCount">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="module modulation-module">
                <div class="module-header">
                    <h3 class="module-title">
                        <i class="fas fa-sync-alt"></i>
                        Modulation
                    </h3>
                    <div class="module-tabs">
                        <button class="module-tab active" data-tab="lfo1">LFO 1</button>
                        <button class="module-tab" data-tab="lfo2">LFO 2</button>
                        <button class="module-tab" data-tab="matrix">Matrix</button>
                    </div>
                </div>
                
                <div class="tab-content active" id="lfo1">
                    <div class="control-group">
                        <div class="select-container">
                            <label class="select-label">LFO Type</label>
                            <select id="lfo1Type">
                                <option value="sine">Sine</option>
                                <option value="triangle">Triangle</option>
                                <option value="square">Square</option>
                                <option value="sawtooth">Sawtooth</option>
                                <option value="rampDown">Ramp Down</option>
                                <option value="random">Random</option>
                                <option value="sample&hold">Sample & Hold</option>
                            </select>
                        </div>
                        <div class="select-container">
                            <label class="select-label">Sync</label>
                            <select id="lfo1Sync">
                                <option value="free">Free</option>
                                <option value="tempo">Tempo</option>
                                <option value="note">Note</option>
                                <option value="beat">Beat</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="knob-row">
                        <div class="knob-container">
                            <label class="knob-label">Rate</label>
                            <div class="knob lfo" id="lfo1RateKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Modulation rate</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="lfo1Rate" min="0.1" max="20" step="0.1" value="5">
                            <span class="knob-value" id="lfo1RateValue">5.0 Hz</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Depth</label>
                            <div class="knob lfo" id="lfo1DepthKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Modulation amount</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="lfo1Depth" min="0" max="1" step="0.01" value="0.5">
                            <span class="knob-value" id="lfo1DepthValue">50%</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Phase</label>
                            <div class="knob lfo" id="lfo1PhaseKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Starting phase</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="lfo1Phase" min="0" max="360" step="1" value="0">
                            <span class="knob-value" id="lfo1PhaseValue">0°</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Delay</label>
                            <div class="knob lfo" id="lfo1DelayKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Fade-in time</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="lfo1Delay" min="0" max="2" step="0.01" value="0">
                            <span class="knob-value" id="lfo1DelayValue">0.00s</span>
                        </div>
                    </div>
                    
                    <!-- Additional LFO controls -->
                    <div class="control-group">
                        <div class="switch-container">
                            <label class="switch-label">BPM Sync</label>
                            <label class="switch">
                                <input type="checkbox" id="lfo1BPMSync">
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="select-container">
                            <label class="select-label">Tempo Division</label>
                            <select id="lfo1TempoDivision" disabled>
                                <option value="1/1">1 Bar</option>
                                <option value="1/2">1/2</option>
                                <option value="1/4">1/4</option>
                                <option value="1/8">1/8</option>
                                <option value="1/16">1/16</option>
                                <option value="1/32">1/32</option>
                                <option value="1/4t">1/4 Triplet</option>
                                <option value="1/8t">1/8 Triplet</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="lfo2">
                    <!-- Similar to LFO 1 but with different defaults -->
                    <div class="control-group">
                        <div class="select-container">
                            <label class="select-label">LFO Type</label>
                            <select id="lfo2Type">
                                <option value="sine">Sine</option>
                                <option value="triangle" selected>Triangle</option>
                                <option value="square">Square</option>
                                <option value="sawtooth">Sawtooth</option>
                                <option value="rampDown">Ramp Down</option>
                                <option value="random">Random</option>
                                <option value="sample&hold">Sample & Hold</option>
                            </select>
                        </div>
                        <div class="select-container">
                            <label class="select-label">Sync</label>
                            <select id="lfo2Sync">
                                <option value="free">Free</option>
                                <option value="tempo" selected>Tempo</option>
                                <option value="note">Note</option>
                                <option value="beat">Beat</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="knob-row">
                        <div class="knob-container">
                            <label class="knob-label">Rate</label>
                            <div class="knob lfo" id="lfo2RateKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Modulation rate</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="lfo2Rate" min="0.1" max="20" step="0.1" value="2">
                            <span class="knob-value" id="lfo2RateValue">2.0 Hz</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Depth</label>
                            <div class="knob lfo" id="lfo2DepthKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Modulation amount</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="lfo2Depth" min="0" max="1" step="0.01" value="0.3">
                            <span class="knob-value" id="lfo2DepthValue">30%</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Phase</label>
                            <div class="knob lfo" id="lfo2PhaseKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Starting phase</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="lfo2Phase" min="0" max="360" step="1" value="90">
                            <span class="knob-value" id="lfo2PhaseValue">90°</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Delay</label>
                            <div class="knob lfo" id="lfo2DelayKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Fade-in time</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="lfo2Delay" min="0" max="2" step="0.01" value="0.2">
                            <span class="knob-value" id="lfo2DelayValue">0.20s</span>
                        </div>
                    </div>
                    
                    <!-- Additional LFO controls -->
                    <div class="control-group">
                        <div class="switch-container">
                            <label class="switch-label">BPM Sync</label>
                            <label class="switch">
                                <input type="checkbox" id="lfo2BPMSync" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="select-container">
                            <label class="select-label">Tempo Division</label>
                            <select id="lfo2TempoDivision">
                                <option value="1/1">1 Bar</option>
                                <option value="1/2">1/2</option>
                                <option value="1/4" selected>1/4</option>
                                <option value="1/8">1/8</option>
                                <option value="1/16">1/16</option>
                                <option value="1/32">1/32</option>
                                <option value="1/4t">1/4 Triplet</option>
                                <option value="1/8t">1/8 Triplet</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="matrix">
                    <div class="mod-matrix-add">
                        <select id="modSource">
                            <option value="">Select Source</option>
                            <option value="lfo1">LFO 1</option>
                            <option value="lfo2">LFO 2</option>
                            <option value="env1">Envelope 1</option>
                            <option value="env2">Envelope 2</option>
                            <option value="velocity">Velocity</option>
                            <option value="modwheel">Mod Wheel</option>
                            <option value="aftertouch">Aftertouch</option>
                            <option value="random">Random</option>
                            <option value="keyboard">Key Tracking</option>
                        </select>
                        <select id="modTarget">
                            <option value="">Select Target</option>
                            <option value="osc1pitch">OSC 1 Pitch</option>
                            <option value="osc2pitch">OSC 2 Pitch</option>
                            <option value="osc3pitch">OSC 3 Pitch</option>
                            <option value="osc1level">OSC 1 Level</option>
                            <option value="osc2level">OSC 2 Level</option>
                            <option value="osc3level">OSC 3 Level</option>
                            <option value="osc1detune">OSC 1 Detune</option>
                            <option value="osc2detune">OSC 2 Detune</option>
                            <option value="osc3detune">OSC 3 Detune</option>
                            <option value="filterCutoff">Filter Cutoff</option>
                            <option value="filterRes">Filter Resonance</option>
                            <option value="lfo1rate">LFO 1 Rate</option>
                            <option value="lfo1depth">LFO 1 Depth</option>
                            <option value="lfo2rate">LFO 2 Rate</option>
                            <option value="lfo2depth">LFO 2 Depth</option>
                            <option value="pan">Pan</option>
                            <option value="fxParam1">FX Param 1</option>
                            <option value="fxParam2">FX Param 2</option>
                            <option value="distortion">Distortion</option>
                            <option value="reverbMix">Reverb Mix</option>
                            <option value="delayTime">Delay Time</option>
                            <option value="delayFeedback">Delay Feedback</option>
                        </select>
                        <button id="addModConnection">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <div class="mod-matrix">
                        <!-- Example modulation connections -->
                        <div class="mod-connection">
                            <div class="mod-connection-header">
                                <div class="mod-source-target">
                                    <span class="mod-source">LFO 1</span> → <span class="mod-target">Filter Cutoff</span>
                                </div>
                                <button class="mod-remove"><i class="fas fa-times"></i></button>
                            </div>
                            <input type="range" class="mod-amount-slider" min="-1" max="1" step="0.01" value="0.5">
                            <div class="mod-amount-value">+50%</div>
                        </div>
                        
                        <div class="mod-connection">
                            <div class="mod-connection-header">
                                <div class="mod-source-target">
                                    <span class="mod-source">Velocity</span> → <span class="mod-target">OSC 1 Level</span>
                                </div>
                                <button class="mod-remove"><i class="fas fa-times"></i></button>
                            </div>
                            <input type="range" class="mod-amount-slider" min="-1" max="1" step="0.01" value="0.7">
                            <div class="mod-amount-value">+70%</div>
                        </div>
                        
                        <div class="mod-connection">
                            <div class="mod-connection-header">
                                <div class="mod-source-target">
                                    <span class="mod-source">Envelope 2</span> → <span class="mod-target">Filter Cutoff</span>
                                </div>
                                <button class="mod-remove"><i class="fas fa-times"></i></button>
                            </div>
                            <input type="range" class="mod-amount-slider" min="-1" max="1" step="0.01" value="0.8">
                            <div class="mod-amount-value">+80%</div>
                        </div>
                        
                        <div class="mod-connection">
                            <div class="mod-connection-header">
                                <div class="mod-source-target">
                                    <span class="mod-source">LFO 2</span> → <span class="mod-target">Pan</span>
                                </div>
                                <button class="mod-remove"><i class="fas fa-times"></i></button>
                            </div>
                            <input type="range" class="mod-amount-slider" min="-1" max="1" step="0.01" value="0.3">
                            <div class="mod-amount-value">+30%</div>
                        </div>
                        
                        <div class="mod-connection">
                            <div class="mod-connection-header">
                                <div class="mod-source-target">
                                    <span class="mod-source">Mod Wheel</span> → <span class="mod-target">LFO 1 Depth</span>
                                </div>
                                <button class="mod-remove"><i class="fas fa-times"></i></button>
                            </div>
                            <input type="range" class="mod-amount-slider" min="-1" max="1" step="0.01" value="1.0">
                            <div class="mod-amount-value">+100%</div>
                        </div>
                        
                        <div class="mod-connection">
                            <div class="mod-connection-header">
                                <div class="mod-source-target">
                                    <span class="mod-source">Key Tracking</span> → <span class="mod-target">Filter Cutoff</span>
                                </div>
                                <button class="mod-remove"><i class="fas fa-times"></i></button>
                            </div>
                            <input type="range" class="mod-amount-slider" min="-1" max="1" step="0.01" value="0.4">
                            <div class="mod-amount-value">+40%</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="module filter-module">
                <div class="module-header">
                    <h3 class="module-title">
                        <i class="fas fa-filter"></i>
                        Filter
                    </h3>
                </div>
                
                <div class="tab-content active" id="filter1">
                    <div class="control-group">
                        <div class="select-container">
                            <label class="select-label">Filter Type</label>
                            <select id="filter1Type">
                                <option value="lowpass">Low Pass</option>
                                <option value="highpass">High Pass</option>
                                <option value="bandpass">Band Pass</option>
                                <option value="notch">Notch</option>
                                <option value="allpass">All Pass</option>
                                <option value="lowshelf">Low Shelf</option>
                                <option value="highshelf">High Shelf</option>
                                <option value="peaking">Peaking</option>
                                <option value="comb">Comb</option>
                            </select>
                        </div>
                        <div class="select-container">
                            <label class="select-label">Slope</label>
                            <select id="filter1Slope">
                                <option value="12">12 dB/oct</option>
                                <option value="24" selected>24 dB/oct</option>
                                <option value="48">48 dB/oct</option>
                                <option value="96">96 dB/oct</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="knob-row">
                        <div class="knob-container">
                            <label class="knob-label">Cutoff</label>
                            <div class="knob filter" id="filter1CutoffKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Filter cutoff frequency</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="filter1Cutoff" min="20" max="20000" step="1" value="2000">
                            <span class="knob-value" id="filter1CutoffValue">2000 Hz</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Resonance</label>
                            <div class="knob filter" id="filter1ResKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Filter resonance</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="filter1Res" min="0" max="20" step="0.1" value="2">
                            <span class="knob-value" id="filter1ResValue">2.0</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Env Amount</label>
                            <div class="knob filter" id="filter1EnvKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Envelope modulation amount</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="filter1Env" min="-100" max="100" step="1" value="50">
                            <span class="knob-value" id="filter1EnvValue">+50%</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Key Track</label>
                            <div class="knob filter" id="filter1KeyTrackKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Keyboard tracking</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="filter1KeyTrack" min="0" max="100" step="1" value="30">
                            <span class="knob-value" id="filter1KeyTrackValue">30%</span>
                        </div>
                    </div>
                    
                    <!-- Advanced filter controls -->
                    <div class="control-group">
                        <div class="knob-container">
                            <label class="knob-label">Drive</label>
                            <div class="knob filter" id="filter1DriveKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Filter saturation</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="filter1Drive" min="0" max="100" step="1" value="0">
                            <span class="knob-value" id="filter1DriveValue">0%</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">LFO Amt</label>
                            <div class="knob filter" id="filter1LFOAmtKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">LFO modulation amount</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="filter1LFOAmt" min="-100" max="100" step="1" value="0">
                            <span class="knob-value" id="filter1LFOAmtValue">0%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="module envelope-module">
                <div class="module-header">
                    <h3 class="module-title">
                        <i class="fas fa-sliders-h"></i>
                        Envelopes
                    </h3>
                    <div class="module-tabs">
                        <button class="module-tab active" data-tab="env1">Amp Env</button>
                        <button class="module-tab" data-tab="env2">Filter Env</button>
                    </div>
                </div>
                
                <div class="tab-content active" id="env1">
                    <div class="knob-row">
                        <div class="knob-container">
                            <label class="knob-label">Attack</label>
                            <div class="knob env" id="env1AttackKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Attack time</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="env1Attack" min="0" max="2" step="0.01" value="0.01">
                            <span class="knob-value" id="env1AttackValue">0.01s</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Decay</label>
                            <div class="knob env" id="env1DecayKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Decay time</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="env1Decay" min="0" max="2" step="0.01" value="0.2">
                            <span class="knob-value" id="env1DecayValue">0.20s</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Sustain</label>
                            <div class="knob env" id="env1SustainKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Sustain level</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="env1Sustain" min="0" max="1" step="0.01" value="0.7">
                            <span class="knob-value" id="env1SustainValue">70%</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Release</label>
                            <div class="knob env" id="env1ReleaseKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Release time</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="env1Release" min="0" max="3" step="0.01" value="0.5">
                            <span class="knob-value" id="env1ReleaseValue">0.50s</span>
                        </div>
                    </div>
                    
                    <div class="knob-row">
                        <div class="knob-container">
                            <label class="knob-label">Curve</label>
                            <div class="knob env" id="env1CurveKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Envelope curve shape</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="env1Curve" min="-10" max="10" step="0.1" value="0">
                            <span class="knob-value" id="env1CurveValue">Linear</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Velocity</label>
                            <div class="knob env" id="env1VelKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Velocity sensitivity</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="env1Vel" min="0" max="100" step="1" value="80">
                            <span class="knob-value" id="env1VelValue">80%</span>
                        </div>
                        
                        <!-- Additional envelope controls -->
                        <div class="knob-container">
                            <label class="knob-label">Hold</label>
                            <div class="knob env" id="env1HoldKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Hold time</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="env1Hold" min="0" max="2" step="0.01" value="0">
                            <span class="knob-value" id="env1HoldValue">0.00s</span>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="env2">
                    <!-- Similar to Env 1 with different defaults -->
                    <div class="knob-row">
                        <div class="knob-container">
                            <label class="knob-label">Attack</label>
                            <div class="knob env" id="env2AttackKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Attack time</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="env2Attack" min="0" max="2" step="0.01" value="0.1">
                            <span class="knob-value" id="env2AttackValue">0.10s</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Decay</label>
                            <div class="knob env" id="env2DecayKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Decay time</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="env2Decay" min="0" max="2" step="0.01" value="0.3">
                            <span class="knob-value" id="env2DecayValue">0.30s</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Sustain</label>
                            <div class="knob env" id="env2SustainKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Sustain level</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="env2Sustain" min="0" max="1" step="0.01" value="0.3">
                            <span class="knob-value" id="env2SustainValue">30%</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Release</label>
                            <div class="knob env" id="env2ReleaseKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Release time</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="env2Release" min="0" max="3" step="0.01" value="0.8">
                            <span class="knob-value" id="env2ReleaseValue">0.80s</span>
                        </div>
                    </div>
                    
                    <div class="knob-row">
                        <div class="knob-container">
                            <label class="knob-label">Curve</label>
                            <div class="knob env" id="env2CurveKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Envelope curve shape</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="env2Curve" min="-10" max="10" step="0.1" value="2">
                            <span class="knob-value" id="env2CurveValue">+2.0</span>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Velocity</label>
                            <div class="knob env" id="env2VelKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Velocity sensitivity</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="env2Vel" min="0" max="100" step="1" value="50">
                            <span class="knob-value" id="env2VelValue">50%</span>
                        </div>
                        
                        <!-- Filter envelope scaling -->
                        <div class="knob-container">
                            <label class="knob-label">Amount</label>
                            <div class="knob env" id="env2AmountKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Envelope amount</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="env2Amount" min="-100" max="100" step="1" value="70">
                            <span class="knob-value" id="env2AmountValue">70%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="module effects-module">
                <div class="module-header">
                    <h3 class="module-title">
                        <i class="fas fa-magic"></i>
                        Effects
                    </h3>
                </div>
                
                <div class="fx-slots">
                    <div class="fx-slot" data-fx-type="reverb">
                        <i class="fas fa-grip-vertical drag-handle"></i>
                        <div class="fx-slot-header">
                            <div class="fx-slot-title">
                                <i class="fas fa-water"></i>
                                Reverb
                            </div>
                            <div class="fx-slot-controls">
                                <button class="fx-slot-button active">
                                    <i class="fas fa-power-off"></i>
                                </button>
                                <button class="fx-slot-button">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="fx-parameters">
                            <div class="knob-container">
                                <label class="knob-label">Mix</label>
                                <div class="knob fx" id="reverbMixKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Dry/Wet mix</div>
                                    <div class="midi-learn-indicator">MIDI</div>
                                </div>
                                <input type="range" id="reverbMix" min="0" max="1" step="0.01" value="0.3">
                                <span class="knob-value" id="reverbMixValue">30%</span>
                            </div>
                            
                            <div class="knob-container">
                                <label class="knob-label">Decay</label>
                                <div class="knob fx" id="reverbDecayKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Decay time</div>
                                    <div class="midi-learn-indicator">MIDI</div>
                                </div>
                                <input type="range" id="reverbDecay" min="0.1" max="10" step="0.1" value="2">
                                <span class="knob-value" id="reverbDecayValue">2.0s</span>
                            </div>
                            
                            <div class="knob-container">
                                <label class="knob-label">Damping</label>
                                <div class="knob fx" id="reverbDampingKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">High frequency damping</div>
                                    <div class="midi-learn-indicator">MIDI</div>
                                </div>
                                <input type="range" id="reverbDamping" min="0" max="1" step="0.01" value="0.4">
                                <span class="knob-value" id="reverbDampingValue">40%</span>
                            </div>
                            
                            <!-- Additional reverb parameters -->
                            <div class="knob-container">
                                <label class="knob-label">PreDelay</label>
                                <div class="knob fx" id="reverbPreDelayKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Pre-delay time</div>
                                    <div class="midi-learn-indicator">MIDI</div>
                                </div>
                                <input type="range" id="reverbPreDelay" min="0" max="0.5" step="0.01" value="0.02">
                                <span class="knob-value" id="reverbPreDelayValue">20ms</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fx-slot" data-fx-type="delay">
                        <i class="fas fa-grip-vertical drag-handle"></i>
                        <div class="fx-slot-header">
                            <div class="fx-slot-title">
                                <i class="fas fa-repeat"></i>
                                Delay
                            </div>
                            <div class="fx-slot-controls">
                                <button class="fx-slot-button active">
                                    <i class="fas fa-power-off"></i>
                                </button>
                                <button class="fx-slot-button">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="fx-parameters">
                            <div class="knob-container">
                                <label class="knob-label">Mix</label>
                                <div class="knob fx" id="delayMixKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Dry/Wet mix</div>
                                    <div class="midi-learn-indicator">MIDI</div>
                                </div>
                                <input type="range" id="delayMix" min="0" max="1" step="0.01" value="0.3">
                                <span class="knob-value" id="delayMixValue">30%</span>
                            </div>
                            
                            <div class="knob-container">
                                <label class="knob-label">Time</label>
                                <div class="knob fx" id="delayTimeKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Delay time</div>
                                    <div class="midi-learn-indicator">MIDI</div>
                                </div>
                                <input type="range" id="delayTime" min="0.01" max="1" step="0.01" value="0.3">
                                <span class="knob-value" id="delayTimeValue">0.30s</span>
                            </div>
                            
                            <div class="knob-container">
                                <label class="knob-label">Feedback</label>
                                <div class="knob fx" id="delayFeedbackKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Feedback amount</div>
                                    <div class="midi-learn-indicator">MIDI</div>
                                </div>
                                <input type="range" id="delayFeedback" min="0" max="0.95" step="0.01" value="0.4">
                                <span class="knob-value" id="delayFeedbackValue">40%</span>
                            </div>
                            
                            <!-- Additional delay parameters -->
                            <div class="knob-container">
                                <label class="knob-label">Filter</label>
                                <div class="knob fx" id="delayFilterKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Feedback filter frequency</div>
                                    <div class="midi-learn-indicator">MIDI</div>
                                </div>
                                <input type="range" id="delayFilter" min="200" max="20000" step="100" value="4000">
                                <span class="knob-value" id="delayFilterValue">4000Hz</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fx-slot" data-fx-type="distortion">
                        <i class="fas fa-grip-vertical drag-handle"></i>
                        <div class="fx-slot-header">
                            <div class="fx-slot-title">
                                <i class="fas fa-compress-alt"></i>
                                Distortion
                            </div>
                            <div class="fx-slot-controls">
                                <button class="fx-slot-button active">
                                    <i class="fas fa-power-off"></i>
                                </button>
                                <button class="fx-slot-button">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="fx-parameters">
                            <div class="knob-container">
                                <label class="knob-label">Amount</label>
                                <div class="knob fx" id="distortionAmountKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Distortion amount</div>
                                    <div class="midi-learn-indicator">MIDI</div>
                                </div>
                                <input type="range" id="distortionAmount" min="0" max="1" step="0.01" value="0.4">
                                <span class="knob-value" id="distortionAmountValue">40%</span>
                            </div>
                            
                            <div class="knob-container">
                                <label class="knob-label">Tone</label>
                                <div class="knob fx" id="distortionToneKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Tone control</div>
                                    <div class="midi-learn-indicator">MIDI</div>
                                </div>
                                <input type="range" id="distortionTone" min="0" max="1" step="0.01" value="0.5">
                                <span class="knob-value" id="distortionToneValue">50%</span>
                            </div>
                            
                            <div class="select-container">
                                <label class="select-label">Type</label>
                                <select id="distortionType">
                                    <option value="soft">Soft Clip</option>
                                    <option value="hard">Hard Clip</option>
                                    <option value="tape">Tape Sat</option>
                                    <option value="tube">Tube</option>
                                    <option value="fuzz">Fuzz</option>
                                </select>
                            </div>
                            
                            <div class="knob-container">
                                <label class="knob-label">Mix</label>
                                <div class="knob fx" id="distortionMixKnob">
                                    <div class="knob-inner"></div>
                                    <div class="tooltip">Dry/Wet mix</div>
                                    <div class="midi-learn-indicator">MIDI</div>
                                </div>
                                <input type="range" id="distortionMix" min="0" max="1" step="0.01" value="0">
                                <span class="knob-value" id="distortionMixValue">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fx-slot" data-fx-type="add-effect">
                        <div class="fx-slot-header">
                            <div class="fx-slot-title">
                                <i class="fas fa-plus"></i>
                                Add Effect
                            </div>
                            <div class="fx-slot-controls">
                                <button class="fx-slot-button" id="openEffectsMenu">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="add-effect-dropdown" id="addEffectDropdown">
                            <div class="effect-option" data-effect="chorus">
                                <i class="fas fa-wave-square"></i> Chorus
                            </div>
                            <div class="effect-option" data-effect="phaser">
                                <i class="fas fa-sync-alt"></i> Phaser
                            </div>
                            <div class="effect-option" data-effect="flanger">
                                <i class="fas fa-random"></i> Flanger
                            </div>
                            <div class="effect-option" data-effect="tremolo">
                                <i class="fas fa-volume-up"></i> Tremolo
                            </div>
                            <div class="effect-option" data-effect="eq">
                                <i class="fas fa-sliders-h"></i> EQ
                            </div>
                            <div class="effect-option" data-effect="compressor">
                                <i class="fas fa-compress"></i> Compressor
                            </div>
                            <div class="effect-option" data-effect="limiter">
                                <i class="fas fa-hand-paper"></i> Limiter
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-vis">
            <div class="module oscilloscope-module">
                <div class="module-header">
                    <h3 class="module-title">
                        <i class="fas fa-chart-line"></i>
                        Oscilloscope
                    </h3>
                </div>
                <div class="oscilloscope">
                    <div class="oscilloscope-grid"></div>
                    <canvas id="oscilloscope"></canvas>
                </div>
                <div class="vu-meter">
                    <div class="vu-meter-fill" id="vuMeter"></div>
                </div>
            </div>
            
            <div class="module analyzer-module">
                <div class="module-header">
                    <h3 class="module-title">
                        <i class="fas fa-chart-bar"></i>
                        Spectrum
                    </h3>
                </div>
                <div class="analyzer">
                    <canvas id="analyzer"></canvas>
                </div>
            </div>
        </div>
        
        <div class="module master-module">
            <div class="module-header">
                <h3 class="module-title">
                    <i class="fas fa-sliders-h"></i>
                    Master
                </h3>
                <div class="module-tabs">
                    <button class="module-tab active" data-tab="master">Controls</button>
                    <button class="module-tab" data-tab="presets">Presets</button>
                </div>
            </div>
            
            <div class="tab-content active" id="master">
                <div class="knob-row">
                    <div class="knob-container">
                        <label class="knob-label">Volume</label>
                        <div class="knob" id="masterVolumeKnob">
                            <div class="knob-inner"></div>
                            <div class="tooltip">Master volume</div>
                            <div class="midi-learn-indicator">MIDI</div>
                        </div>
                        <input type="range" id="masterVolume" min="0" max="1" step="0.01" value="0.8">
                        <span class="knob-value" id="masterVolumeValue">80%</span>
                    </div>
                    
                    <div class="knob-container">
                        <label class="knob-label">Tempo</label>
                        <div class="knob" id="tempoKnob">
                            <div class="knob-inner"></div>
                            <div class="tooltip">Set BPM</div>
                            <div class="midi-learn-indicator">MIDI</div>
                        </div>
                        <input type="range" id="tempo" min="40" max="240" step="1" value="120">
                        <span class="knob-value" id="tempoValue">120 BPM</span>
                    </div>
                    
                    <div class="knob-container">
                        <label class="knob-label">Pan</label>
                        <div class="knob" id="panKnob">
                            <div class="knob-inner"></div>
                            <div class="tooltip">Stereo panning</div>
                            <div class="midi-learn-indicator">MIDI</div>
                        </div>
                        <input type="range" id="pan" min="-1" max="1" step="0.01" value="0">
                        <span class="knob-value" id="panValue">Center</span>
                    </div>
                    
                    <!-- Added master limiter control -->
                    <div class="knob-container">
                        <label class="knob-label">Limiter</label>
                        <div class="knob" id="limiterKnob">
                            <div class="knob-inner"></div>
                            <div class="tooltip">Output limiting</div>
                            <div class="midi-learn-indicator">MIDI</div>
                        </div>
                        <input type="range" id="limiter" min="0" max="1" step="0.01" value="0.3">
                        <span class="knob-value" id="limiterValue">30%</span>
                    </div>
                </div>
                
                <div class="submodule">
                    <div class="submodule-header">
                        <div class="submodule-title">
                            <i class="fas fa-cog"></i>
                            Performance
                        </div>
                    </div>
                    
                    <div class="arp-settings">
                        <div class="select-container">
                            <label class="select-label">Arpeggiator</label>
                            <select id="arpMode">
                                <option value="off">Off</option>
                                <option value="up">Up</option>
                                <option value="down">Down</option>
                                <option value="updown">Up/Down</option>
                                <option value="random">Random</option>
                                <option value="pattern">Pattern</option>
                                <option value="chord">Chord</option>
                            </select>
                        </div>
                        
                        <div class="select-container">
                            <label class="select-label">Octaves</label>
                            <select id="arpOctaves">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                        
                        <div class="knob-container">
                            <label class="knob-label">Rate</label>
                            <div class="knob" id="arpRateKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Arpeggiator rate</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="arpRate" min="1" max="8" step="1" value="4">
                            <span class="knob-value" id="arpRateValue">1/4</span>
                        </div>
                        
                        <!-- Additional arpeggiator controls -->
                        <div class="knob-container">
                            <label class="knob-label">Gate</label>
                            <div class="knob" id="arpGateKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Note gate length</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="arpGate" min="0.1" max="1" step="0.01" value="0.5">
                            <span class="knob-value" id="arpGateValue">50%</span>
                        </div>
                    </div>
                </div>
                
                <div class="submodule">
                    <div class="submodule-header">
                        <div class="submodule-title">
                            <i class="fas fa-layer-group"></i>
                            Quick Chord
                        </div>
                    </div>
                    
                    <div class="chord-buttons">
                        <button class="chord-button" data-chord="major">Major</button>
                        <button class="chord-button" data-chord="minor">Minor</button>
                        <button class="chord-button" data-chord="dom7">Dom7</button>
                        <button class="chord-button" data-chord="maj7">Maj7</button>
                        <button class="chord-button" data-chord="min7">Min7</button>
                        <button class="chord-button" data-chord="sus4">Sus4</button>
                        <button class="chord-button" data-chord="dim">Dim</button>
                        <button class="chord-button" data-chord="aug">Aug</button>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="presets">
                <div class="preset-container">
                    <div class="preset-browser">
                        <div class="preset-categories">
                            <div class="preset-category active">
                                <i class="fas fa-star"></i> All Presets
                            </div>
                            <div class="preset-category">
                                <i class="fas fa-music"></i> Bass
                            </div>
                            <div class="preset-category">
                                <i class="fas fa-music"></i> Lead
                            </div>
                            <div class="preset-category">
                                <i class="fas fa-music"></i> Pad
                            </div>
                            <div class="preset-category">
                                <i class="fas fa-music"></i> Keys
                            </div>
                            <div class="preset-category">
                                <i class="fas fa-music"></i> Pluck
                            </div>
                            <div class="preset-category">
                                <i class="fas fa-music"></i> FX
                            </div>
                            <div class="preset-category">
                                <i class="fas fa-heart"></i> Favorites
                            </div>
                            <div class="preset-category">
                                <i class="fas fa-user"></i> User
                            </div>
                        </div>
                        
                        <div class="preset-list">
                            <div class="preset-item active">
                                <i class="fas fa-music"></i>
                                <span>Analog Dream</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Deep Submerged Bass</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Wobble Growl Bass</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Crystal Shimmer Lead</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Analog Razor Lead</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Quantum Drift Pad</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Ethereal Breath Pad</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Electric Memory Keys</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Glassy Pluck Keys</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Resonant Warp FX</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Sonic Disruptor FX</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Deep Bass</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Ethereal Pad</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Techno Pluck</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Retro Lead</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Ambient Texture</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Acid Bass</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Future Wobble</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Synthwave Lead</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Cosmic Pad</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>Dubstep Growl</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-music"></i>
                                <span>80s Keys</span>
                                <span class="author">System</span>
                            </div>
                            <div class="preset-item">
                                <i class="fas fa-heart"></i>
                                <span>Favorite Pluck</span>
                                <span class="author">User</span>
                            </div>                            
                        </div>
                    </div>
                    
                    <div class="preset-creator">
                        <input type="text" class="preset-name-input" placeholder="New preset name..." id="presetName">
                        <div class="preset-actions">
                            <button class="preset-action-btn save">
                                <i class="fas fa-save"></i>
                                <span>Save</span>
                            </button>
                            <button class="preset-action-btn">
                                <i class="fas fa-folder-open"></i>
                                <span>Import</span>
                            </button>
                            <button class="preset-action-btn delete">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="module sequencer-container">
            <div class="module-header">
                <h3 class="module-title">
                    <i class="fas fa-step-forward"></i>
                    Sequencer
                </h3>
                <div class="module-tabs">
                    <button class="module-tab active" data-tab="seq-pattern">Pattern</button>
                    <button class="module-tab" data-tab="seq-piano">Piano Roll</button>
                    <button class="module-tab" data-tab="seq-drums">Drum Pads</button>
                </div>
            </div>
            
            <div class="tab-content active" id="seq-pattern">
                <div class="sequencer" id="sequencer">
                    <!-- Steps will be generated by JavaScript -->
                </div>
                <div class="keyboard" id="keyboard">
                    <!-- Keys will be generated by JavaScript -->
                </div>
                
                <div class="keyboard-octave-control">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button class="octave-button" id="octaveDown">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="current-octave" id="currentOctave">C3</div>
                        <button class="octave-button" id="octaveUp">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    
                    <div class="chord-finder" id="chordFinder">Chord: C Major</div>
                </div>
            </div>
            
            <div class="tab-content" id="seq-piano">
                <div class="sequencer-grid" id="pianoRoll">
                    <!-- Grid will be generated by JavaScript -->
                    <div class="grid-row-labels">
                        <div class="grid-row-label">C4</div>
                        <div class="grid-row-label">B3</div>
                        <div class="grid-row-label">A3</div>
                        <div class="grid-row-label">G3</div>
                        <div class="grid-row-label">F3</div>
                        <div class="grid-row-label">E3</div>
                        <div class="grid-row-label">D3</div>
                        <div class="grid-row-label">C3</div>
                    </div>
                </div>
                
                <div class="master-controls" style="margin-top: 10px;">
                    <button class="master-button" id="clearAllNotes">
                        <i class="fas fa-trash-alt"></i>
                        <span>Clear</span>
                    </button>
                    <button class="master-button" id="randomizeNotes">
                        <i class="fas fa-random"></i>
                        <span>Randomize</span>
                    </button>
                    
                    <div class="spacer"></div>
                    
                    <select id="scaleType" style="padding: 6px 10px; border-radius: 6px; background: var(--surface-light); color: var(--text); border: none;">
                        <option value="none">No Scale</option>
                        <option value="major">Major</option>
                        <option value="minor">Minor</option>
                        <option value="pentatonic">Pentatonic</option>
                        <option value="blues">Blues</option>
                        <option value="dorian">Dorian</option>
                        <option value="phrygian">Phrygian</option>
                        <option value="lydian">Lydian</option>
                        <option value="mixolydian">Mixolydian</option>
                        <option value="aeolian">Aeolian</option>
                        <option value="locrian">Locrian</option>
                    </select>
                    <select id="scaleRoot" style="padding: 6px 10px; border-radius: 6px; background: var(--surface-light); color: var(--text); border: none; margin-left: 8px;">
                        <option value="C">C</option>
                        <option value="C#">C#</option>
                        <option value="D">D</option>
                        <option value="D#">D#</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="F#">F#</option>
                        <option value="G">G</option>
                        <option value="G#">G#</option>
                        <option value="A">A</option>
                        <option value="A#">A#</option>
                        <option value="B">B</option>
                    </select>
                </div>
                
                <!-- Piano roll note length/duration controls -->
                <div class="master-controls" style="margin-top: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-size: 0.8rem;">Note Length:</label>
                        <button class="pill-button active" data-length="1/16">1/16</button>
                        <button class="pill-button" data-length="1/8">1/8</button>
                        <button class="pill-button" data-length="1/4">1/4</button>
                        <button class="pill-button" data-length="1/2">1/2</button>
                        <button class="pill-button" data-length="1/1">1 Bar</button>
                    </div>
                    
                    <div class="spacer"></div>
                    
                    <button class="master-button" id="quantizeNotes">
                        <i class="fas fa-magic"></i>
                        <span>Quantize</span>
                    </button>
                </div>
            </div>
            
            <div class="tab-content" id="seq-drums">
                <div class="drum-pads" id="drumPads">
                    <button class="drum-pad" data-sound="kick">
                        <i class="fas fa-drum"></i>
                        <span class="drum-pad-label">Kick</span>
                        <span class="drum-pad-key">Q</span>
                    </button>
                    <button class="drum-pad" data-sound="snare">
                        <i class="fas fa-drum"></i>
                        <span class="drum-pad-label">Snare</span>
                        <span class="drum-pad-key">W</span>
                    </button>
                    <button class="drum-pad" data-sound="hihat">
                        <i class="fas fa-drum"></i>
                        <span class="drum-pad-label">Hi-Hat</span>
                        <span class="drum-pad-key">E</span>
                    </button>
                    <button class="drum-pad" data-sound="clap">
                        <i class="fas fa-drum"></i>
                        <span class="drum-pad-label">Clap</span>
                        <span class="drum-pad-key">R</span>
                    </button>
                    <button class="drum-pad" data-sound="tom1">
                        <i class="fas fa-drum"></i>
                        <span class="drum-pad-label">Tom 1</span>
                        <span class="drum-pad-key">A</span>
                    </button>
                    <button class="drum-pad" data-sound="tom2">
                        <i class="fas fa-drum"></i>
                        <span class="drum-pad-label">Tom 2</span>
                        <span class="drum-pad-key">S</span>
                    </button>
                    <button class="drum-pad" data-sound="crash">
                        <i class="fas fa-drum"></i>
                        <span class="drum-pad-label">Crash</span>
                        <span class="drum-pad-key">D</span>
                    </button>
                    <button class="drum-pad" data-sound="ride">
                        <i class="fas fa-drum"></i>
                        <span class="drum-pad-label">Ride</span>
                        <span class="drum-pad-key">F</span>
                    </button>
                </div>
                
                <div class="mic-input">
                    <button class="mic-button" id="micRecordButton">
                        <i class="fas fa-microphone"></i>
                        <span>Record Input</span>
                    </button>
                    <div class="mic-level">
                        <div class="mic-level-fill" id="micLevel"></div>
                    </div>
                </div>
                
                <div class="record-controls">
                    <button class="record-button record" id="recordDrumButton">
                        <i class="fas fa-circle"></i>
                        Record
                    </button>
                    <button class="record-button stop" id="stopRecordButton">
                        <i class="fas fa-stop"></i>
                        Stop
                    </button>
                    <div class="record-time" id="recordTime">00:00.000</div>
                    <button class="record-button play" id="playRecordButton">
                        <i class="fas fa-play"></i>
                        Play
                    </button>
                </div>
                
                <div class="sample-zones">
                    <div class="sample-zone">
                        <div class="sample-zone-header">
                            <div class="sample-zone-title">
                                <i class="fas fa-file-audio"></i>
                                Sample Slot 1
                            </div>
                            <div class="sample-zone-controls">
                                <button class="sample-zone-button">
                                    <i class="fas fa-folder-open"></i>
                                </button>
                                <button class="sample-zone-button">
                                    <i class="fas fa-play"></i>
                                </button>
                            </div>
                        </div>
                        <div class="sample-waveform">
                            <svg class="sample-waveform-display" id="sampleWaveform1" viewBox="0 0 100 40" preserveAspectRatio="none">
                                <path d="M0,20 Q10,5 20,20 T40,20 T60,20 T80,20 T100,20" stroke="var(--secondary)" stroke-width="2" fill="none"/>
                                <path d="M0,20 Q10,35 20,20 T40,20 T60,20 T80,20 T100,20" stroke="var(--secondary)" stroke-width="2" fill="none" opacity="0.5"/>
                            </svg>
                        </div>
                        <div class="sample-status">
                            <span>No sample loaded</span>
                            <span class="sample-duration">0.00s</span>
                        </div>
                    </div>
                    
                    <div class="sample-zone">
                        <div class="sample-zone-header">
                            <div class="sample-zone-title">
                                <i class="fas fa-file-audio"></i>
                                Sample Slot 2
                            </div>
                            <div class="sample-zone-controls">
                                <button class="sample-zone-button">
                                    <i class="fas fa-folder-open"></i>
                                </button>
                                <button class="sample-zone-button">
                                    <i class="fas fa-play"></i>
                                </button>
                            </div>
                        </div>
                        <div class="sample-waveform">
                            <svg class="sample-waveform-display" id="sampleWaveform2" viewBox="0 0 100 40" preserveAspectRatio="none">
                                <!-- Empty until sample is loaded -->
                            </svg>
                        </div>
                        <div class="sample-status">
                            <span>No sample loaded</span>
                            <span class="sample-duration">0.00s</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="module" src="./js/main2.js"></script>
    <script>
        // Global audio engine variables
        let audioInitialized = false;
        let mainSynth;
        let mainFilter;
        let filterEnvelope;
        let filterEnvScale; // Added for filter envelope modulation
        let ampEnvelope;
        let lfo1, lfo2;
        let reverb, delay, distortion;
        let masterVolNode;
        let analyzer;
        let masterLimiter; // Make sure this is declared globally
        
        // Sequencer and pattern state
        let isPlaying = false;
        let currentStep = 0;
        let sequencerPattern = [];
        let sequencerInterval;
        
        // Voice tracking
        let activeVoices = new Map();
        let activeNotes = new Set();
        
        // MIDI learn state
        let midiLearnActive = false;
        let midiLearnTarget = null;
        let midiMappings = new Map();

        // Presets storage
        let userPresets = [];
        let currentPreset = null;
        
        // Initialize audio engine on first user interaction
        function initAudio() {
            if (audioInitialized) return Promise.resolve();
            
            return Tone.start().then(() => {
                console.log("Audio context started!");
                
                // Set up main audio components
                mainFilter = new Tone.Filter({
                    type: "lowpass",
                    frequency: 2000,
                    Q: 2,
                    rolloff: -24
                });
                
                // Fix 1: Properly set up filter envelope
                filterEnvelope = new Tone.Envelope({
                    attack: parseFloat(document.getElementById('env2Attack').value),
                    decay: parseFloat(document.getElementById('env2Decay').value),
                    sustain: parseFloat(document.getElementById('env2Sustain').value),
                    release: parseFloat(document.getElementById('env2Release').value)
                });
                
                // Create a scale object to handle the envelope amount
                const envAmount = parseInt(document.getElementById('filter1Env').value);
                filterEnvScale = new Tone.Scale(-5000, 5000); // Scale range for filter modulation
                filterEnvelope.connect(filterEnvScale);
                filterEnvScale.connect(mainFilter.frequency);
                
                ampEnvelope = new Tone.Envelope({
                    attack: parseFloat(document.getElementById('env1Attack').value),
                    decay: parseFloat(document.getElementById('env1Decay').value),
                    sustain: parseFloat(document.getElementById('env1Sustain').value),
                    release: parseFloat(document.getElementById('env1Release').value)
                });
                
                // Create effects
                reverb = new Tone.Reverb({
                    decay: 2.0,
                    wet: 0.3,
                    preDelay: 0.02
                });
                
                delay = new Tone.FeedbackDelay({
                    delayTime: 0.3,
                    feedback: 0.4,
                    wet: 0.3
                });
                
                distortion = new Tone.Distortion({
                    distortion: 0.4,
                    wet: 0
                });
                
                // Create master volume and limiter
                masterLimiter = new Tone.Limiter(-0.5);
                masterVolNode = new Tone.Gain(0.8);
                
                // Create LFOs with expanded features
                lfo1 = new Tone.LFO({
                    frequency: 5,
                    amplitude: 0.5,
                    type: "sine"
                });
                
                lfo2 = new Tone.LFO({
                    frequency: 2,
                    amplitude: 0.3,
                    type: "triangle",
                    phase: 90
                });
                
                // Create analyzer for visualization
                analyzer = new Tone.Analyser("waveform", 1024);
                
                // Signal path: Synth -> Filter -> Effects -> Master Volume -> Limiter -> Output
                reverb.connect(delay);
                delay.connect(distortion);
                distortion.connect(masterVolNode);
                masterVolNode.connect(masterLimiter);
                masterLimiter.toDestination();
                
                // Connect analyzer
                masterVolNode.connect(analyzer);
                
                // Create polyphonic synth with multiple oscillators
                createMainSynth();
                
                // Start LFOs
                lfo1.start();
                lfo2.start();
                
                // Wait for reverb to initialize
                return reverb.generate();
            }).then(() => {
                // Create sequencer pattern
                initSequencerPattern();
                
                // Initialize vizualizations
                setupVisualizers();
                
                // Mark as initialized
                audioInitialized = true;
                
                document.getElementById('voiceCount').textContent = "0";
                showNotification('success', 'Audio engine initialized successfully!');
            }).catch(err => {
                console.error("Could not initialize audio:", err);
                showNotification('error', 'Failed to initialize audio. Please try again.');
            });
        }
        
        function createMainSynth() {
            // Create a multi-oscillator polyphonic synth
            mainSynth = new Tone.PolySynth({
                maxPolyphony: 32,
                voice: Tone.Synth
            });
            
            // Configure the voice options for multiple oscillators
            mainSynth.set({
                oscillator: {
                    type: "sine"
                },
                envelope: {
                    attack: 0.01,
                    decay: 0.2,
                    sustain: 0.7,
                    release: 0.5
                }
            });
            
            // Connect to signal chain
            mainSynth.connect(mainFilter);
            mainFilter.connect(reverb);
            
            // Apply initial settings
            updateSynthFromUI();
        }
        
        function updateSynthFromUI() {
            // Handle all oscillators
            updateOscillator(1);
            updateOscillator(2);
            updateOscillator(3);
            
            // Update envelopes
            updateEnvelopes();
            
            // Update filter
            updateFilter();
            
            // Update effects
            updateEffects();
            
            // Update master section
            updateMaster();
        }
        
        function updateOscillator(oscNum) {
            const active = document.getElementById(`osc${oscNum}Active`).checked;
            const type = document.getElementById(`osc${oscNum}Type`).value;
            const octave = parseInt(document.getElementById(`osc${oscNum}Octave`).value);
            const semi = parseInt(document.getElementById(`osc${oscNum}Semi`).value);
            const detune = parseInt(document.getElementById(`osc${oscNum}Detune`).value);
            const level = parseFloat(document.getElementById(`osc${oscNum}Level`).value);
            
            // Apply settings to the oscillator
            if (oscNum === 1) {
                // OSC 1 is the main oscillator
                mainSynth.set({
                    oscillator: {
                        type: type
                    }
                });
            }
            // In a full implementation, additional oscillators would be handled here
        }
        
        function updateEnvelopes() {
            // Amplitude envelope
            const attack1 = parseFloat(document.getElementById('env1Attack').value);
            const decay1 = parseFloat(document.getElementById('env1Decay').value);
            const sustain1 = parseFloat(document.getElementById('env1Sustain').value);
            const release1 = parseFloat(document.getElementById('env1Release').value);
            
            mainSynth.set({
                envelope: {
                    attack: attack1,
                    decay: decay1,
                    sustain: sustain1,
                    release: release1
                }
            });
            
            // Fix 1: Filter envelope - properly update the envelope
            const attack2 = parseFloat(document.getElementById('env2Attack').value);
            const decay2 = parseFloat(document.getElementById('env2Decay').value);
            const sustain2 = parseFloat(document.getElementById('env2Sustain').value);
            const release2 = parseFloat(document.getElementById('env2Release').value);
            
            if (filterEnvelope) {
                filterEnvelope.attack = attack2;
                filterEnvelope.decay = decay2;
                filterEnvelope.sustain = sustain2;
                filterEnvelope.release = release2;
                
                // Update filter envelope amount
                const envAmount = parseInt(document.getElementById('filter1Env').value);
                if (filterEnvScale) {
                    filterEnvScale.max = envAmount >= 0 ? envAmount * 50 : 0;
                    filterEnvScale.min = envAmount < 0 ? envAmount * 50 : 0;
                }
            }
        }
        
        function updateFilter() {
            // Update Filter
            const filterType = document.getElementById('filter1Type').value;
            const cutoff = parseFloat(document.getElementById('filter1Cutoff').value);
            const resonance = parseFloat(document.getElementById('filter1Res').value);
            
            if (mainFilter) {
                mainFilter.type = filterType;
                mainFilter.frequency.value = cutoff;
                mainFilter.Q.value = resonance;
            }
        }
        
        function updateEffects() {
            // Update reverb
            const reverbMix = parseFloat(document.getElementById('reverbMix').value);
            const reverbDecay = parseFloat(document.getElementById('reverbDecay').value);
            const reverbDamping = parseFloat(document.getElementById('reverbDamping').value);
            
            if (reverb) {
                reverb.wet.value = reverbMix;
                if (reverb.decay !== reverbDecay) {
                    reverb.decay = reverbDecay;
                    reverb.generate(); // This would regenerate the impulse response
                }
            }
            
            // Update delay
            const delayTime = parseFloat(document.getElementById('delayTime').value);
            const delayFeedback = parseFloat(document.getElementById('delayFeedback').value);
            const delayMix = parseFloat(document.getElementById('delayMix').value);
            
            if (delay) {
                delay.delayTime.value = delayTime;
                delay.feedback.value = delayFeedback;
                delay.wet.value = delayMix;
            }
            
            // Update distortion
            const distortionAmount = parseFloat(document.getElementById('distortionAmount').value);
            const distortionMix = parseFloat(document.getElementById('distortionMix').value);
            
            if (distortion) {
                distortion.distortion = distortionAmount;
                distortion.wet.value = distortionMix;
            }
        }
        
        function updateMaster() {
            // Update master volume
            const masterVol = parseFloat(document.getElementById('masterVolume').value);
            if (masterVolNode) {
                masterVolNode.gain.value = masterVol;
            }
            
            // Update master limiter
            const limiterThreshold = parseFloat(document.getElementById('limiter').value) * -50;
            if (masterLimiter) {
                masterLimiter.threshold.value = limiterThreshold;
            }
            
            // Update tempo
            const tempo = parseInt(document.getElementById('tempo').value);
            Tone.Transport.bpm.value = tempo;
        }
        
        function initSequencerPattern() {
            // Initialize sequencer pattern from UI
            sequencerPattern = [];
            
            document.querySelectorAll('.step').forEach((step, index) => {
                const noteSelect = step.querySelector('select');
                const toggleButton = step.querySelector('.step-button');
                
                sequencerPattern.push({
                    note: noteSelect ? noteSelect.value : 'C3',
                    active: toggleButton ? toggleButton.classList.contains('active') : false,
                    velocity: 0.75, // Default velocity
                    probability: 1.0 // Default probability (100%)
                });
                
                // Add event listeners to update pattern when UI changes
                if (noteSelect) {
                    noteSelect.addEventListener('change', () => {
                        sequencerPattern[index].note = noteSelect.value;
                    });
                }
                
                if (toggleButton) {
                    toggleButton.addEventListener('click', () => {
                        toggleButton.classList.toggle('active');
                        sequencerPattern[index].active = toggleButton.classList.contains('active');
                    });
                }
            });
        }
        
        // Initialize tab switching and other UI components
        document.addEventListener('DOMContentLoaded', function() {
            // Tab switching functionality
            document.querySelectorAll('.module-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Get the parent module
                    const module = this.closest('.module');
                    
                    // Remove active class from all tabs in this module
                    module.querySelectorAll('.module-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Get the target content id
                    const targetId = this.getAttribute('data-tab');
                    
                    // Hide all tab content in this module
                    module.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Show the target content
                    module.querySelector(`#${targetId}`).classList.add('active');
                });
            });
            
            // Setup knob control functionality with MIDI learn
            document.querySelectorAll('.knob').forEach(knob => {
                setupKnob(knob);
                
                knob.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    startMIDILearn(knob);
                });
            });
            
            // Generate sequencer steps
            createSequencer();
            
            // Generate keyboard
            createKeyboard();
            
            // Setup piano roll grid
            setupPianoRoll();
            
            // Show the shortcuts modal when the help button is clicked
            document.getElementById('helpButton').addEventListener('click', function() {
                document.getElementById('shortcutsModal').classList.add('active');
            });
            
            // Close the shortcuts modal
            document.getElementById('closeShortcutsModal').addEventListener('click', function() {
                document.getElementById('shortcutsModal').classList.remove('active');
            });
            
            document.getElementById('closeShortcutsBtn').addEventListener('click', function() {
                document.getElementById('shortcutsModal').classList.remove('active');
            });

            // Setup start/stop button
            document.getElementById('startSequencer').addEventListener('click', function() {
                // Initialize audio on first click
                initAudio().then(() => {
                    toggleSequencer();
                });
            });
            
            // Setup share button
            document.getElementById('shareButton').addEventListener('click', function() {
                document.getElementById('shareModal').classList.add('active');
            });
            
            // Close share modal
            document.getElementById('closeShareModal').addEventListener('click', function() {
                document.getElementById('shareModal').classList.remove('active');
            });
            
            document.getElementById('closeShareBtn').addEventListener('click', function() {
                document.getElementById('shareModal').classList.remove('active');
            });
            
            // Copy link button
            document.getElementById('copyLinkBtn').addEventListener('click', function() {
                const linkInput = document.getElementById('shareLink');
                linkInput.select();
                document.execCommand('copy');
                showNotification('success', 'Link copied to clipboard!');
            });
            
            // Export button
            document.getElementById('exportBtn').addEventListener('click', function() {
                const format = document.getElementById('exportFormat').value;
                exportSynthState(format);
            });
            
            // MIDI Learn button
            document.getElementById('midiLearnButton').addEventListener('click', function() {
                if (midiLearnActive) {
                    stopMIDILearn();
                } else {
                    document.getElementById('midiLearnModal').classList.add('active');
                    startGlobalMIDILearn();
                }
            });
            
            // Close MIDI Learn modal
            document.getElementById('closeMidiLearnModal').addEventListener('click', function() {
                document.getElementById('midiLearnModal').classList.remove('active');
                stopMIDILearn();
            });
            
            // Save MIDI mappings
            document.getElementById('saveMidiMappingsBtn').addEventListener('click', function() {
                document.getElementById('midiLearnModal').classList.remove('active');
                stopMIDILearn();
                showNotification('success', 'MIDI mappings saved successfully!');
            });
            
            // Clear all MIDI mappings
            document.getElementById('clearAllMappingsBtn').addEventListener('click', function() {
                clearAllMIDIMappings();
                showNotification('info', 'All MIDI mappings cleared');
            });
            
            // Add Effect menu
            document.getElementById('openEffectsMenu').addEventListener('click', function() {
                const dropdown = document.getElementById('addEffectDropdown');
                dropdown.classList.toggle('open');
            });
            
            // Effect options
            document.querySelectorAll('.effect-option').forEach(option => {
                option.addEventListener('click', function() {
                    const effectType = this.getAttribute('data-effect');
                    addEffect(effectType);
                    document.getElementById('addEffectDropdown').classList.remove('open');
                });
            });
            
            // Fix 3: Preset functionality
            setupPresetFunctionality();
            
            // Show welcome notification
            setTimeout(function() {
                showNotification('success', 'Synth XR Ultimate loaded successfully!');
                showNotification('info', 'Click or tap any control to initialize audio');
            }, 1000);
            
            // Initialize modulation matrix listeners
            document.getElementById('addModConnection').addEventListener('click', addModConnection);
            
            // Set up MIDI input
            setupMIDI();
            
            // Set up piano roll handlers
            setupPianoRollHandlers();
            
            // Set up keyboard shortcuts
            setupKeyboardShortcuts();
            
            // Initialize event listeners for all interactive elements
            setupAudioControls();
            
            // Setup parameter display on hover
            setupParameterDisplay();
            
            // Setup effects reordering
            setupEffectsReordering();
            
            // Setup sequencer UI
            setupSequencerUI();

            // Load saved presets from localStorage if available
            loadUserPresets();
        });
        
        function setupPresetFunctionality() {
            // Load presets
            document.querySelectorAll('.preset-item').forEach(preset => {
                preset.addEventListener('click', function() {
                    // Remove active class from all presets
                    document.querySelectorAll('.preset-item').forEach(p => {
                        p.classList.remove('active');
                    });
                    
                    // Add active class to this preset
                    this.classList.add('active');
                    
                    // Get preset name and load it
                    const presetName = this.querySelector('span').textContent;
                    loadPreset(presetName);
                });
            });
            
            // Save preset button
            document.querySelector('.preset-action-btn.save').addEventListener('click', function() {
                const presetName = document.getElementById('presetName').value.trim();
                
                if (presetName) {
                    savePreset(presetName);
                } else {
                    showNotification('error', 'Please enter a preset name');
                }
            });
            
            // Delete preset button
            document.querySelector('.preset-action-btn.delete').addEventListener('click', function() {
                const activePreset = document.querySelector('.preset-item.active');
                
                if (activePreset) {
                    const presetName = activePreset.querySelector('span').textContent;
                    deletePreset(presetName);
                } else {
                    showNotification('error', 'Select a preset to delete');
                }
            });
            
            // Preset category selection
            document.querySelectorAll('.preset-category').forEach(category => {
                category.addEventListener('click', function() {
                    // Remove active class from all categories
                    document.querySelectorAll('.preset-category').forEach(c => {
                        c.classList.remove('active');
                    });
                    
                    // Add active class to this category
                    this.classList.add('active');
                    
                    // Filter presets by category
                    const categoryName = this.textContent.trim();
                    filterPresetsByCategory(categoryName);
                });
            });

            // Call updatePresetList to set up categories
            updatePresetList();
        }
        
        function loadUserPresets() {
            try {
                const savedPresets = localStorage.getItem('synthxr_user_presets');
                if (savedPresets) {
                    userPresets = JSON.parse(savedPresets);
                    
                    // Update preset list with user presets
                    updatePresetList();
                }
            } catch (error) {
                console.error('Failed to load user presets:', error);
            }
        }
        
        function saveUserPresets() {
            try {
                localStorage.setItem('synthxr_user_presets', JSON.stringify(userPresets));
            } catch (error) {
                console.error('Failed to save user presets:', error);
                showNotification('error', 'Failed to save presets');
            }
        }
        
        function updatePresetList() {
            const presetList = document.querySelector('.preset-list');
            
            // Clear any existing user presets
            const userPresetItems = presetList.querySelectorAll('.preset-item[data-user="true"]');
            userPresetItems.forEach(item => item.remove());
            
            // Add user presets
            userPresets.forEach(preset => {
                const presetItem = document.createElement('div');
                presetItem.className = 'preset-item';
                presetItem.setAttribute('data-user', 'true');
                presetItem.setAttribute('data-category', preset.category || 'User');
                
                presetItem.innerHTML = `
                    <i class="fas fa-user"></i>
                    <span>${preset.name}</span>
                    <span class="author">User</span>
                `;
                
                presetItem.addEventListener('click', function() {
                    // Remove active class from all presets
                    document.querySelectorAll('.preset-item').forEach(p => {
                        p.classList.remove('active');
                    });
                    
                    // Add active class to this preset
                    this.classList.add('active');
                    
                    // Load this preset
                    loadPreset(preset.name);
                });
                
                presetList.appendChild(presetItem);
            });
        }
        
        function savePreset(name) {
            if (!audioInitialized) {
                initAudio().then(() => {
                    performSavePreset(name);
                });
            } else {
                performSavePreset(name);
            }
        }
        
        function performSavePreset(name) {
            // Collect current synth state
            const presetData = getCurrentSynthState();
            
            // Check if preset with this name already exists
            const existingIndex = userPresets.findIndex(p => p.name === name);
            
            if (existingIndex >= 0) {
                // Update existing preset
                userPresets[existingIndex] = presetData;
                showNotification('success', `Updated preset: ${name}`);
            } else {
                // Add new preset
                userPresets.push(presetData);
                showNotification('success', `Saved preset: ${name}`);
            }
            
            // Save to localStorage
            saveUserPresets();
            
            // Update UI
            updatePresetList();
            
            // Clear preset name input
            document.getElementById('presetName').value = '';
        }
        
        function loadPreset(name) {
            // Check for built-in presets
            const builtInPreset = getBuiltInPreset(name);
            
            if (builtInPreset) {
                applyPreset(builtInPreset);
                showNotification('info', `Loaded preset: ${name}`);
            } else {
                // Look for user preset
                const userPreset = userPresets.find(p => p.name === name);
                
                if (userPreset) {
                    applyPreset(userPreset);
                    showNotification('info', `Loaded preset: ${name}`);
                } else {
                    showNotification('error', `Preset not found: ${name}`);
                }
            }
        }
        
        function deletePreset(name) {
            // Only delete user presets, not built-in ones
            const userPresetIndex = userPresets.findIndex(p => p.name === name);
            
            if (userPresetIndex >= 0) {
                userPresets.splice(userPresetIndex, 1);
                saveUserPresets();
                updatePresetList();
                showNotification('info', `Deleted preset: ${name}`);
            } else {
                showNotification('error', 'Can only delete user presets');
            }
        }
        

        function filterPresetsByCategory(category) {
            const presetItems = document.querySelectorAll('.preset-item');
            
            // Normalize the category by removing the icon
            const cleanCategory = category.replace(/^\s*\<i[^>]*\>[^<]*<\/i>\s*/, '').trim();
            
            switch(cleanCategory) {
                case 'All Presets':
                    // Show all presets
                    presetItems.forEach(item => {
                        item.style.display = '';
                    });
                    break;
                
                case 'User':
                    // Show only user presets
                    presetItems.forEach(item => {
                        if (item.getAttribute('data-user') === 'true') {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                    break;
                
                case 'Favorites':
                    // Show only favorite presets
                    presetItems.forEach(item => {
                        if (item.querySelector('.fas.fa-heart')) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                    break;
                
                default:
                    // Filter by specific category (Bass, Lead, Pad, etc.)
                    presetItems.forEach(item => {
                        // Check if the item has a data-category matching the selected category
                        const itemCategory = item.getAttribute('data-category');
                        
                        if (itemCategory === cleanCategory) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                    break;
            }
        }

        // Modify preset list generation to add category attributes
        function updatePresetList() {
            const presetList = document.querySelector('.preset-list');
            
            // Clear any existing user presets
            const userPresetItems = presetList.querySelectorAll('.preset-item[data-user="true"]');
            userPresetItems.forEach(item => item.remove());
            
            // Add user presets
            userPresets.forEach(preset => {
                const presetItem = document.createElement('div');
                presetItem.className = 'preset-item';
                presetItem.setAttribute('data-user', 'true');
                presetItem.setAttribute('data-category', preset.category || 'User');
                
                presetItem.innerHTML = `
                    <i class="fas fa-user"></i>
                    <span>${preset.name}</span>
                    <span class="author">User</span>
                `;
                
                presetItem.addEventListener('click', function() {
                    // Remove active class from all presets
                    document.querySelectorAll('.preset-item').forEach(p => {
                        p.classList.remove('active');
                    });
                    
                    // Add active class to this preset
                    this.classList.add('active');
                    
                    // Load this preset
                    loadPreset(preset.name);
                });
                
                presetList.appendChild(presetItem);
            });
            
            // Add category attribute to built-in presets
            document.querySelectorAll('.preset-item:not([data-user])').forEach(item => {
                const presetName = item.querySelector('span').textContent;
                const preset = getBuiltInPreset(presetName);
                
                if (preset && preset.category) {
                    item.setAttribute('data-category', preset.category);
                }
            });
        }        

        function getCurrentSynthState() {
            // Similar to the exportSynthState function, but returns the data instead
            return {
                name: document.getElementById('presetName').value || "Untitled Preset",
                category: "User",
                date: new Date().toISOString(),
                
                oscillators: {
                    osc1: {
                        type: document.getElementById('osc1Type').value,
                        active: document.getElementById('osc1Active').checked,
                        octave: parseInt(document.getElementById('osc1Octave').value),
                        semi: parseInt(document.getElementById('osc1Semi').value),
                        detune: parseInt(document.getElementById('osc1Detune').value),
                        level: parseFloat(document.getElementById('osc1Level').value),
                        fmAmount: parseInt(document.getElementById('osc1FMAmount').value),
                        fmRatio: parseFloat(document.getElementById('osc1FMRatio').value)
                    },
                    osc2: {
                        type: document.getElementById('osc2Type').value,
                        active: document.getElementById('osc2Active').checked,
                        octave: parseInt(document.getElementById('osc2Octave').value),
                        semi: parseInt(document.getElementById('osc2Semi').value),
                        detune: parseInt(document.getElementById('osc2Detune').value),
                        level: parseFloat(document.getElementById('osc2Level').value),
                        sync: document.getElementById('osc2Sync').checked,
                        syncAmount: parseInt(document.getElementById('osc2SyncAmount').value)
                    },
                    osc3: {
                        type: document.getElementById('osc3Type').value,
                        active: document.getElementById('osc3Active').checked,
                        octave: parseInt(document.getElementById('osc3Octave').value),
                        semi: parseInt(document.getElementById('osc3Semi').value),
                        detune: parseInt(document.getElementById('osc3Detune').value),
                        level: parseFloat(document.getElementById('osc3Level').value),
                        ringMod: document.getElementById('osc3RingMod').checked,
                        ringModSource: document.getElementById('osc3RingModSource').value
                    }
                },
                
                filter: {
                    type: document.getElementById('filter1Type').value,
                    slope: parseInt(document.getElementById('filter1Slope').value),
                    cutoff: parseInt(document.getElementById('filter1Cutoff').value),
                    resonance: parseFloat(document.getElementById('filter1Res').value),
                    envAmount: parseInt(document.getElementById('filter1Env').value),
                    keyTrack: parseInt(document.getElementById('filter1KeyTrack').value)
                },
                
                envelopes: {
                    amp: {
                        attack: parseFloat(document.getElementById('env1Attack').value),
                        decay: parseFloat(document.getElementById('env1Decay').value),
                        sustain: parseFloat(document.getElementById('env1Sustain').value),
                        release: parseFloat(document.getElementById('env1Release').value)
                    },
                    filter: {
                        attack: parseFloat(document.getElementById('env2Attack').value),
                        decay: parseFloat(document.getElementById('env2Decay').value),
                        sustain: parseFloat(document.getElementById('env2Sustain').value),
                        release: parseFloat(document.getElementById('env2Release').value)
                    }
                },
                
                effects: {
                    reverb: {
                        mix: parseFloat(document.getElementById('reverbMix').value),
                        decay: parseFloat(document.getElementById('reverbDecay').value)
                    },
                    delay: {
                        mix: parseFloat(document.getElementById('delayMix').value),
                        time: parseFloat(document.getElementById('delayTime').value),
                        feedback: parseFloat(document.getElementById('delayFeedback').value)
                    }
                },
                
                master: {
                    volume: parseFloat(document.getElementById('masterVolume').value)
                }
            };
        }
        
        function applyPreset(preset) {
            if (!audioInitialized) {
                initAudio().then(() => {
                    performApplyPreset(preset);
                });
            } else {
                performApplyPreset(preset);
            }
        }
        
        function performApplyPreset(preset) {
            
            // Apply oscillator settings
            if (preset.oscillators) {
                const osc1 = preset.oscillators.osc1;
                if (osc1) {
                    setSelectValue('osc1Type', osc1.type);
                    setCheckbox('osc1Active', osc1.active);
                    setRangeValue('osc1Octave', osc1.octave);
                    setRangeValue('osc1Semi', osc1.semi);
                    setRangeValue('osc1Detune', osc1.detune);
                    setRangeValue('osc1Level', osc1.level);
                    if (osc1.fmAmount !== undefined) setRangeValue('osc1FMAmount', osc1.fmAmount);
                    if (osc1.fmRatio !== undefined) setRangeValue('osc1FMRatio', osc1.fmRatio);
                }
                
                const osc2 = preset.oscillators.osc2;
                if (osc2) {
                    setSelectValue('osc2Type', osc2.type);
                    setCheckbox('osc2Active', osc2.active);
                    setRangeValue('osc2Octave', osc2.octave);
                    setRangeValue('osc2Semi', osc2.semi);
                    setRangeValue('osc2Detune', osc2.detune);
                    setRangeValue('osc2Level', osc2.level);
                    if (osc2.sync !== undefined) setCheckbox('osc2Sync', osc2.sync);
                    if (osc2.syncAmount !== undefined) setRangeValue('osc2SyncAmount', osc2.syncAmount);
                }
                
                const osc3 = preset.oscillators.osc3;
                if (osc3) {
                    setSelectValue('osc3Type', osc3.type);
                    setCheckbox('osc3Active', osc3.active);
                    setRangeValue('osc3Octave', osc3.octave);
                    setRangeValue('osc3Semi', osc3.semi);
                    setRangeValue('osc3Detune', osc3.detune);
                    setRangeValue('osc3Level', osc3.level);
                    if (osc3.ringMod !== undefined) setCheckbox('osc3RingMod', osc3.ringMod);
                    if (osc3.ringModSource !== undefined) setSelectValue('osc3RingModSource', osc3.ringModSource);
                }
            }
            
            // Apply filter settings
            if (preset.filter) {
                setSelectValue('filter1Type', preset.filter.type);
                setSelectValue('filter1Slope', preset.filter.slope);
                setRangeValue('filter1Cutoff', preset.filter.cutoff);
                setRangeValue('filter1Res', preset.filter.resonance);
                setRangeValue('filter1Env', preset.filter.envAmount);
                setRangeValue('filter1KeyTrack', preset.filter.keyTrack);
            }
            
            // Apply envelope settings
            if (preset.envelopes) {
                if (preset.envelopes.amp) {
                    setRangeValue('env1Attack', preset.envelopes.amp.attack);
                    setRangeValue('env1Decay', preset.envelopes.amp.decay);
                    setRangeValue('env1Sustain', preset.envelopes.amp.sustain);
                    setRangeValue('env1Release', preset.envelopes.amp.release);
                }
                
                if (preset.envelopes.filter) {
                    setRangeValue('env2Attack', preset.envelopes.filter.attack);
                    setRangeValue('env2Decay', preset.envelopes.filter.decay);
                    setRangeValue('env2Sustain', preset.envelopes.filter.sustain);
                    setRangeValue('env2Release', preset.envelopes.filter.release);
                }
            }
            
            // Apply effect settings
            if (preset.effects) {
                if (preset.effects.reverb) {
                    setRangeValue('reverbMix', preset.effects.reverb.mix);
                    setRangeValue('reverbDecay', preset.effects.reverb.decay);
                }
                
                if (preset.effects.delay) {
                    setRangeValue('delayMix', preset.effects.delay.mix);
                    setRangeValue('delayTime', preset.effects.delay.time);
                    setRangeValue('delayFeedback', preset.effects.delay.feedback);
                }
            }
            
            // Apply master settings
            if (preset.master) {
                if (preset.master.volume !== undefined) setRangeValue('masterVolume', preset.master.volume);
            }
            
            // Update synth parameters
            if (audioInitialized) {
                updateSynthFromUI();
            }
            
            // Store current preset
            currentPreset = preset.name;
        }
        
        // Helper functions for applying presets
        function setSelectValue(id, value) {
            const select = document.getElementById(id);
            if (select && value !== undefined) {
                select.value = value;
                select.dispatchEvent(new Event('change'));
            }
        }
        
        function setCheckbox(id, value) {
            const checkbox = document.getElementById(id);
            if (checkbox && value !== undefined) {
                checkbox.checked = value;
                checkbox.dispatchEvent(new Event('change'));
            }
        }
        
        function setRangeValue(id, value) {
            const range = document.getElementById(id);
            if (range && value !== undefined) {
                range.value = value;
                range.dispatchEvent(new Event('input'));
            }
        }
        
        function getBuiltInPreset(name) {
            const builtInPresets = {
                'Deep Submerged Bass': {
                    name: 'Deep Submerged Bass',
                    category: 'Bass',
                    oscillators: {
                        osc1: { type: 'fatsawtooth', active: true, octave: -2, semi: 0, detune: 0, level: 1 },
                        osc2: { type: 'sine', active: true, octave: -2, semi: -12, detune: 5, level: 0.6 },
                        osc3: { type: 'fmsine', active: true, octave: -3, semi: 0, detune: -5, level: 0.3 }
                    },
                    filter: { type: 'lowpass', cutoff: 400, resonance: 4, envAmount: 50 },
                    envelopes: {
                        amp: { attack: 0.01, decay: 0.3, sustain: 0.7, release: 0.3 },
                        filter: { attack: 0.05, decay: 0.2, sustain: 0.4, release: 0.2 }
                    },
                    effects: {
                        reverb: { mix: 0.1, decay: 1 },
                        delay: { mix: 0.2, time: 0.15, feedback: 0.4 }
                    }
                },
                'Wobble Growl Bass': {
                    name: 'Wobble Growl Bass',
                    category: 'Bass',
                    oscillators: {
                        osc1: { type: 'fatsawtooth', active: true, octave: -1, semi: 0, detune: 0, level: 1 },
                        osc2: { type: 'pulse', active: true, octave: -2, semi: -12, detune: 10, level: 0.7 }
                    },
                    filter: { type: 'bandpass', cutoff: 800, resonance: 5, envAmount: 80 },
                    envelopes: {
                        amp: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.3 },
                        filter: { attack: 0.05, decay: 0.3, sustain: 0.2, release: 0.2 }
                    },
                    effects: {
                        reverb: { mix: 0.1, decay: 0.5 },
                        delay: { mix: 0.4, time: 0.1, feedback: 0.7 }
                    }
                },
                'Crystal Shimmer Lead': {
                    name: 'Crystal Shimmer Lead',
                    category: 'Lead',
                    oscillators: {
                        osc1: { type: 'fmsine', active: true, octave: 0, semi: 0, detune: 0, level: 1, fmAmount: 50, fmRatio: 3 },
                        osc2: { type: 'triangle', active: true, octave: 0, semi: 12, detune: 5, level: 0.6 }
                    },
                    filter: { type: 'highpass', cutoff: 2500, resonance: 2, envAmount: 40 },
                    envelopes: {
                        amp: { attack: 0.05, decay: 0.3, sustain: 0.6, release: 0.4 },
                        filter: { attack: 0.1, decay: 0.3, sustain: 0.5, release: 0.2 }
                    },
                    effects: {
                        reverb: { mix: 0.4, decay: 2 },
                        delay: { mix: 0.3, time: 0.25, feedback: 0.4 }
                    }
                },
                'Analog Razor Lead': {
                    name: 'Analog Razor Lead',
                    category: 'Lead',
                    oscillators: {
                        osc1: { type: 'fatsquare', active: true, octave: 0, semi: 0, detune: 0, level: 1 },
                        osc2: { type: 'sawtooth', active: true, octave: 0, semi: 12, detune: 10, level: 0.6 }
                    },
                    filter: { type: 'lowpass', cutoff: 3000, resonance: 3, envAmount: 60 },
                    envelopes: {
                        amp: { attack: 0.02, decay: 0.2, sustain: 0.7, release: 0.3 },
                        filter: { attack: 0.1, decay: 0.3, sustain: 0.4, release: 0.2 }
                    },
                    effects: {
                        reverb: { mix: 0.2, decay: 1.5 },
                        delay: { mix: 0.3, time: 0.3, feedback: 0.3 }
                    }
                },
                'Quantum Drift Pad': {
                    name: 'Quantum Drift Pad',
                    category: 'Pad',
                    oscillators: {
                        osc1: { type: 'sine', active: true, octave: 0, semi: 0, detune: 0, level: 0.8 },
                        osc2: { type: 'triangle', active: true, octave: 1, semi: 7, detune: -10, level: 0.6 },
                        osc3: { type: 'sine', active: true, octave: -1, semi: 12, detune: 5, level: 0.4 }
                    },
                    filter: { type: 'lowpass', cutoff: 1000, resonance: 1, envAmount: 30 },
                    envelopes: {
                        amp: { attack: 2, decay: 1, sustain: 0.8, release: 3 },
                        filter: { attack: 2.5, decay: 2, sustain: 0.6, release: 4 }
                    },
                    effects: {
                        reverb: { mix: 0.9, decay: 12 },
                        delay: { mix: 0.6, time: 0.8, feedback: 0.5 }
                    }
                },
                'Ethereal Breath Pad': {
                    name: 'Ethereal Breath Pad',
                    category: 'Pad',
                    oscillators: {
                        osc1: { type: 'sine', active: true, octave: 0, semi: 0, detune: 0, level: 0.9 },
                        osc2: { type: 'amsine', active: true, octave: 1, semi: 5, detune: -10, level: 0.5 },
                        osc3: { type: 'fmsine', active: true, octave: -1, semi: 12, detune: 5, level: 0.3 }
                    },
                    filter: { type: 'lowpass', cutoff: 1200, resonance: 1, envAmount: 40 },
                    envelopes: {
                        amp: { attack: 3, decay: 2, sustain: 0.9, release: 4 },
                        filter: { attack: 3.5, decay: 3, sustain: 0.7, release: 5 }
                    },
                    effects: {
                        reverb: { mix: 0.8, decay: 15 },
                        delay: { mix: 0.5, time: 1.0, feedback: 0.6 }
                    }
                },
                'Electric Memory Keys': {
                    name: 'Electric Memory Keys',
                    category: 'Keys',
                    oscillators: {
                        osc1: { type: 'fatsquare', active: true, octave: 0, semi: 0, detune: 0, level: 1 },
                        osc2: { type: 'triangle', active: true, octave: 0, semi: 12, detune: 5, level: 0.6 }
                    },
                    filter: { type: 'lowpass', cutoff: 2500, resonance: 2, envAmount: 40 },
                    envelopes: {
                        amp: { attack: 0.01, decay: 0.2, sustain: 0.7, release: 0.3 },
                        filter: { attack: 0.05, decay: 0.3, sustain: 0.5, release: 0.2 }
                    },
                    effects: {
                        reverb: { mix: 0.3, decay: 2 },
                        delay: { mix: 0.4, time: 0.3, feedback: 0.3 }
                    }
                },
                'Glassy Pluck Keys': {
                    name: 'Glassy Pluck Keys',
                    category: 'Keys',
                    oscillators: {
                        osc1: { type: 'sawtooth', active: true, octave: 0, semi: 0, detune: 0, level: 1 },
                        osc2: { type: 'pulse', active: true, octave: 0, semi: 12, detune: 7, level: 0.5 }
                    },
                    filter: { type: 'highpass', cutoff: 1500, resonance: 3, envAmount: 50 },
                    envelopes: {
                        amp: { attack: 0.01, decay: 0.1, sustain: 0.4, release: 0.2 },
                        filter: { attack: 0.05, decay: 0.2, sustain: 0.3, release: 0.1 }
                    },
                    effects: {
                        reverb: { mix: 0.2, decay: 1 },
                        delay: { mix: 0.3, time: 0.2, feedback: 0.4 }
                    }
                },
                'Resonant Warp FX': {
                    name: 'Resonant Warp FX',
                    category: 'FX',
                    oscillators: {
                        osc1: { type: 'fmsine', active: true, octave: 0, semi: 0, detune: 0, level: 1, fmAmount: 100, fmRatio: 5 },
                        osc2: { type: 'sawtooth', active: true, octave: 1, semi: 12, detune: -10, level: 0.6 }
                    },
                    filter: { type: 'bandpass', cutoff: 800, resonance: 8, envAmount: 80 },
                    envelopes: {
                        amp: { attack: 0.01, decay: 0.3, sustain: 0.3, release: 0.4 },
                        filter: { attack: 0.05, decay: 0.4, sustain: 0.2, release: 0.5 }
                    },
                    effects: {
                        reverb: { mix: 0.5, decay: 3 },
                        delay: { mix: 0.6, time: 0.15, feedback: 0.7 }
                    }
                },
                'Sonic Disruptor FX': {
                    name: 'Sonic Disruptor FX',
                    category: 'FX',
                    oscillators: {
                        osc1: { type: 'pulse', active: true, octave: 0, semi: 0, detune: 0, level: 1 },
                        osc2: { type: 'fatsawtooth', active: true, octave: 1, semi: 24, detune: 20, level: 0.6 }
                    },
                    filter: { type: 'notch', cutoff: 1200, resonance: 6, envAmount: 70 },
                    envelopes: {
                        amp: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.5 },
                        filter: { attack: 0.05, decay: 0.3, sustain: 0.1, release: 0.4 }
                    },
                    effects: {
                        reverb: { mix: 0.4, decay: 2 },
                        delay: { mix: 0.5, time: 0.1, feedback: 0.8 }
                    }
                },
                'Analog Dream': {
                    name: 'Analog Dream',
                    category: 'Lead',
                    oscillators: {
                        osc1: { type: 'fatsquare', active: true, octave: 0, semi: 0, detune: 0, level: 1 },
                        osc2: { type: 'sawtooth', active: true, octave: 0, semi: 0, detune: 7, level: 0.8 }
                    },
                    filter: { type: 'lowpass', cutoff: 2000, resonance: 3, envAmount: 50 },
                    envelopes: {
                        amp: { attack: 0.01, decay: 0.2, sustain: 0.7, release: 0.5 },
                        filter: { attack: 0.1, decay: 0.3, sustain: 0.3, release: 0.8 }
                    },
                    effects: {
                        reverb: { mix: 0.3, decay: 2 },
                        delay: { mix: 0.2, time: 0.3, feedback: 0.4 }
                    }
                },
                'Deep Bass': {
                    name: 'Deep Bass',
                    category: 'Bass',
                    oscillators: {
                        osc1: { type: 'fatsawtooth', active: true, octave: -1, semi: 0, detune: 0, level: 1 },
                        osc2: { type: 'sine', active: true, octave: -2, semi: 0, detune: 0, level: 0.5 }
                    },
                    filter: { type: 'lowpass', cutoff: 500, resonance: 2, envAmount: 30 },
                    envelopes: {
                        amp: { attack: 0.005, decay: 0.1, sustain: 0.8, release: 0.2 },
                        filter: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 0.2 }
                    },
                    effects: {
                        reverb: { mix: 0.1, decay: 1 },
                        delay: { mix: 0, time: 0.2, feedback: 0.3 }
                    }
                },
                'Ethereal Pad': {
                    name: 'Ethereal Pad',
                    category: 'Pad',
                    oscillators: {
                        osc1: { type: 'sine', active: true, octave: 0, semi: 0, detune: 0, level: 0.8 },
                        osc2: { type: 'triangle', active: true, octave: 1, semi: 7, detune: -10, level: 0.6 },
                        osc3: { type: 'sine', active: true, octave: -1, semi: 0, detune: 5, level: 0.4 }
                    },
                    filter: { type: 'lowpass', cutoff: 1500, resonance: 1, envAmount: 20 },
                    envelopes: {
                        amp: { attack: 1, decay: 1, sustain: 0.8, release: 2 },
                        filter: { attack: 1.5, decay: 2, sustain: 0.5, release: 3 }
                    },
                    effects: {
                        reverb: { mix: 0.7, decay: 8 },
                        delay: { mix: 0.3, time: 0.7, feedback: 0.5 }
                    }
                },
                'Techno Pluck': {
                    name: 'Techno Pluck',
                    category: 'Pluck',
                    oscillators: {
                        osc1: { type: 'square', active: true, octave: 0, semi: 0, detune: 0, level: 1 },
                        osc2: { type: 'sawtooth', active: true, octave: 0, semi: 7, detune: 5, level: 0.6 }
                    },
                    filter: { type: 'highpass', cutoff: 1000, resonance: 2, envAmount: 30 },
                    envelopes: {
                        amp: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.3 },
                        filter: { attack: 0.05, decay: 0.2, sustain: 0.2, release: 0.2 }
                    },
                    effects: {
                        reverb: { mix: 0.2, decay: 1 },
                        delay: { mix: 0.4, time: 0.15, feedback: 0.3 }
                    }
                },
                'Retro Lead': {
                    name: 'Retro Lead',
                    category: 'Lead',
                    oscillators: {
                        osc1: { type: 'fatsquare', active: true, octave: 0, semi: 0, detune: 0, level: 1 },
                        osc2: { type: 'triangle', active: true, octave: 0, semi: 12, detune: 10, level: 0.5 }
                    },
                    filter: { type: 'lowpass', cutoff: 2500, resonance: 4, envAmount: 70 },
                    envelopes: {
                        amp: { attack: 0.02, decay: 0.3, sustain: 0.6, release: 0.4 },
                        filter: { attack: 0.1, decay: 0.3, sustain: 0.4, release: 0.5 }
                    },
                    effects: {
                        reverb: { mix: 0.1, decay: 1.5 },
                        delay: { mix: 0.3, time: 0.25, feedback: 0.4 }
                    }
                },
                'Ambient Texture': {
                    name: 'Ambient Texture',
                    category: 'Pad',
                    oscillators: {
                        osc1: { type: 'sine', active: true, octave: 0, semi: 0, detune: 0, level: 0.7 },
                        osc2: { type: 'triangle', active: true, octave: 1, semi: 5, detune: -5, level: 0.5 },
                        osc3: { type: 'sine', active: true, octave: -1, semi: 7, detune: 3, level: 0.3 }
                    },
                    filter: { type: 'lowpass', cutoff: 1200, resonance: 1, envAmount: 40 },
                    envelopes: {
                        amp: { attack: 2, decay: 1, sustain: 0.9, release: 3 },
                        filter: { attack: 2.5, decay: 2, sustain: 0.6, release: 4 }
                    },
                    effects: {
                        reverb: { mix: 0.8, decay: 10 },
                        delay: { mix: 0.5, time: 0.6, feedback: 0.4 }
                    }
                },
                'Acid Bass': {
                    name: 'Acid Bass',
                    category: 'Bass',
                    oscillators: {
                        osc1: { type: 'sawtooth', active: true, octave: -1, semi: 0, detune: 0, level: 1 },
                        osc2: { type: 'pulse', active: true, octave: -2, semi: 0, detune: 5, level: 0.6 }
                    },
                    filter: { type: 'highpass', cutoff: 400, resonance: 5, envAmount: 60 },
                    envelopes: {
                        amp: { attack: 0.01, decay: 0.2, sustain: 0.5, release: 0.3 },
                        filter: { attack: 0.05, decay: 0.3, sustain: 0.4, release: 0.2 }
                    },
                    effects: {
                        reverb: { mix: 0.1, decay: 0.5 },
                        delay: { mix: 0.3, time: 0.2, feedback: 0.5 }
                    }
                },
                'Future Wobble': {
                    name: 'Future Wobble',
                    category: 'Bass',
                    oscillators: {
                        osc1: { type: 'fatsawtooth', active: true, octave: -1, semi: 0, detune: 0, level: 1 },
                        osc2: { type: 'fmsine', active: true, octave: -2, semi: 0, detune: 10, level: 0.7 }
                    },
                    filter: { type: 'bandpass', cutoff: 800, resonance: 3, envAmount: 50 },
                    envelopes: {
                        amp: { attack: 0.02, decay: 0.3, sustain: 0.4, release: 0.4 },
                        filter: { attack: 0.1, decay: 0.4, sustain: 0.3, release: 0.3 }
                    },
                    effects: {
                        reverb: { mix: 0.2, decay: 1 },
                        delay: { mix: 0.5, time: 0.15, feedback: 0.6 }
                    }
                },
                'Synthwave Lead': {
                    name: 'Synthwave Lead',
                    category: 'Lead',
                    oscillators: {
                        osc1: { type: 'fatsquare', active: true, octave: 0, semi: 0, detune: 0, level: 1 },
                        osc2: { type: 'fatsawtooth', active: true, octave: 0, semi: 12, detune: 5, level: 0.6 }
                    },
                    filter: { type: 'lowpass', cutoff: 3000, resonance: 2, envAmount: 40 },
                    envelopes: {
                        amp: { attack: 0.05, decay: 0.2, sustain: 0.7, release: 0.3 },
                        filter: { attack: 0.1, decay: 0.3, sustain: 0.5, release: 0.2 }
                    },
                    effects: {
                        reverb: { mix: 0.3, decay: 2 },
                        delay: { mix: 0.4, time: 0.3, feedback: 0.3 }
                    }
                },
                'Cosmic Pad': {
                    name: 'Cosmic Pad',
                    category: 'Pad',
                    oscillators: {
                        osc1: { type: 'sine', active: true, octave: 0, semi: 0, detune: 0, level: 0.8 },
                        osc2: { type: 'triangle', active: true, octave: 1, semi: 7, detune: -7, level: 0.5 },
                        osc3: { type: 'sine', active: true, octave: -1, semi: 12, detune: 3, level: 0.3 }
                    },
                    filter: { type: 'lowpass', cutoff: 1000, resonance: 1, envAmount: 30 },
                    envelopes: {
                        amp: { attack: 3, decay: 2, sustain: 0.8, release: 4 },
                        filter: { attack: 3.5, decay: 3, sustain: 0.5, release: 5 }
                    },
                    effects: {
                        reverb: { mix: 0.9, decay: 12 },
                        delay: { mix: 0.6, time: 0.8, feedback: 0.5 }
                    }
                },
                'Dubstep Growl': {
                    name: 'Dubstep Growl',
                    category: 'Bass',
                    oscillators: {
                        osc1: { type: 'fatsawtooth', active: true, octave: -1, semi: 0, detune: 0, level: 1 },
                        osc2: { type: 'pulse', active: true, octave: -2, semi: -12, detune: 10, level: 0.7 }
                    },
                    filter: { type: 'bandpass', cutoff: 600, resonance: 4, envAmount: 80 },
                    envelopes: {
                        amp: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.3 },
                        filter: { attack: 0.05, decay: 0.3, sustain: 0.2, release: 0.2 }
                    },
                    effects: {
                        reverb: { mix: 0.1, decay: 0.5 },
                        delay: { mix: 0.4, time: 0.1, feedback: 0.7 }
                    }
                },
                '80s Keys': {
                    name: '80s Keys',
                    category: 'Keys',
                    oscillators: {
                        osc1: { type: 'fatsquare', active: true, octave: 0, semi: 0, detune: 0, level: 1 },
                        osc2: { type: 'triangle', active: true, octave: 0, semi: 12, detune: 5, level: 0.6 }
                    },
                    filter: { type: 'lowpass', cutoff: 2500, resonance: 2, envAmount: 40 },
                    envelopes: {
                        amp: { attack: 0.1, decay: 0.3, sustain: 0.7, release: 0.5 },
                        filter: { attack: 0.2, decay: 0.4, sustain: 0.5, release: 0.3 }
                    },
                    effects: {
                        reverb: { mix: 0.4, decay: 3 },
                        delay: { mix: 0.3, time: 0.4, feedback: 0.3 }
                    }
                },
                'Favorite Pluck': {
                    name: 'Favorite Pluck',
                    category: 'Pluck',
                    oscillators: {
                        osc1: { type: 'sawtooth', active: true, octave: 0, semi: 0, detune: 0, level: 1 },
                        osc2: { type: 'square', active: true, octave: 0, semi: 12, detune: 7, level: 0.5 }
                    },
                    filter: { type: 'highpass', cutoff: 1500, resonance: 3, envAmount: 50 },
                    envelopes: {
                        amp: { attack: 0.01, decay: 0.1, sustain: 0.4, release: 0.2 },
                        filter: { attack: 0.05, decay: 0.2, sustain: 0.3, release: 0.1 }
                    },
                    effects: {
                        reverb: { mix: 0.2, decay: 1 },
                        delay: { mix: 0.3, time: 0.2, feedback: 0.4 }
                    }
                }
            };
            
            return builtInPresets[name];
        }
        
        function setupParameterDisplay() {
            const paramDisplay = document.getElementById('parameterDisplay');
            
            document.querySelectorAll('.knob').forEach(knob => {
                knob.addEventListener('mouseenter', function() {
                    const knobId = this.id.replace('Knob', '');
                    const inputElement = document.getElementById(knobId);
                    const valueElement = document.getElementById(`${knobId}Value`);
                    const labelElement = this.parentElement.querySelector('.knob-label');
                    
                    if (inputElement && valueElement && labelElement) {
                        // Position the display near the mouse
                        const rect = this.getBoundingClientRect();
                        paramDisplay.style.left = `${rect.left + rect.width/2}px`;
                        paramDisplay.style.top = `${rect.top - 10}px`;
                        
                        // Update the display content
                        paramDisplay.querySelector('.parameter-display-title').textContent = labelElement.textContent;
                        paramDisplay.querySelector('.parameter-display-value').textContent = valueElement.textContent;
                        
                        // Show the display
                        paramDisplay.classList.add('visible');
                    }
                });
                
                knob.addEventListener('mouseleave', function() {
                    paramDisplay.classList.remove('visible');
                });
            });
        }
        
        function setupEffectsReordering() {
            let draggedEffect = null;
            const effectsContainer = document.querySelector('.fx-slots');
            
            document.querySelectorAll('.fx-slot').forEach(slot => {
                const handle = slot.querySelector('.drag-handle');
                
                if (!handle) return;
                
                handle.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    draggedEffect = slot;
                    slot.classList.add('dragging');
                    
                    const moveHandler = function(e) {
                        if (!draggedEffect) return;
                        
                        // Find the effect slot under the pointer
                        const elementsUnderPointer = document.elementsFromPoint(e.clientX, e.clientY);
                        const targetSlot = elementsUnderPointer.find(el => 
                            el.classList.contains('fx-slot') && el !== draggedEffect
                        );
                        
                        if (targetSlot) {
                            // Determine if we should insert before or after the target
                            const rect = targetSlot.getBoundingClientRect();
                            const midpoint = rect.top + rect.height / 2;
                            
                            if (e.clientY < midpoint) {
                                effectsContainer.insertBefore(draggedEffect, targetSlot);
                            } else {
                                effectsContainer.insertBefore(draggedEffect, targetSlot.nextSibling);
                            }
                        }
                    };
                    
                    const upHandler = function() {
                        if (draggedEffect) {
                            draggedEffect.classList.remove('dragging');
                            draggedEffect = null;
                            
                            // Update the effect chain order
                            updateEffectChainOrder();
                        }
                        
                        document.removeEventListener('mousemove', moveHandler);
                        document.removeEventListener('mouseup', upHandler);
                    };
                    
                    document.addEventListener('mousemove', moveHandler);
                    document.addEventListener('mouseup', upHandler);
                });
            });
        }
        
        function updateEffectChainOrder() {
            // This would update the Tone.js effects chain based on the new UI order
            console.log("Updating effect chain order");
            showNotification('info', 'Effect chain order updated');
        }
        
        function addEffect(effectType) {
            // Create a new effect slot based on the type
            const newEffect = document.createElement('div');
            newEffect.className = 'fx-slot';
            newEffect.setAttribute('data-fx-type', effectType);
            
            // Generate the appropriate UI for this effect type
            let title, icon, parameters;
            
            switch(effectType) {
                case 'chorus':
                    title = 'Chorus';
                    icon = 'wave-square';
                    parameters = `
                        <div class="knob-container">
                            <label class="knob-label">Rate</label>
                            <div class="knob fx" id="chorusRateKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Modulation rate</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="chorusRate" min="0.1" max="10" step="0.1" value="1.5">
                            <span class="knob-value" id="chorusRateValue">1.5 Hz</span>
                        </div>
                        <div class="knob-container">
                            <label class="knob-label">Depth</label>
                            <div class="knob fx" id="chorusDepthKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Modulation depth</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="chorusDepth" min="0" max="1" step="0.01" value="0.7">
                            <span class="knob-value" id="chorusDepthValue">70%</span>
                        </div>
                        <div class="knob-container">
                            <label class="knob-label">Mix</label>
                            <div class="knob fx" id="chorusMixKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Dry/Wet mix</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="chorusMix" min="0" max="1" step="0.01" value="0.5">
                            <span class="knob-value" id="chorusMixValue">50%</span>
                        </div>
                    `;
                    break;
                    
                case 'phaser':
                    title = 'Phaser';
                    icon = 'sync-alt';
                    parameters = `
                        <div class="knob-container">
                            <label class="knob-label">Rate</label>
                            <div class="knob fx" id="phaserRateKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Modulation rate</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="phaserRate" min="0.1" max="10" step="0.1" value="0.8">
                            <span class="knob-value" id="phaserRateValue">0.8 Hz</span>
                        </div>
                        <div class="knob-container">
                            <label class="knob-label">Depth</label>
                            <div class="knob fx" id="phaserDepthKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Modulation depth</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="phaserDepth" min="0" max="1" step="0.01" value="0.6">
                            <span class="knob-value" id="phaserDepthValue">60%</span>
                        </div>
                        <div class="knob-container">
                            <label class="knob-label">Feedback</label>
                            <div class="knob fx" id="phaserFeedbackKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Feedback amount</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="phaserFeedback" min="0" max="0.95" step="0.01" value="0.5">
                            <span class="knob-value" id="phaserFeedbackValue">50%</span>
                        </div>
                        <div class="knob-container">
                            <label class="knob-label">Mix</label>
                            <div class="knob fx" id="phaserMixKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Dry/Wet mix</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="phaserMix" min="0" max="1" step="0.01" value="0.5">
                            <span class="knob-value" id="phaserMixValue">50%</span>
                        </div>
                    `;
                    break;
                    
                // Other effect types would be defined similarly
                default:
                    title = effectType.charAt(0).toUpperCase() + effectType.slice(1);
                    icon = 'sliders-h';
                    parameters = `
                        <div class="knob-container">
                            <label class="knob-label">Amount</label>
                            <div class="knob fx" id="${effectType}AmountKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Effect amount</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="${effectType}Amount" min="0" max="1" step="0.01" value="0.5">
                            <span class="knob-value" id="${effectType}AmountValue">50%</span>
                        </div>
                        <div class="knob-container">
                            <label class="knob-label">Mix</label>
                            <div class="knob fx" id="${effectType}MixKnob">
                                <div class="knob-inner"></div>
                                <div class="tooltip">Dry/Wet mix</div>
                                <div class="midi-learn-indicator">MIDI</div>
                            </div>
                            <input type="range" id="${effectType}Mix" min="0" max="1" step="0.01" value="0.5">
                            <span class="knob-value" id="${effectType}MixValue">50%</span>
                        </div>
                    `;
            }
            
            newEffect.innerHTML = `
                <i class="fas fa-grip-vertical drag-handle"></i>
                <div class="fx-slot-header">
                    <div class="fx-slot-title">
                        <i class="fas fa-${icon}"></i>
                        ${title}
                    </div>
                    <div class="fx-slot-controls">
                        <button class="fx-slot-button active">
                            <i class="fas fa-power-off"></i>
                        </button>
                        <button class="fx-slot-button">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                </div>
                
                <div class="fx-parameters">
                    ${parameters}
                </div>
            `;
            
            // Insert the new effect before the "Add Effect" slot
            const addEffectSlot = document.querySelector('.fx-slot[data-fx-type="add-effect"]');
            if (addEffectSlot) {
                addEffectSlot.parentNode.insertBefore(newEffect, addEffectSlot);
            }
            
            // Setup knobs for the new effect
            newEffect.querySelectorAll('.knob').forEach(knob => {
                setupKnob(knob);
                
                knob.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    startMIDILearn(knob);
                });
            });
            
            // Setup parameter display for the new effect
            setupParameterDisplay();
            
            // Setup drag functionality for the new effect
            setupEffectsReordering();
            
            // Create the actual audio effect
            createAudioEffect(effectType);
            
            showNotification('success', `Added ${title} effect`);
        }
        
        function createAudioEffect(effectType) {
            // Create the Tone.js effect based on the type
            let newEffect;
            
            switch(effectType) {
                case 'chorus':
                    newEffect = new Tone.Chorus({
                        frequency: 1.5,
                        delayTime: 3.5,
                        depth: 0.7,
                        wet: 0.5
                    });
                    break;
                    
                case 'phaser':
                    newEffect = new Tone.Phaser({
                        frequency: 0.8,
                        octaves: 3,
                        baseFrequency: 1000,
                        wet: 0.5
                    });
                    break;
                    
                case 'flanger':
                    newEffect = new Tone.FeedbackDelay({
                        delayTime: 0.005,
                        feedback: 0.5,
                        wet: 0.5
                    });
                    break;
                    
                case 'tremolo':
                    newEffect = new Tone.Tremolo({
                        frequency: 10,
                        depth: 0.5,
                        wet: 0.5
                    }).start();
                    break;
                    
                // Add cases for other effects
                
                default:
                    newEffect = new Tone.Effect({
                        wet: 0.5
                    });
            }
            
            // Insert the effect into the signal chain
            // This is simplified - actual implementation would need to reconfigure the chain
            distortion.disconnect();
            distortion.connect(newEffect);
            newEffect.connect(masterVolNode);
            
            // Update the effect chain order
            updateEffectChainOrder();
        }
        
        
        function setupAudioControls() {
            // Add click listener to entire synth container to init audio
            document.querySelector('.synth-container').addEventListener('click', function() {
                if (!audioInitialized) {
                    initAudio();
                }
            });
            
            // Add change listeners to update synth parameters in real time
            document.getElementById('osc1Type').addEventListener('change', function() {
                if (!audioInitialized) return;
                mainSynth.set({ oscillator: { type: this.value }});
            });
            
            document.getElementById('filter1Type').addEventListener('change', function() {
                if (!audioInitialized) return;
                updateFilter();
            });
            
            // Setup range input listeners for all control knobs
            document.querySelectorAll('input[type="range"]').forEach(input => {
                input.addEventListener('input', function() {
                    updateKnobValueDisplay(this.id, parseFloat(this.value));
                    
                    if (!audioInitialized) return;
                    
                    // Update the corresponding audio parameter
                    if (this.id.includes('filter')) {
                        updateFilter();
                    } else if (this.id.includes('env')) {
                        updateEnvelopes();
                    } else if (this.id.includes('reverb') || this.id.includes('delay') || this.id.includes('distortion')) {
                        updateEffects();
                    } else if (this.id.includes('osc')) {
                        const oscNum = this.id.charAt(3);
                        updateOscillator(oscNum);
                    } else if (this.id === 'masterVolume' || this.id === 'tempo' || this.id === 'limiter') {
                        updateMaster();
                    }
                });
            });
            
            // Add listeners for voice mode switching
            document.getElementById('voiceMode').addEventListener('change', function() {
                if (!audioInitialized) return;
                
                const mode = this.value;
                // Recreate the synth with new voice mode
                updateVoiceMode(mode);
            });
            
            document.getElementById('unisonVoices').addEventListener('change', function() {
                if (!audioInitialized) return;
                updateVoiceMode(document.getElementById('voiceMode').value);
            });
        }
        
        function updateVoiceMode(mode) {
            if (!audioInitialized) return;
            
            // Disconnect the current synth
            mainSynth.disconnect();
            
            // Get current settings
            const oscType = document.getElementById('osc1Type').value;
            const attack = parseFloat(document.getElementById('env1Attack').value);
            const decay = parseFloat(document.getElementById('env1Decay').value);
            const sustain = parseFloat(document.getElementById('env1Sustain').value);
            const release = parseFloat(document.getElementById('env1Release').value);
            
            // Create appropriate synth type based on voice mode
            if (mode === 'mono' || mode === 'legato') {
                // Create monophonic synth
                mainSynth = new Tone.MonoSynth({
                    oscillator: {
                        type: oscType
                    },
                    envelope: {
                        attack: attack,
                        decay: decay,
                        sustain: sustain,
                        release: release
                    },
                    filterEnvelope: {
                        attack: 0.1,
                        decay: 0.3,
                        sustain: 0.5,
                        release: 0.5,
                        baseFrequency: 300,
                        octaves: 2
                    }
                });
                
                if (mode === 'legato') {
                    mainSynth.portamento = parseFloat(document.getElementById('portamento').value);
                }
            } else if (mode === 'unison') {
                // Create unison polysynth with multiple voices
                const voices = parseInt(document.getElementById('unisonVoices').value);
                const spread = parseFloat(document.getElementById('unisonSpread').value) / 100;
                
                mainSynth = new Tone.PolySynth({
                    maxPolyphony: 32,
                    voice: Tone.Synth
                });
                
                // Configure with unison-like settings
                mainSynth.set({
                    oscillator: {
                        type: oscType
                    },
                    envelope: {
                        attack: attack,
                        decay: decay,
                        sustain: sustain,
                        release: release
                    }
                });
                
                // In a real implementation, we would create multiple slightly detuned voices
            } else {
                // Default polyphonic synth
                mainSynth = new Tone.PolySynth({
                    maxPolyphony: 32,
                    voice: Tone.Synth
                });
                
                mainSynth.set({
                    oscillator: {
                        type: oscType
                    },
                    envelope: {
                        attack: attack,
                        decay: decay,
                        sustain: sustain,
                        release: release
                    }
                });
            }
            
            // Reconnect the synth
            mainSynth.connect(mainFilter);
            
            // Clear active notes
            activeNotes.clear();
            
            // Update voice counter
            updateVoiceCounter();
            
            showNotification('info', `Voice mode switched to ${mode}`);
        }
        
        function showNotification(type, message) {
            const notification = document.getElementById('notification');
            notification.className = 'notification ' + type;
            notification.querySelector('.notification-text').textContent = message;
            
            // Set appropriate icon
            const icon = notification.querySelector('i');
            icon.className = '';
            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle';
            } else {
                icon.className = 'fas fa-info-circle';
            }
            
            notification.classList.add('show');
            
            // Hide after 3 seconds
            setTimeout(function() {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function setupKnob(knob) {
            const knobId = knob.id;
            const inputId = knobId.replace('Knob', '');
            const input = document.getElementById(inputId);
            
            if (!input) return;
            
            let isDragging = false;
            let startY;
            let startValue;
            let knobValueElement = document.getElementById(`${inputId}Value`);

            const updateKnobRotation = (value) => {
                const min = parseFloat(input.min);
                const max = parseFloat(input.max);
                const rotation = ((value - min) / (max - min)) * 270 - 135;
                knob.style.transform = `rotate(${rotation}deg)`;
            };

            knob.addEventListener('mousedown', (e) => {
                isDragging = true;
                startY = e.clientY;
                startValue = parseFloat(input.value);
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                e.preventDefault();
                
                // Initialize audio if not already done
                if (!audioInitialized) {
                    initAudio();
                }
            });

            const handleMouseMove = (e) => {
                if (!isDragging) return;
                
                const deltaY = startY - e.clientY;
                const range = parseFloat(input.max) - parseFloat(input.min);
                const sensitivity = 200; // Higher value makes knob less sensitive
                const valueChange = (deltaY / sensitivity) * range;
                
                let newValue = startValue + valueChange;
                newValue = Math.max(parseFloat(input.min), Math.min(parseFloat(input.max), newValue));
                
                input.value = newValue;
                updateKnobRotation(newValue);
                updateKnobValueDisplay(inputId, newValue);
                
                // Trigger input event to update audio parameters
                input.dispatchEvent(new Event('input'));
            };

            const handleMouseUp = () => {
                isDragging = false;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            };

            // Touch support
            knob.addEventListener('touchstart', (e) => {
                isDragging = true;
                startY = e.touches[0].clientY;
                startValue = parseFloat(input.value);
                document.addEventListener('touchmove', handleTouchMove, { passive: false });
                document.addEventListener('touchend', handleTouchEnd);
                e.preventDefault();
                
                // Initialize audio if not already done
                if (!audioInitialized) {
                    initAudio();
                }
            });

            const handleTouchMove = (e) => {
                if (!isDragging) return;
                
                const deltaY = startY - e.touches[0].clientY;
                const range = parseFloat(input.max) - parseFloat(input.min);
                const sensitivity = 200; // Higher value makes knob less sensitive
                const valueChange = (deltaY / sensitivity) * range;
                
                let newValue = startValue + valueChange;
                newValue = Math.max(parseFloat(input.min), Math.min(parseFloat(input.max), newValue));
                
                input.value = newValue;
                updateKnobRotation(newValue);
                updateKnobValueDisplay(inputId, newValue);
                
                // Trigger input event to update audio parameters
                input.dispatchEvent(new Event('input'));
                
                e.preventDefault();
            };

            const handleTouchEnd = () => {
                isDragging = false;
                document.removeEventListener('touchmove', handleTouchMove);
                document.removeEventListener('touchend', handleTouchEnd);
            };

            // Initialize knob position
            updateKnobRotation(parseFloat(input.value));
            
            // Initialize value display
            updateKnobValueDisplay(inputId, parseFloat(input.value));
            
            // Add input event listener
            input.addEventListener('input', () => {
                const value = parseFloat(input.value);
                updateKnobRotation(value);
                updateKnobValueDisplay(inputId, value);
            });
        }
        
        function updateKnobValueDisplay(inputId, value) {
            const valueElement = document.getElementById(`${inputId}Value`);
            if (!valueElement) return;
            
            // Format the value according to input type
            let displayValue;
            
            if (inputId.includes('Cutoff')) {
                displayValue = `${Math.round(value)} Hz`;
            } else if (inputId.includes('Attack') || inputId.includes('Decay') || inputId.includes('Release') || inputId.includes('Delay') || inputId.includes('Time')) {
                displayValue = `${value.toFixed(2)}s`;
            } else if (inputId.includes('Level') || inputId.includes('Sustain') || inputId.includes('Mix') || inputId.includes('Depth') || inputId.includes('Feedback')) {
                displayValue = `${Math.round(value * 100)}%`;
            } else if (inputId.includes('Curve')) {
                if (Math.abs(value) < 0.1) {
                    displayValue = `Linear`;
                } else {
                    displayValue = value > 0 ? `+${value.toFixed(1)}` : `${value.toFixed(1)}`;
                }
            } else if (inputId.includes('Pan')) {
                if (Math.abs(value) < 0.01) {
                    displayValue = `Center`;
                } else {
                    displayValue = value > 0 ? `${Math.round(value * 100)}% R` : `${Math.abs(Math.round(value * 100))}% L`;
                }
            } else if (inputId.includes('Phase')) {
                displayValue = `${Math.round(value)}°`;
            } else if (inputId.includes('Rate') && inputId.includes('lfo')) {
                displayValue = `${value.toFixed(1)} Hz`;
            } else if (inputId.includes('Detune')) {
                displayValue = `${Math.round(value)} ct`;
            } else if (inputId.includes('Loop')) {
                displayValue = value ? `On` : `Off`;
            } else if (inputId.includes('Spread')) {
                displayValue = `${Math.round(value)}%`;
            } else if (inputId.includes('Env') && !inputId.includes('Envelope')) {
                displayValue = value >= 0 ? `+${Math.round(value)}%` : `${Math.round(value)}%`;
            } else if (inputId.includes('KeyTrack')) {
                displayValue = `${Math.round(value)}%`;
            } else if (inputId.includes('Velocity') || inputId.includes('Vel')) {
                displayValue = `${Math.round(value)}%`;
            } else if (inputId.includes('Resonance') || inputId.includes('Res')) {
                displayValue = value.toFixed(1);
            } else if (inputId.includes('Octave') || inputId.includes('Semi')) {
                displayValue = Math.round(value);
            } else if (inputId.includes('tempo')) {
                displayValue = `${Math.round(value)} BPM`;
            } else if (inputId.includes('arpRate')) {
                const rates = ["1/1", "1/2", "1/4", "1/8", "1/16", "1/32", "1/64", "1/128"];
                displayValue = rates[Math.round(value) - 1] || "1/4";
            } else {
                displayValue = value.toFixed(2);
            }
            
            valueElement.textContent = displayValue;
        }
        
        function updateVUMeter(value) {
            const vuMeter = document.getElementById('vuMeter');
            vuMeter.style.width = `${value * 100}%`;
        }
        
        function createSequencer() {
            const sequencerElement = document.getElementById('sequencer');
            sequencerElement.innerHTML = '';
            
            for (let i = 0; i < 16; i++) {
                const step = document.createElement('div');
                step.className = 'step';
                step.setAttribute('data-step', i + 1);
                
                const led = document.createElement('div');
                led.className = 'step-led';
                step.appendChild(led);
                
                const controls = document.createElement('div');
                controls.className = 'step-controls';
                
                const select = document.createElement('select');
                select.innerHTML = `
                    <option value="C3">C3</option>
                    <option value="D3">D3</option>
                    <option value="E3">E3</option>
                    <option value="F3">F3</option>
                    <option value="G3">G3</option>
                    <option value="A3">A3</option>
                    <option value="B3">B3</option>
                    <option value="C4">C4</option>
                `;
                
                // Set some example pattern notes
                const pattern = [
                    'C3', 'E3', 'G3', 'B3', 
                    'C4', 'B3', 'G3', 'E3',
                    'C3', 'E3', 'G3', 'B3', 
                    'C4', 'G3', 'E3', 'C3'
                ];
                select.value = pattern[i];
                
                controls.appendChild(select);
                
                const toggle = document.createElement('button');
                toggle.className = 'step-button active';
                toggle.innerHTML = '<i class="fas fa-power-off"></i> <span>On</span>';
                toggle.onclick = () => {
                    if (audioInitialized) {
                        toggle.classList.toggle('active');
                        toggle.querySelector('span').textContent = toggle.classList.contains('active') ? 'On' : 'Off';
                        
                        // Update the step's appearance based on probability
                        updateStepAppearance(step);
                    }
                };
                controls.appendChild(toggle);
                
                const velocity = document.createElement('div');
                velocity.className = 'step-velocity';
                const velocityFill = document.createElement('div');
                velocityFill.className = 'step-velocity-fill';
                velocityFill.style.width = '75%';
                velocity.appendChild(velocityFill);
                controls.appendChild(velocity);
                
                // Add probability slider
                const probability = document.createElement('div');
                probability.className = 'step-probability';
                probability.innerHTML = `
                    <input type="range" class="step-probability-slider" min="0" max="1" step="0.01" value="1">
                    <div class="step-probability-value">100%</div>
                    <div class="step-probability-text">Prob</div>
                `;
                controls.appendChild(probability);
                
                // Add event listener for probability slider
                const probSlider = probability.querySelector('.step-probability-slider');
                probSlider.addEventListener('input', function() {
                    const probValue = this.value;
                    probability.querySelector('.step-probability-value').textContent = `${Math.round(probValue * 100)}%`;
                    
                    // Update the sequencer pattern
                    if (sequencerPattern[i]) {
                        sequencerPattern[i].probability = probValue;
                    }
                    
                    // Update the step's appearance based on probability
                    updateStepAppearance(step);
                });
                
                step.appendChild(controls);
                sequencerElement.appendChild(step);
            }
        }
        
        function updateStepAppearance(step) {
            const probSlider = step.querySelector('.step-probability-slider');
            const isActive = step.querySelector('.step-button').classList.contains('active');
            
            if (probSlider && isActive) {
                const probValue = parseFloat(probSlider.value);
                
                // Add low probability class if probability is below 50%
                if (probValue < 0.5) {
                    step.classList.add('probability-low');
                } else {
                    step.classList.remove('probability-low');
                }
            } else {
                step.classList.remove('probability-low');
            }
        }
        
        function createKeyboard() {
            const keyboardElement = document.getElementById('keyboard');
            keyboardElement.innerHTML = '';
            
            const octave = 3;
            const notes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const blackNotes = [true, true, false, true, true, true, false]; // true if there's a black note after this white note
            
            // Create white keys
            for (let i = 0; i < 2; i++) {
                for (let j = 0; j < notes.length; j++) {
                    const note = notes[j];
                    const key = document.createElement('div');
                    key.className = 'key';
                    key.textContent = `${note}${octave + i}`;
                    key.setAttribute('data-note', `${note}${octave + i}`);
                    keyboardElement.appendChild(key);
                    
                    key.addEventListener('mousedown', () => {
                        key.classList.add('active');
                        // Initialize audio if not already done
                        if (!audioInitialized) {
                            initAudio().then(() => {
                                playNote(`${note}${octave + i}`);
                            });
                        } else {
                            playNote(`${note}${octave + i}`);
                        }
                    });
                    
                    key.addEventListener('mouseup', () => {
                        key.classList.remove('active');
                        if (audioInitialized) {
                            releaseNote(`${note}${octave + i}`);
                        }
                    });
                    
                    key.addEventListener('mouseleave', () => {
                        if (key.classList.contains('active')) {
                            key.classList.remove('active');
                            if (audioInitialized) {
                                releaseNote(`${note}${octave + i}`);
                            }
                        }
                    });
                    
                    // Add black key after this key if needed
                    if (blackNotes[j]) {
                        const blackKey = document.createElement('div');
                        blackKey.className = 'black-key';
                        blackKey.setAttribute('data-note', `${note}#${octave + i}`);
                        
                        // Position the black key
                        const whiteKeyWidth = 40; // This should match the CSS max-width
                        blackKey.style.left = `${(i * 7 + j) * whiteKeyWidth + whiteKeyWidth * 0.7}px`;
                        
                        keyboardElement.appendChild(blackKey);
                        
                        blackKey.addEventListener('mousedown', () => {
                            blackKey.classList.add('active');
                            // Initialize audio if not already done
                            if (!audioInitialized) {
                                initAudio().then(() => {
                                    playNote(`${note}#${octave + i}`);
                                });
                            } else {
                                playNote(`${note}#${octave + i}`);
                            }
                        });
                        
                        blackKey.addEventListener('mouseup', () => {
                            blackKey.classList.remove('active');
                            if (audioInitialized) {
                                releaseNote(`${note}#${octave + i}`);
                            }
                        });
                        
                        blackKey.addEventListener('mouseleave', () => {
                            if (blackKey.classList.contains('active')) {
                                blackKey.classList.remove('active');
                                if (audioInitialized) {
                                    releaseNote(`${note}#${octave + i}`);
                                }
                            }
                        });
                    }
                }
            }
        }
        
        function setupPianoRoll() {
            const pianoRollElement = document.getElementById('pianoRoll');
            
            // Clear existing grid
            while (pianoRollElement.firstChild) {
                if (!pianoRollElement.firstChild.classList || !pianoRollElement.firstChild.classList.contains('grid-row-labels')) {
                    pianoRollElement.removeChild(pianoRollElement.firstChild);
                } else {
                    break;
                }
            }
            
            // Create grid cells
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 16; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.setAttribute('data-row', row);
                    cell.setAttribute('data-col', col);
                    
                    cell.addEventListener('click', function() {
                        // Toggle cell state based on selected note length
                        const noteLength = document.querySelector('.pill-button[data-length].active');
                        const length = noteLength ? parseInt(noteLength.getAttribute('data-length').replace('1/', '')) : 1;
                        
                        // If already active, just deactivate this cell
                        if (this.classList.contains('active')) {
                            this.classList.remove('active');
                            this.classList.remove('alt');
                        } else {
                            // Activate this cell and additional cells based on note length
                            this.classList.add('active');
                            
                            // Add alternative color for extended notes
                            for (let i = 1; i < 16 / length && col + i < 16; i++) {
                                const nextCell = pianoRollElement.querySelector(`.grid-cell[data-row="${row}"][data-col="${col + i}"]`);
                                if (nextCell) {
                                    nextCell.classList.add('active', 'alt');
                                }
                            }
                        }
                        
                        // Play the note for feedback
                        if (audioInitialized) {
                            const row = parseInt(this.getAttribute('data-row'));
                            const notes = ['C4', 'B3', 'A3', 'G3', 'F3', 'E3', 'D3', 'C3'];
                            const note = notes[row];
                            
                            // Play a short preview of the note
                            playNotePreview(note);
                        }
                    });
                    
                    pianoRollElement.appendChild(cell);
                }
            }
            
            // Add listeners for note length buttons
            document.querySelectorAll('.pill-button[data-length]').forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all length buttons
                    document.querySelectorAll('.pill-button[data-length]').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                });
            });
        }
        
        function setupPianoRollHandlers() {
            document.getElementById('clearAllNotes').addEventListener('click', function() {
                document.querySelectorAll('.grid-cell').forEach(cell => {
                    cell.classList.remove('active');
                    cell.classList.remove('alt');
                });
            });
            
            document.getElementById('randomizeNotes').addEventListener('click', function() {
                document.querySelectorAll('.grid-cell').forEach(cell => {
                    cell.classList.remove('active');
                    cell.classList.remove('alt');
                    
                    // Apply scale constraints if a scale is selected
                    const scaleType = document.getElementById('scaleType').value;
                    const scaleRoot = document.getElementById('scaleRoot').value;
                    
                    // Generate random notes constrained to scale
                    if (Math.random() > 0.85) {
                        const row = parseInt(cell.getAttribute('data-row'));
                        
                        // Check if this note is in the scale
                        if (scaleType === 'none' || isNoteInScale(row, scaleRoot, scaleType)) {
                            cell.classList.add('active');
                            if (Math.random() > 0.7) {
                                cell.classList.add('alt');
                            }
                            
                            // If audio is initialized, play a random note for feedback
                            if (audioInitialized && Math.random() > 0.9) {
                                const notes = ['C4', 'B3', 'A3', 'G3', 'F3', 'E3', 'D3', 'C3'];
                                const note = notes[row];
                                
                                // Play a short preview of the note
                                playNotePreview(note);
                            }
                        }
                    }
                });
            });
            
            // Quantize button handler
            document.getElementById('quantizeNotes').addEventListener('click', function() {
                // Get all active cells
                const activeCells = Array.from(document.querySelectorAll('.grid-cell.active'));
                
                // Clear all cells
                document.querySelectorAll('.grid-cell').forEach(cell => {
                    cell.classList.remove('active');
                    cell.classList.remove('alt');
                });
                
                // Quantize each active cell to the nearest 16th note position
                activeCells.forEach(cell => {
                    const row = parseInt(cell.getAttribute('data-row'));
                    const col = parseInt(cell.getAttribute('data-col'));
                    
                    // Quantize to nearest 16th note (in this grid, each column is already a 16th note)
                    const quantizedCell = document.querySelector(`.grid-cell[data-row="${row}"][data-col="${col}"]`);
                    if (quantizedCell) {
                        quantizedCell.classList.add('active');
                    }
                });
                
                showNotification('success', 'Notes quantized to 16th notes');
            });
            
            // Scale and root note change handlers
            document.getElementById('scaleType').addEventListener('change', function() {
                applyScaleConstraints();
            });
            
            document.getElementById('scaleRoot').addEventListener('change', function() {
                applyScaleConstraints();
            });
        }
        
        function isNoteInScale(row, root, scaleType) {
            // Map row index to note index (0 = C, 1 = C#, etc.)
            const notes = ['C4', 'B3', 'A3', 'G3', 'F3', 'E3', 'D3', 'C3'];
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            
            const noteName = notes[row].replace(/\d+/, '');
            const noteIndex = noteNames.indexOf(noteName);
            
            // Get the root note index
            const rootIndex = noteNames.indexOf(root);
            
            // Define scale patterns (semitone intervals)
            const scalePatterns = {
                'major': [0, 2, 4, 5, 7, 9, 11],
                'minor': [0, 2, 3, 5, 7, 8, 10],
                'pentatonic': [0, 2, 4, 7, 9],
                'blues': [0, 3, 5, 6, 7, 10],
                'dorian': [0, 2, 3, 5, 7, 9, 10],
                'phrygian': [0, 1, 3, 5, 7, 8, 10],
                'lydian': [0, 2, 4, 6, 7, 9, 11],
                'mixolydian': [0, 2, 4, 5, 7, 9, 10],
                'aeolian': [0, 2, 3, 5, 7, 8, 10],
                'locrian': [0, 1, 3, 5, 6, 8, 10]
            };
            
            // Get the selected scale pattern
            const pattern = scalePatterns[scaleType] || scalePatterns.major;
            
            // Calculate the note's position relative to the root
            const relativePosition = (noteIndex - rootIndex + 12) % 12;
            
            // Check if the note is in the scale
            return pattern.includes(relativePosition);
        }
        
        function applyScaleConstraints() {
            const scaleType = document.getElementById('scaleType').value;
            const scaleRoot = document.getElementById('scaleRoot').value;
            
            // Skip if no scale constraint
            if (scaleType === 'none') return;
            
            // Update the appearance of the piano roll grid
            document.querySelectorAll('.grid-cell').forEach(cell => {
                const row = parseInt(cell.getAttribute('data-row'));
                
                if (isNoteInScale(row, scaleRoot, scaleType)) {
                    cell.style.opacity = '1';
                } else {
                    cell.style.opacity = '0.3';
                }
            });
        }
        
        function toggleSequencer() {
            const button = document.getElementById('startSequencer');
            isPlaying = !isPlaying;
            
            if (isPlaying) {
                button.innerHTML = '<i class="fas fa-stop"></i><span>Stop</span>';
                button.classList.add('playing');
                startSequencer();
            } else {
                button.innerHTML = '<i class="fas fa-play"></i><span>Start</span>';
                button.classList.remove('playing');
                stopSequencer();
            }
        }
        
        function startSequencer() {
            if (!audioInitialized) return;
            
            // Set up the Transport
            const tempo = parseInt(document.getElementById('tempo').value);
            Tone.Transport.bpm.value = tempo;
            
            // Create a sequence
            const seq = new Tone.Sequence((time, step) => {
                // Update UI
                updateSequencerUI(step);
                
                // Play notes from both the step sequencer and piano roll
                playSequencerStep(step, time);
                playPianoRollStep(step, time);
                
            }, [...Array(16).keys()], "16n").start(0);
            
            // Start the Transport
            Tone.Transport.start();
        }
        
        function stopSequencer() {
            if (!audioInitialized) return;
            
            // Stop the Transport
            Tone.Transport.stop();
            Tone.Transport.cancel();
            
            // Clear all active steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Clear piano roll active column
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.classList.remove('grid-column-active');
            });
        }
        
        function updateSequencerUI(step) {
            // Update step indicators
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.toggle('active', index === step);
            });
            
            // Update piano roll column highlight
            document.querySelectorAll('.grid-cell').forEach(cell => {
                const col = parseInt(cell.getAttribute('data-col'));
                cell.classList.toggle('grid-column-active', col === step);
            });
            
            // Update VU meter based on whether a note is playing
            const stepElement = document.querySelectorAll('.step')[step];
            if (stepElement && stepElement.querySelector('.step-button').classList.contains('active')) {
                updateVUMeter(0.8);
            }
        }
        
        function playSequencerStep(step, time) {
            // Get step data
            const steps = document.querySelectorAll('.step');
            if (step >= steps.length) return;
            
            const stepElement = steps[step];
            const isActive = stepElement.querySelector('.step-button').classList.contains('active');
            
            if (isActive) {
                // Check probability for this step
                const probSlider = stepElement.querySelector('.step-probability-slider');
                const probability = probSlider ? parseFloat(probSlider.value) : 1.0;
                
                // Skip this step based on probability
                if (Math.random() > probability) {
                    return;
                }
                
                const note = stepElement.querySelector('select').value;
                
                // Get velocity from the step
                const velocityFill = stepElement.querySelector('.step-velocity-fill');
                const velocity = velocityFill ? parseFloat(velocityFill.style.width) / 100 : 0.8;
                
                // Play the note using the mainSynth
                if (mainSynth) {
                    const voiceMode = document.getElementById('voiceMode').value;
                    
                    if (voiceMode === 'mono' || voiceMode === 'legato') {
                        mainSynth.triggerAttackRelease(note, "16n", time, velocity);
                    } else {
                        mainSynth.triggerAttackRelease(note, "16n", time, velocity);
                    }
                }
                
                // Trigger filter envelope
                if (filterEnvelope) {
                    filterEnvelope.triggerAttackRelease("16n", time);
                }
                
                // Highlight the corresponding keyboard key (async to match audio)
                Tone.Draw.schedule(() => {
                    highlightKeyboardKey(note);
                }, time);
            }
        }
        
        function playPianoRollStep(step, time) {
            // Play any active cells in the current column of the piano roll
            document.querySelectorAll(`.grid-cell[data-col="${step}"]`).forEach(cell => {
                if (cell.classList.contains('active')) {
                    const row = parseInt(cell.getAttribute('data-row'));
                    const notes = ['C4', 'B3', 'A3', 'G3', 'F3', 'E3', 'D3', 'C3'];
                    const note = notes[row];
                    
                    // Adjust velocity based on whether it's an alt note
                    const velocity = cell.classList.contains('alt') ? 0.9 : 0.7;
                    
                    // Play the note
                    if (mainSynth) {
                        mainSynth.triggerAttackRelease(note, "16n", time, velocity);
                    }
                    
                    // Trigger filter envelope
                    if (filterEnvelope) {
                        filterEnvelope.triggerAttackRelease("16n", time);
                    }
                    
                    // Highlight the corresponding keyboard key
                    Tone.Draw.schedule(() => {
                        highlightKeyboardKey(note);
                    }, time);
                }
            });
        }
        
        function highlightKeyboardKey(note) {
            // Highlight the corresponding keyboard key briefly
            const keyElement = document.querySelector(`.key[data-note="${note}"]`);
            if (keyElement) {
                keyElement.classList.add('active');
                setTimeout(() => keyElement.classList.remove('active'), 100);
            }
            
            // Check for sharp note
            if (note.includes('#')) {
                const blackKeyElement = document.querySelector(`.black-key[data-note="${note}"]`);
                if (blackKeyElement) {
                    blackKeyElement.classList.add('active');
                    setTimeout(() => blackKeyElement.classList.remove('active'), 100);
                }
            }
        }
        
        function playNote(note) {
            if (!audioInitialized || !mainSynth) return;
            
            // Check for arpeggiator mode
            const arpMode = document.getElementById('arpMode').value;
            
            if (arpMode !== 'off') {
                // Start arpeggiator with this note
                playArpeggiatedNote(note);
                return;
            }
            
            // Update active notes set
            activeNotes.add(note);
            
            // Get voice mode
            const voiceMode = document.getElementById('voiceMode').value;
            
            // Play the note differently based on voice mode
            if (voiceMode === 'mono' || voiceMode === 'legato') {
                // MonoSynth only needs triggerAttack
                mainSynth.triggerAttack(note, Tone.now());
            } else {
                // PolySynth will add this note while keeping others
                mainSynth.triggerAttack(note, Tone.now());
            }
            
            // Trigger filter envelope - Fix for filter envelope
            if (filterEnvelope) {
                filterEnvelope.triggerAttack();
            }
            
            // Update VU meter
            updateVUMeter(0.8);
            
            // Update voice counter
            updateVoiceCounter();
        }
        
        function playArpeggiatedNote(note) {
            if (!audioInitialized || !mainSynth) return;
            
            // Store the note to use as the root
            activeNotes.add(note);
            
            // Get arpeggiator settings
            const arpMode = document.getElementById('arpMode').value;
            const octaves = parseInt(document.getElementById('arpOctaves').value);
            const rateSelect = parseInt(document.getElementById('arpRate').value);
            
            // Convert rate to subdivision string
            const rateValues = ["1m", "2n", "4n", "8n", "16n", "32n", "64n", "128n"];
            const rate = rateValues[rateSelect - 1] || "8n";
            
            // Get the gate length percentage
            const gate = parseFloat(document.getElementById('arpGate').value);
            
            // Clear existing patterns
            Tone.Transport.cancel();
            
            // Generate notes based on arpeggiator mode
            let notes = [];
            
            // Get note components (e.g., "C" and "3" from "C3")
            const noteName = note.replace(/\d+/, '');
            const octave = parseInt(note.match(/\d+/)[0]);
            
            switch(arpMode) {
                case 'up':
                    // Generate ascending notes
                    for (let i = 0; i < octaves; i++) {
                        notes.push(`${noteName}${octave + i}`);
                    }
                    break;
                    
                case 'down':
                    // Generate descending notes
                    for (let i = octaves - 1; i >= 0; i--) {
                        notes.push(`${noteName}${octave + i}`);
                    }
                    break;
                    
                case 'updown':
                    // Generate up and down pattern
                    for (let i = 0; i < octaves; i++) {
                        notes.push(`${noteName}${octave + i}`);
                    }
                    for (let i = octaves - 2; i >= 0; i--) {
                        notes.push(`${noteName}${octave + i}`);
                    }
                    break;
                    
                case 'random':
                    // Generate random notes within the range
                    for (let i = 0; i < 8; i++) {
                        const randOctave = Math.floor(Math.random() * octaves);
                        notes.push(`${noteName}${octave + randOctave}`);
                    }
                    break;
                    
                case 'pattern':
                    // Create a custom pattern based on the root note
                    notes = [
                        `${noteName}${octave}`,
                        `${noteName}${octave + 1}`,
                        `${noteName}${octave}`,
                        `${noteName}${octave + 2}`
                    ];
                    break;
                    
                case 'chord':
                    // Create a chord arpeggio
                    const chord = getChordNotes(noteName, octave, 'major');
                    notes = chord;
                    break;
            }
            
            // Create the pattern
            let pattern = new Tone.Pattern((time, note) => {
                // Calculate note duration based on gate percentage
                const duration = Tone.Time(rate).toSeconds() * gate;
                
                // Play the note
                mainSynth.triggerAttackRelease(note, duration, time);
                
                // Trigger filter envelope
                if (filterEnvelope) {
                    filterEnvelope.triggerAttackRelease(duration, time);
                }
                
                // Update UI (with slight delay for visual feedback)
                Tone.Draw.schedule(() => {
                    highlightKeyboardKey(note);
                    updateVUMeter(0.7);
                }, time);
                
            }, notes, 'up');
            
            // Start the pattern
            pattern.start(0);
            Tone.Transport.start();
        }
        
        function getChordNotes(root, octave, type) {
            // Define chord intervals
            const chordTypes = {
                'major': [0, 4, 7],
                'minor': [0, 3, 7],
                'dom7': [0, 4, 7, 10],
                'maj7': [0, 4, 7, 11],
                'min7': [0, 3, 7, 10],
                'sus4': [0, 5, 7],
                'dim': [0, 3, 6],
                'aug': [0, 4, 8]
            };
            
            // Map note names to semitone values
            const noteValues = {
                'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3,
                'E': 4, 'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8,
                'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11
            };
            
            // Get the root note value
            const rootValue = noteValues[root];
            
            // Get the intervals for this chord type
            const intervals = chordTypes[type] || chordTypes.major;
            
            // Generate the chord notes
            return intervals.map(interval => {
                // Calculate the note value
                const noteValue = (rootValue + interval) % 12;
                
                // Get the note name
                const noteName = Object.keys(noteValues).find(key => noteValues[key] === noteValue && !key.includes('b'));
                
                // Calculate the octave shift
                const octaveShift = Math.floor((rootValue + interval) / 12);
                
                // Return the note
                return `${noteName}${octave + octaveShift}`;
            });
        }
        
        function releaseNote(note) {
            if (!audioInitialized || !mainSynth) return;
            
            // Check for arpeggiator mode
            const arpMode = document.getElementById('arpMode').value;
            
            if (arpMode !== 'off') {
                // Stop the arpeggiator
                Tone.Transport.stop();
                Tone.Transport.cancel();
                activeNotes.clear();
                return;
            }
            
            // Remove from active notes
            activeNotes.delete(note);
            
            // Get voice mode
            const voiceMode = document.getElementById('voiceMode').value;
            
            // Release note differently based on voice mode
            if (voiceMode === 'mono' || voiceMode === 'legato') {
                // Only release if this was the last note
                if (activeNotes.size === 0) {
                    mainSynth.triggerRelease();
                    // Release filter envelope
                    if (filterEnvelope) {
                        filterEnvelope.triggerRelease();
                    }
                } else if (voiceMode === 'mono') {
                    // For mono mode, retrigger the last pressed note
                    const lastNote = Array.from(activeNotes).pop();
                    mainSynth.triggerAttack(lastNote, Tone.now());
                }
            } else {
                // For poly synth, just release this specific note
                mainSynth.triggerRelease(note, Tone.now());
                
                // Release filter envelope only if all notes are released
                if (activeNotes.size === 0 && filterEnvelope) {
                    filterEnvelope.triggerRelease();
                }
            }
            
            // Update VU meter (gradually fade)
            const vuMeter = document.getElementById('vuMeter');
            gsap.to(vuMeter, {
                width: activeNotes.size > 0 ? '50%' : '0%',
                duration: 0.3,
                ease: "power2.out"
            });
            
            // Update voice counter
            updateVoiceCounter();
        }
        
        function playNotePreview(note) {
            if (!audioInitialized || !mainSynth) return;
            
            // Play a short note for preview purposes
            mainSynth.triggerAttackRelease(note, "16n", Tone.now());
            
            // Trigger filter envelope
            if (filterEnvelope) {
                filterEnvelope.triggerAttackRelease("16n");
            }
            
            // Flash the VU meter
            updateVUMeter(0.6);
            setTimeout(() => {
                if (activeNotes.size === 0) {
                    updateVUMeter(0);
                }
            }, 100);
        }
        
        function updateVoiceCounter() {
            if (!audioInitialized) return;
            
            // In a real implementation, this would show the actual voice count
            // For now, we'll use the activeNotes size as an approximation
            document.getElementById('voiceCount').textContent = activeNotes.size;
        }
        
        function addModConnection() {
            const source = document.getElementById('modSource').value;
            const target = document.getElementById('modTarget').value;
            
            if (!source || !target) {
                showNotification('error', 'Please select both source and target');
                return;
            }
            
            const matrixElement = document.querySelector('.mod-matrix');
            
            const connection = document.createElement('div');
            connection.className = 'mod-connection';
            connection.innerHTML = `
                <div class="mod-connection-header">
                    <div class="mod-source-target">
                        <span class="mod-source">${source}</span> → <span class="mod-target">${target}</span>
                    </div>
                    <button class="mod-remove"><i class="fas fa-times"></i></button>
                </div>
                <input type="range" class="mod-amount-slider" min="-1" max="1" step="0.01" value="0.5">
                <div class="mod-amount-value">+50%</div>
            `;
            
            // Add event listener for the remove button
            connection.querySelector('.mod-remove').addEventListener('click', function() {
                matrixElement.removeChild(connection);
                
                // If audio is initialized, remove the modulation connection
                if (audioInitialized) {
                    // This would disconnect the modulation in a full implementation
                }
            });
            
            // Add event listener for the slider
            connection.querySelector('.mod-amount-slider').addEventListener('input', function(e) {
                const value = parseFloat(e.target.value);
                connection.querySelector('.mod-amount-value').textContent = 
                    value >= 0 ? `+${Math.round(value * 100)}%` : `${Math.round(value * 100)}%`;
                
                // If audio is initialized, update the modulation amount
                if (audioInitialized) {
                    applyModulation(source, target, value);
                }
            });
            
            matrixElement.appendChild(connection);
            
            // Reset selectors
            document.getElementById('modSource').value = '';
            document.getElementById('modTarget').value = '';
            
            // If audio is initialized, create the modulation connection
            if (audioInitialized) {
                applyModulation(source, target, 0.5);
            }
            
            showNotification('success', `Added modulation: ${source} → ${target}`);
        }
        
        function applyModulation(source, target, amount) {
            if (!audioInitialized) return;
            
            // Implement modulation connections
            console.log(`Applying modulation: ${source} → ${target} (${amount})`);
            
            // Example implementation for some common modulations
            if (source === "lfo1") {
                if (target === "filterCutoff") {
                    // Scale the modulation amount appropriately
                    const modAmount = amount * 2000; // Scale to filter range
                    
                    // Connect LFO to filter frequency
                    lfo1.disconnect();
                    lfo1.connect(mainFilter.frequency);
                    lfo1.amplitude.value = Math.abs(modAmount);
                    
                    // Set the base frequency based on sign of amount
                    if (amount >= 0) {
                        mainFilter.frequency.value = 2000;
                    } else {
                        mainFilter.frequency.value = 4000;
                    }
                } else if (target === "osc1pitch") {
                    // Pitch modulation would be implemented differently 
                    // This is a simplified example
                    const modAmount = amount * 100; // Scale to cents range
                    lfo1.disconnect();
                    // In a real implementation, this would connect to the oscillator pitch
                    
                    showNotification('info', 'LFO1 modulating OSC1 pitch');
                }
            } else if (source === "lfo2") {
                if (target === "pan") {
                    const modAmount = amount;
                    
                    // Connect LFO to panner
                    lfo2.disconnect();
                    // In a real implementation, this would connect to a panner node
                    
                    showNotification('info', 'LFO2 modulating pan position');
                }
            } else if (source === "velocity") {
                if (target.includes("level")) {
                    // In a real synth, this would set up velocity sensitivity
                    showNotification('info', 'Velocity modulating level');
                }
            } else if (source === "modwheel") {
                // Modwheel connections would be handled through MIDI CC 1
                showNotification('info', 'Modwheel connection established');
            }
        }
        
        // MIDI Learn functionality
        function startMIDILearn(knob) {
            if (!audioInitialized) {
                showNotification('error', 'Audio must be initialized first');
                return;
            }
            
            // Stop any previous MIDI learn
            stopMIDILearn();
            
            // Set the target knob
            midiLearnTarget = knob;
            midiLearnActive = true;
            
            // Add a visual indicator
            document.body.classList.add('midi-learn-active');
            midiLearnTarget.classList.add('midi-learn-active');
            
            // Update status in the modal
            document.getElementById('midiLearnStatus').textContent = `Waiting for MIDI input... Move a controller to assign to ${knob.id.replace('Knob', '')}`;
            document.getElementById('midiLearnModal').classList.add('active');
            
            showNotification('info', 'MIDI Learn active - move a controller');
        }
        
        function startGlobalMIDILearn() {
            // Set global MIDI learn mode without a specific target
            midiLearnActive = true;
            document.body.classList.add('midi-learn-active');
            
            // Update status in the modal
            document.getElementById('midiLearnStatus').textContent = 'Waiting for MIDI input... Move a controller, then click a parameter to assign';
            
            showNotification('info', 'MIDI Learn active - move a controller, then click a knob');
        }
        
        function stopMIDILearn() {
            // Clear MIDI learn mode
            midiLearnActive = false;
            midiLearnTarget = null;
            
            // Remove visual indicators
            document.body.classList.remove('midi-learn-active');
            document.querySelectorAll('.midi-learn-active').forEach(el => {
                el.classList.remove('midi-learn-active');
            });
            
            // Update status in the modal
            document.getElementById('midiLearnStatus').textContent = 'MIDI Learn inactive';
        }
        
        function handleMIDILearn(ccNumber, value) {
            if (!midiLearnActive) return;
            
            if (midiLearnTarget) {
                // Map this CC to the target knob
                const knobId = midiLearnTarget.id;
                const paramId = knobId.replace('Knob', '');
                
                // Add to mappings
                midiMappings.set(ccNumber, {
                    paramId: paramId,
                    knobId: knobId,
                    name: paramId
                });
                
                // Add to the MIDI mappings list
                addMappingToList(ccNumber, paramId);
                
                showNotification('success', `MIDI CC ${ccNumber} mapped to ${paramId}`);
                
                // Stop MIDI learn mode
                stopMIDILearn();
            } else {
                // In global mode, we store the CC and wait for user to click a knob
                const ccValue = value;
                
                // Update status
                document.getElementById('midiLearnStatus').textContent = `CC ${ccNumber} detected (${value}) - Now click a parameter to assign`;
                
                // Setup event handler for the next knob click
                const knobClickHandler = function(e) {
                    const knob = e.currentTarget;
                    const knobId = knob.id;
                    const paramId = knobId.replace('Knob', '');
                    
                    // Add to mappings
                    midiMappings.set(ccNumber, {
                        paramId: paramId,
                        knobId: knobId,
                        name: paramId
                    });
                    
                    // Add to the MIDI mappings list
                    addMappingToList(ccNumber, paramId);
                    
                    showNotification('success', `MIDI CC ${ccNumber} mapped to ${paramId}`);
                    
                    // Remove the one-time event listeners
                    document.querySelectorAll('.knob').forEach(k => {
                        k.removeEventListener('click', knobClickHandler);
                    });
                    
                    // Stop MIDI learn mode
                    stopMIDILearn();
                };
                
                // Add one-time click event to all knobs
                document.querySelectorAll('.knob').forEach(knob => {
                    knob.addEventListener('click', knobClickHandler, { once: true });
                });
            }
        }
        
        function addMappingToList(ccNumber, paramName) {
            const list = document.getElementById('midiMappingsList');
            
            // Create a new mapping item
            const item = document.createElement('div');
            item.style.padding = '5px';
            item.style.display = 'flex';
            item.style.justifyContent = 'space-between';
            item.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
            
            item.innerHTML = `
                <span>${paramName}</span>
                <span>CC ${ccNumber}</span>
                <button class="mod-remove" data-cc="${ccNumber}"><i class="fas fa-times"></i></button>
            `;
            
            // Add remove handler
            item.querySelector('.mod-remove').addEventListener('click', function() {
                const cc = this.getAttribute('data-cc');
                midiMappings.delete(parseInt(cc));
                list.removeChild(item);
                showNotification('info', `Removed MIDI mapping for CC ${cc}`);
            });
            
            list.appendChild(item);
        }
        
        function clearAllMIDIMappings() {
            midiMappings.clear();
            
            // Clear the list UI
            const list = document.getElementById('midiMappingsList');
            list.innerHTML = '';
        }
        
        function setupVisualizers() {
            // Set up oscilloscope (using the analyzer from Tone.js)
            const oscilloscopeCanvas = document.getElementById('oscilloscope');
            const ctx = oscilloscopeCanvas.getContext('2d');
            
            function resizeCanvas() {
                oscilloscopeCanvas.width = oscilloscopeCanvas.offsetWidth;
                oscilloscopeCanvas.height = oscilloscopeCanvas.offsetHeight;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            function drawOscilloscope() {
                requestAnimationFrame(drawOscilloscope);
                
                if (!audioInitialized || !analyzer) return;
                
                const width = oscilloscopeCanvas.width;
                const height = oscilloscopeCanvas.height;
                
                // Clear canvas
                ctx.fillStyle = 'rgba(18, 18, 18, 0.3)';
                ctx.fillRect(0, 0, width, height);
                
                // Get waveform data from analyzer
                const waveform = analyzer.getValue();
                
                // Draw the waveform
                ctx.beginPath();
                ctx.strokeStyle = '#00e5ff';
                ctx.lineWidth = 2;
                
                for (let i = 0; i < waveform.length; i++) {
                    const x = (i / waveform.length) * width;
                    const y = ((waveform[i] + 1) / 2) * height;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.stroke();
            }
            
            drawOscilloscope();
            
            // Set up spectrum analyzer
            const analyzerCanvas = document.getElementById('analyzer');
            const analyzerCtx = analyzerCanvas.getContext('2d');
            
            function resizeAnalyzerCanvas() {
                analyzerCanvas.width = analyzerCanvas.offsetWidth;
                analyzerCanvas.height = analyzerCanvas.offsetHeight;
            }
            
            resizeAnalyzerCanvas();
            window.addEventListener('resize', resizeAnalyzerCanvas);
            
            // Create a separate FFT analyzer for the spectrum
            let fftAnalyzer;
            
            function setupFFTAnalyzer() {
                if (!audioInitialized) return;
                
                fftAnalyzer = new Tone.Analyser("fft", 1024);
                masterVolNode.connect(fftAnalyzer);
            }
            
            function drawAnalyzer() {
                requestAnimationFrame(drawAnalyzer);
                
                const width = analyzerCanvas.width;
                const height = analyzerCanvas.height;
                
                // Clear canvas
                analyzerCtx.fillStyle = 'rgba(18, 18, 18, 0.3)';
                analyzerCtx.fillRect(0, 0, width, height);
                
                if (!audioInitialized || !fftAnalyzer) {
                    // If audio not initialized, draw simulated analyzer
                    drawSimulatedAnalyzer();
                    return;
                }
                
                // Get FFT data
                const fftData = fftAnalyzer.getValue();
                
                // Draw frequency bars
                const barCount = fftData.length / 4; // Use a quarter of the FFT data for better visual
                const barWidth = width / barCount;
                
                for (let i = 0; i < barCount; i++) {
                    const x = i * barWidth;
                    
                    // Map FFT data (dB) to height
                    // FFT data is typically in range -100 to 0 (dB)
                    const fftValue = fftData[i];
                    const normalized = (fftValue + 90) / 70; // Normalize to 0-1 range
                    const barHeight = Math.max(2, normalized * height * 0.95);
                    
                    // Use color gradient based on frequency
                    const hue = 220 + (i / barCount) * 60; // Blue to purple gradient
                    analyzerCtx.fillStyle = `hsl(${hue}, 80%, 60%)`;
                    analyzerCtx.fillRect(x, height - barHeight, barWidth - 1, barHeight);
                }
            }
            
            function drawSimulatedAnalyzer() {
                const width = analyzerCanvas.width;
                const height = analyzerCanvas.height;
                const barCount = 64;
                const barWidth = width / barCount;
                const now = Date.now() / 1000;
                
                for (let i = 0; i < barCount; i++) {
                    const x = i * barWidth;
                    
                    // Generate a height based on a combination of sine waves for a dynamic effect
                    const normalizedFreq = i / barCount;
                    const t = now * 2;
                    
                    let barHeight = (
                        0.5 + 0.3 * Math.sin(normalizedFreq * 10 + t) +
                        0.2 * Math.sin(normalizedFreq * 20 + t * 1.5) +
                        0.1 * Math.sin(normalizedFreq * 30 + t * 0.7)
                    ) * height * 0.8;
                    
                    // Make the middle frequencies taller
                    barHeight *= 0.5 + Math.sin(Math.PI * normalizedFreq) * 0.5;
                    
                    // Ensure minimum height
                    barHeight = Math.max(2, barHeight);
                    
                    // Draw the bar
                    const hue = 220 + normalizedFreq * 60; // Blue to purple gradient
                    analyzerCtx.fillStyle = `hsl(${hue}, 80%, 60%)`;
                    analyzerCtx.fillRect(x, height - barHeight, barWidth - 1, barHeight);
                }
            }
            
            drawAnalyzer();
            
            // When audio is initialized, set up the FFT analyzer
            document.addEventListener('audioInitialized', setupFFTAnalyzer);
        }
        
        function setupMIDI() {
            document.getElementById('midiButton').addEventListener('click', function() {
                showNotification('info', 'Scanning for MIDI devices...');
                
                if (navigator.requestMIDIAccess) {
                    navigator.requestMIDIAccess().then(
                        (midiAccess) => {
                            // Initialize audio first if needed
                            initAudio().then(() => {
                                setupMIDIDevices(midiAccess);
                            });
                        },
                        () => {
                            showNotification('error', 'Could not access MIDI devices');
                        }
                    );
                } else {
                    showNotification('error', 'Web MIDI API not supported by your browser');
                }
            });
        }
        
        function setupMIDIDevices(midiAccess) {
            const inputs = midiAccess.inputs.values();
            let deviceFound = false;
            
            // Create dropdown for MIDI device selection
            const deviceSelect = document.createElement('select');
            deviceSelect.style.marginLeft = '10px';
            deviceSelect.style.padding = '6px 10px';
            deviceSelect.style.borderRadius = '6px';
            deviceSelect.style.background = 'var(--surface-light)';
            deviceSelect.style.color = 'var(--text)';
            deviceSelect.style.border = 'none';
            
            // Add default option
            deviceSelect.innerHTML = '<option value="">Select MIDI Device</option>';
            
            // Add each MIDI input device
            for (let input = inputs.next(); input && !input.done; input = inputs.next()) {
                deviceFound = true;
                
                // Add to dropdown
                const option = document.createElement('option');
                option.value = input.value.id;
                option.textContent = input.value.name || 'Unknown Device';
                deviceSelect.appendChild(option);
                
                // Connect the MIDI input to our handler
                input.value.onmidimessage = handleMIDIMessage;
                
                showNotification('success', `MIDI Device Found: ${input.value.name || 'Unknown Device'}`);
            }
            
            if (!deviceFound) {
                showNotification('info', 'No MIDI devices found');
            } else {
                // Add the device selector to the MIDI button
                const midiButton = document.getElementById('midiButton');
                midiButton.parentNode.insertBefore(deviceSelect, midiButton.nextSibling);
                
                // Add change handler
                deviceSelect.addEventListener('change', function() {
                    const selectedDeviceId = this.value;
                    
                    if (selectedDeviceId) {
                        // Connect to the selected device
                        const selectedDevice = midiAccess.inputs.get(selectedDeviceId);
                        
                        if (selectedDevice) {
                            // Disconnect all other devices
                            midiAccess.inputs.forEach(input => {
                                input.onmidimessage = null;
                            });
                            
                            // Connect this device
                            selectedDevice.onmidimessage = handleMIDIMessage;
                            
                            showNotification('success', `Connected to ${selectedDevice.name}`);
                        }
                    }
                });
            }
        }
        
        function handleMIDIMessage(message) {
            const command = message.data[0];
            const note = message.data[1];
            const velocity = message.data[2] / 127; // MIDI velocity is 0-127
            
            // MIDI CC Messages
            if ((command >= 176 && command <= 191)) {
                const ccNumber = note; // The second byte is the CC number
                const ccValue = velocity; // The third byte is the value (0-1)
                
                console.log(`MIDI CC: ${ccNumber}, Value: ${ccValue}`);
                
                // Handle MIDI learn if active
                if (midiLearnActive) {
                    handleMIDILearn(ccNumber, ccValue);
                    return;
                }
                
                // Check if this CC is mapped to a parameter
                if (midiMappings.has(ccNumber)) {
                    const mapping = midiMappings.get(ccNumber);
                    const input = document.getElementById(mapping.paramId);
                    
                    if (input) {
                        // Scale the MIDI value to the parameter range
                        const min = parseFloat(input.min);
                        const max = parseFloat(input.max);
                        const paramValue = min + ccValue * (max - min);
                        
                        // Set the parameter value
                        input.value = paramValue;
                        
                        // Trigger input event
                        input.dispatchEvent(new Event('input'));
                        
                        // Update knob rotation
                        const knob = document.getElementById(mapping.knobId);
                        if (knob) {
                            const min = parseFloat(input.min);
                            const max = parseFloat(input.max);
                            const rotation = ((paramValue - min) / (max - min)) * 270 - 135;
                            knob.style.transform = `rotate(${rotation}deg)`;
                        }
                    }
                }
                
                return;
            }
            
            // Convert MIDI note number to note name
            const noteName = midiNoteToName(note);
            
            // Note on message (with velocity > 0)
            if ((command >= 144 && command <= 159) && (velocity > 0)) {
                // Play the note
                playNote(noteName);
                
                // Highlight the keyboard key
                highlightKeyboardKey(noteName);
                
            // Note off message or note on with velocity 0
            } else if ((command >= 128 && command <= 143) || ((command >= 144 && command <= 159) && (velocity === 0))) {
                // Release the note
                releaseNote(noteName);
            }
        }
        
        function midiNoteToName(midiNote) {
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const octave = Math.floor(midiNote / 12) - 1;
            const noteName = noteNames[midiNote % 12];
            
            return `${noteName}${octave}`;
        }
        
        function exportSynthState(format) {
            if (!audioInitialized) {
                initAudio().then(() => {
                    performExport(format);
                });
            } else {
                performExport(format);
            }
        }
        
        function performExport(format) {
            showNotification('info', `Preparing ${format} export...`);
            
            // Collect all the current synth settings
            const synthState = {
                version: "3.0",
                name: document.getElementById('presetName').value || "Untitled Preset",
                date: new Date().toISOString(),
                
                // Oscillator settings
                oscillators: {
                    osc1: {
                        type: document.getElementById('osc1Type').value,
                        active: document.getElementById('osc1Active').checked,
                        octave: parseInt(document.getElementById('osc1Octave').value),
                        semi: parseInt(document.getElementById('osc1Semi').value),
                        detune: parseInt(document.getElementById('osc1Detune').value),
                        level: parseFloat(document.getElementById('osc1Level').value),
                        fmAmount: parseInt(document.getElementById('osc1FMAmount').value),
                        fmRatio: parseFloat(document.getElementById('osc1FMRatio').value)
                    },
                    osc2: {
                        type: document.getElementById('osc2Type').value,
                        active: document.getElementById('osc2Active').checked,
                        octave: parseInt(document.getElementById('osc2Octave').value),
                        semi: parseInt(document.getElementById('osc2Semi').value),
                        detune: parseInt(document.getElementById('osc2Detune').value),
                        level: parseFloat(document.getElementById('osc2Level').value),
                        sync: document.getElementById('osc2Sync').checked,
                        syncAmount: parseInt(document.getElementById('osc2SyncAmount').value)
                    },
                    osc3: {
                        type: document.getElementById('osc3Type').value,
                        active: document.getElementById('osc3Active').checked,
                        octave: parseInt(document.getElementById('osc3Octave').value),
                        semi: parseInt(document.getElementById('osc3Semi').value),
                        detune: parseInt(document.getElementById('osc3Detune').value),
                        level: parseFloat(document.getElementById('osc3Level').value),
                        ringMod: document.getElementById('osc3RingMod').checked,
                        ringModSource: document.getElementById('osc3RingModSource').value
                    }
                },
                
                // Voice settings
                voice: {
                    mode: document.getElementById('voiceMode').value,
                    unisonVoices: parseInt(document.getElementById('unisonVoices').value),
                    unisonSpread: parseInt(document.getElementById('unisonSpread').value),
                    portamento: parseFloat(document.getElementById('portamento').value)
                },
                
                // Filter settings
                filter: {
                    type: document.getElementById('filter1Type').value,
                    slope: parseInt(document.getElementById('filter1Slope').value),
                    cutoff: parseInt(document.getElementById('filter1Cutoff').value),
                    resonance: parseFloat(document.getElementById('filter1Res').value),
                    envAmount: parseInt(document.getElementById('filter1Env').value),
                    keyTrack: parseInt(document.getElementById('filter1KeyTrack').value),
                    drive: parseInt(document.getElementById('filter1Drive').value),
                    lfoAmount: parseInt(document.getElementById('filter1LFOAmt').value)
                },
                
                // Envelope settings
                envelopes: {
                    amp: {
                        attack: parseFloat(document.getElementById('env1Attack').value),
                        decay: parseFloat(document.getElementById('env1Decay').value),
                        sustain: parseFloat(document.getElementById('env1Sustain').value),
                        release: parseFloat(document.getElementById('env1Release').value),
                        curve: parseFloat(document.getElementById('env1Curve').value),
                        velocity: parseInt(document.getElementById('env1Vel').value),
                        hold: parseFloat(document.getElementById('env1Hold').value)
                    },
                    filter: {
                        attack: parseFloat(document.getElementById('env2Attack').value),
                        decay: parseFloat(document.getElementById('env2Decay').value),
                        sustain: parseFloat(document.getElementById('env2Sustain').value),
                        release: parseFloat(document.getElementById('env2Release').value),
                        curve: parseFloat(document.getElementById('env2Curve').value),
                        velocity: parseInt(document.getElementById('env2Vel').value),
                        amount: parseInt(document.getElementById('env2Amount').value)
                    }
                },
                
                // LFO settings
                lfos: {
                    lfo1: {
                        type: document.getElementById('lfo1Type').value,
                        sync: document.getElementById('lfo1Sync').value,
                        rate: parseFloat(document.getElementById('lfo1Rate').value),
                        depth: parseFloat(document.getElementById('lfo1Depth').value),
                        phase: parseInt(document.getElementById('lfo1Phase').value),
                        delay: parseFloat(document.getElementById('lfo1Delay').value),
                        bpmSync: document.getElementById('lfo1BPMSync').checked,
                        tempoDivision: document.getElementById('lfo1TempoDivision').value
                    },
                    lfo2: {
                        type: document.getElementById('lfo2Type').value,
                        sync: document.getElementById('lfo2Sync').value,
                        rate: parseFloat(document.getElementById('lfo2Rate').value),
                        depth: parseFloat(document.getElementById('lfo2Depth').value),
                        phase: parseInt(document.getElementById('lfo2Phase').value),
                        delay: parseFloat(document.getElementById('lfo2Delay').value),
                        bpmSync: document.getElementById('lfo2BPMSync').checked,
                        tempoDivision: document.getElementById('lfo2TempoDivision').value
                    }
                },
                
                // Effect settings
                effects: {
                    reverb: {
                        active: true,
                        mix: parseFloat(document.getElementById('reverbMix').value),
                        decay: parseFloat(document.getElementById('reverbDecay').value),
                        damping: parseFloat(document.getElementById('reverbDamping').value),
                        preDelay: parseFloat(document.getElementById('reverbPreDelay').value)
                    },
                    delay: {
                        active: true,
                        mix: parseFloat(document.getElementById('delayMix').value),
                        time: parseFloat(document.getElementById('delayTime').value),
                        feedback: parseFloat(document.getElementById('delayFeedback').value),
                        filter: parseInt(document.getElementById('delayFilter').value)
                    },
                    distortion: {
                        active: true,
                        amount: parseFloat(document.getElementById('distortionAmount').value),
                        tone: parseFloat(document.getElementById('distortionTone').value),
                        type: document.getElementById('distortionType').value,
                        mix: parseFloat(document.getElementById('distortionMix').value)
                    }
                    // Additional effects would be included here
                },
                
                // Master settings
                master: {
                    volume: parseFloat(document.getElementById('masterVolume').value),
                    tempo: parseInt(document.getElementById('tempo').value),
                    pan: parseFloat(document.getElementById('pan').value),
                    limiter: parseFloat(document.getElementById('limiter').value)
                },
                
                // Arpeggiator settings
                arpeggiator: {
                    mode: document.getElementById('arpMode').value,
                    octaves: parseInt(document.getElementById('arpOctaves').value),
                    rate: parseInt(document.getElementById('arpRate').value),
                    gate: parseFloat(document.getElementById('arpGate').value)
                },
                
                // Sequencer pattern data
                sequencer: {
                    pattern: sequencerPattern,
                    pianoRoll: getPianoRollData()
                },
                
                // MIDI mappings
                midiMappings: Array.from(midiMappings.entries()).map(([cc, mapping]) => ({
                    cc,
                    paramId: mapping.paramId,
                    name: mapping.name
                }))
            };
            
            // Create the export data based on format
            let exportData;
            let fileName;
            let mimeType;
            
            switch(format) {
                case 'preset':
                    // Export as JSON preset file
                    exportData = JSON.stringify(synthState, null, 2);
                    fileName = `${synthState.name.replace(/\s+/g, '_')}.sxp`;
                    mimeType = 'application/json';
                    break;
                    
                case 'midi':
                    // Convert sequencer pattern to MIDI file
                    exportData = createMIDIFile(synthState);
                    fileName = `${synthState.name.replace(/\s+/g, '_')}.mid`;
                    mimeType = 'audio/midi';
                    break;
                    
                case 'wav':
                    // Export current sound as audio
                    exportAudioFile(synthState);
                    return; // This is handled asynchronously
                    
                case 'project':
                    // Export as project file (including sequencer data)
                    exportData = JSON.stringify(synthState, null, 2);
                    fileName = `${synthState.name.replace(/\s+/g, '_')}.sxproj`;
                    mimeType = 'application/json';
                    break;
                    
                default:
                    showNotification('error', 'Unknown export format');
                    return;
            }
            
            // Create and download file
            const blob = new Blob([exportData], { type: mimeType });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            
            // Clean up
            URL.revokeObjectURL(url);
            
            showNotification('success', `Export complete: ${fileName}`);
            document.getElementById('shareModal').classList.remove('active');
        }
        
        function getPianoRollData() {
            // Collect piano roll data from UI
            const pianoRollData = [];
            
            document.querySelectorAll('.grid-cell.active').forEach(cell => {
                const row = parseInt(cell.getAttribute('data-row'));
                const col = parseInt(cell.getAttribute('data-col'));
                const isAlt = cell.classList.contains('alt');
                
                pianoRollData.push({
                    row,
                    col,
                    isAlt
                });
            });
            
            return pianoRollData;
        }
        
        function createMIDIFile(synthState) {
            // Simplified - in a real implementation this would use a MIDI library
            showNotification('info', 'Creating MIDI file from sequencer data');
            
            // Return a simple placeholder MIDI file
            return new Uint8Array([
                0x4d, 0x54, 0x68, 0x64, // "MThd" - MIDI header
                0x00, 0x00, 0x00, 0x06, // Header length
                0x00, 0x01, // Format type 1
                0x00, 0x01, // One track
                0x01, 0xE0, // Ticks per quarter note (480)
                0x4d, 0x54, 0x72, 0x6B // "MTrk" - Start of track
                // More MIDI data would go here
            ]);
        }
        
        function exportAudioFile(synthState) {
            showNotification('info', 'Recording audio... Please wait');
            
            // Setup a recorder
            const recorder = new Tone.Recorder();
            masterVolNode.connect(recorder);
            
            // Start recording
            recorder.start();
            
            // Play a note for 2 seconds
            const now = Tone.now();
            mainSynth.triggerAttack('C3', now);
            mainSynth.triggerRelease('C3', now + 2);
            
            // Stop recording after 3 seconds
            setTimeout(async () => {
                const recording = await recorder.stop();
                
                // Create a download link
                const url = URL.createObjectURL(recording);
                const anchor = document.createElement('a');
                anchor.download = `${synthState.name.replace(/\s+/g, '_')}.wav`;
                anchor.href = url;
                anchor.click();
                
                // Clean up
                URL.revokeObjectURL(url);
                
                showNotification('success', 'Audio recording complete');
                document.getElementById('shareModal').classList.remove('active');
            }, 3000);
        }
        
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Space bar toggle play/stop
                if (e.key === ' ' && !e.repeat) {
                    // Initialize audio if needed
                    if (!audioInitialized) {
                        initAudio().then(() => {
                            toggleSequencer();
                        });
                    } else {
                        toggleSequencer();
                    }
                    e.preventDefault();
                }
                
                // F1 or ? shows shortcuts
                if (e.key === 'F1' || e.key === '?') {
                    document.getElementById('shortcutsModal').classList.add('active');
                    e.preventDefault();
                }
                
                // Z/X for octave down/up
                if (e.key === 'z') {
                    document.getElementById('octaveDown').click();
                    e.preventDefault();
                }
                
                if (e.key === 'x') {
                    document.getElementById('octaveUp').click();
                    e.preventDefault();
                }
                
                // 1-8 keys for quick chord buttons
                if (e.key >= '1' && e.key <= '8') {
                    const index = parseInt(e.key) - 1;
                    const chordButtons = document.querySelectorAll('.chord-button');
                    if (index < chordButtons.length) {
                        // Simulate chord button click
                        const chordType = chordButtons[index].getAttribute('data-chord');
                        
                        // Initialize audio if needed
                        if (!audioInitialized) {
                            initAudio().then(() => {
                                playChord('C', chordType);
                            });
                        } else {
                            playChord('C', chordType);
                        }
                        
                        // Visual feedback
                        chordButtons[index].style.background = 'var(--primary)';
                        chordButtons[index].style.color = 'white';
                        setTimeout(() => {
                            chordButtons[index].style.background = '';
                            chordButtons[index].style.color = '';
                        }, 200);
                    }
                }
                
                // R for record
                if (e.key === 'r' && !e.repeat) {
                    const recordButton = document.getElementById('recordDrumButton');
                    recordButton.click();
                }
                
                // C for chaos/randomize
                if (e.key === 'c' && !e.repeat && !e.ctrlKey) {
                    // Fix 2: Check audioInitialized before calling randomizeParameters
                    // This ensures we don't try to access audio objects before they're ready
                    if (!audioInitialized) {
                        initAudio().then(() => {
                            randomizeParameters();
                        });
                    } else {
                        randomizeParameters();
                    }
                }
                
                // M for MIDI learn
                if (e.key === 'm' && !e.repeat) {
                    document.getElementById('midiLearnButton').click();
                }
                
                // Save preset with Ctrl+S
                if (e.key === 's' && e.ctrlKey) {
                    e.preventDefault();
                    document.querySelector('.preset-action-btn.save').click();
                }
                
                // Computer keyboard piano
                const keyMap = {
                    'a': 'C3', 'w': 'C#3', 's': 'D3', 'e': 'D#3', 'd': 'E3', 'f': 'F3', 
                    't': 'F#3', 'g': 'G3', 'y': 'G#3', 'h': 'A3', 'u': 'A#3', 'j': 'B3',
                    'k': 'C4', 'o': 'C#4', 'l': 'D4', 'p': 'D#4', ';': 'E4', "'": 'F4'
                };
                
                if (keyMap[e.key] && !e.repeat) {
                    // Initialize audio if needed
                    if (!audioInitialized) {
                        initAudio().then(() => {
                            playNote(keyMap[e.key]);
                            highlightKeyboardKey(keyMap[e.key]);
                        });
                    } else {
                        playNote(keyMap[e.key]);
                        highlightKeyboardKey(keyMap[e.key]);
                    }
                    
                    // Show chord suggestion
                    const chordFinder = document.getElementById('chordFinder');
                    const activeKeys = [...document.querySelectorAll('.key.active, .black-key.active')].map(k => k.getAttribute('data-note'));
                    
                    if (activeKeys.length >= 3) {
                        chordFinder.textContent = `Chord: ${detectChord(activeKeys)}`;
                        chordFinder.classList.add('visible');
                    }
                }
                
                // QWERASDF for drum pads
                const drumKeyMap = {
                    'q': 'kick', 'w': 'snare', 'e': 'hihat', 'r': 'clap',
                    'a': 'tom1', 's': 'tom2', 'd': 'crash', 'f': 'ride'
                };
                
                if (drumKeyMap[e.key] && !e.repeat) {
                    const drumPad = document.querySelector(`.drum-pad[data-sound="${drumKeyMap[e.key]}"]`);
                    if (drumPad) {
                        // Simulate drum pad hit
                        drumPad.classList.add('active');
                        setTimeout(() => drumPad.classList.remove('active'), 100);
                        
                        // Initialize audio if needed
                        if (!audioInitialized) {
                            initAudio().then(() => {
                                playDrumSound(drumKeyMap[e.key]);
                            });
                        } else {
                            playDrumSound(drumKeyMap[e.key]);
                        }
                    }
                }
            });
            
            // Add keyup event for releasing notes
            document.addEventListener('keyup', function(e) {
                const keyMap = {
                    'a': 'C3', 'w': 'C#3', 's': 'D3', 'e': 'D#3', 'd': 'E3', 'f': 'F3', 
                    't': 'F#3', 'g': 'G3', 'y': 'G#3', 'h': 'A3', 'u': 'A#3', 'j': 'B3',
                    'k': 'C4', 'o': 'C#4', 'l': 'D4', 'p': 'D#4', ';': 'E4', "'": 'F4'
                };
                
                if (keyMap[e.key] && audioInitialized) {
                    releaseNote(keyMap[e.key]);
                }
            });
        }
        
        function randomizeParameters() {
            showNotification('info', 'Chaos Mode Activated!');
            
            // Only try to use audio components if they're initialized
            if (audioInitialized) {
                // Random oscillator settings that won't break synthesis
                document.querySelectorAll('#osc1Type, #osc2Type, #osc3Type').forEach(select => {
                    const options = select.querySelectorAll('option');
                    const randomIndex = Math.floor(Math.random() * options.length);
                    select.selectedIndex = randomIndex;
                    select.dispatchEvent(new Event('change'));
                });
                
                // Safe knob ranges to randomize
                const safeKnobsToRandomize = [
                    { id: 'osc1Detune', min: -20, max: 20 },
                    { id: 'osc2Detune', min: -20, max: 20 },
                    { id: 'osc3Detune', min: -20, max: 20 },
                    { id: 'filter1Cutoff', min: 500, max: 8000 },
                    { id: 'filter1Res', min: 0, max: 8 },
                    { id: 'env1Attack', min: 0.01, max: 0.5 },
                    { id: 'env1Decay', min: 0.1, max: 0.8 },
                    { id: 'env1Sustain', min: 0.2, max: 0.8 },
                    { id: 'env1Release', min: 0.1, max: 1.0 },
                    { id: 'env2Attack', min: 0.01, max: 0.5 },
                    { id: 'env2Decay', min: 0.1, max: 0.8 },
                    { id: 'env2Sustain', min: 0.2, max: 0.8 },
                    { id: 'env2Release', min: 0.1, max: 1.0 },
                    { id: 'lfo1Rate', min: 0.5, max: 10 },
                    { id: 'lfo1Depth', min: 0.1, max: 0.8 },
                    { id: 'delayTime', min: 0.1, max: 0.5 },
                    { id: 'delayFeedback', min: 0, max: 0.6 },
                    { id: 'reverbMix', min: 0.1, max: 0.5 }
                ];
                
                safeKnobsToRandomize.forEach(knob => {
                    const input = document.getElementById(knob.id);
                    if (input) {
                        // Use the safe min/max ranges instead of the full range
                        const randomValue = knob.min + Math.random() * (knob.max - knob.min);
                        input.value = randomValue;
                        input.dispatchEvent(new Event('input'));
                    }
                });
            }
            
            // Randomize piano roll - this is UI only, so safe regardless of audio state
            document.getElementById('randomizeNotes').click();
            
            // Randomize step sequencer (without breaking audio)
            document.querySelectorAll('.step').forEach(step => {
                // Randomize velocity - safe UI update
                const velocityFill = step.querySelector('.step-velocity-fill');
                if (velocityFill) {
                    const randomVelocity = 40 + Math.random() * 60; // 40-100%
                    velocityFill.style.width = `${randomVelocity}%`;
                }
                
                // Randomize probability - safe UI update
                const probabilitySlider = step.querySelector('.step-probability-slider');
                if (probabilitySlider) {
                    const randomProb = 0.4 + Math.random() * 0.6; // 0.4-1.0
                    probabilitySlider.value = randomProb;
                    
                    // Update the displayed probability percentage text
                    const probValue = step.querySelector('.step-probability-value');
                    if (probValue) {
                        probValue.textContent = `${Math.round(randomProb * 100)}%`;
                    }
                }
            });
            
            // Play a few random notes for audible feedback if audio is ready
            if (audioInitialized && mainSynth) {
                const notes = ['C3', 'E3', 'G3', 'B3', 'C4', 'E4', 'G4'];
                
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        const randomNote = notes[Math.floor(Math.random() * notes.length)];
                        playNotePreview(randomNote);
                    }, i * 150);
                }
            }
        }
        
        function playChord(root, type) {
            if (!audioInitialized) return;
            
            // Common chord intervals (in semitones)
            const chordIntervals = {
                'major': [0, 4, 7],          // Major triad
                'minor': [0, 3, 7],          // Minor triad
                'dom7': [0, 4, 7, 10],       // Dominant 7th
                'maj7': [0, 4, 7, 11],       // Major 7th
                'min7': [0, 3, 7, 10],       // Minor 7th
                'sus4': [0, 5, 7],           // Suspended 4th
                'dim': [0, 3, 6],            // Diminished
                'aug': [0, 4, 8]             // Augmented
            };
            
            // Base notes (for simplicity we're using a fixed octave)
            const baseNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const octave = 3;
            
            // Find the root note index
            const rootIndex = baseNotes.indexOf(root);
            if (rootIndex === -1) return;
            
            // Get the chord intervals
            const intervals = chordIntervals[type] || chordIntervals.major;
            
            // Calculate chord notes
            const chordNotes = intervals.map(interval => {
                const noteIndex = (rootIndex + interval) % 12;
                const noteOctave = octave + Math.floor((rootIndex + interval) / 12);
                return `${baseNotes[noteIndex]}${noteOctave}`;
            });
            
            // Get voice mode
            const voiceMode = document.getElementById('voiceMode').value;
            
            // Play the chord differently based on voice mode
            if (voiceMode === 'mono' || voiceMode === 'legato') {
                // For mono synths, we'll play the notes in sequence
                chordNotes.forEach((note, index) => {
                    // Release the previous note first for mono synth
                    if (index > 0) {
                        mainSynth.triggerRelease("+0.05");
                    }
                    
                    setTimeout(() => {
                        mainSynth.triggerAttack(note);
                        filterEnvelope.triggerAttack();  // Trigger filter envelope
                        highlightKeyboardKey(note);
                    }, index * 100);
                });
            } else {
                // For poly synth, play all notes at once
                mainSynth.triggerAttackRelease(chordNotes, "2n");
                
                // Trigger filter envelope
                filterEnvelope.triggerAttackRelease("2n");
                
                // Highlight keys visually
                chordNotes.forEach(note => {
                    highlightKeyboardKey(note);
                });
            }
            
            // Update active notes set
            chordNotes.forEach(note => activeNotes.add(note));
            
            // Update voice counter
            updateVoiceCounter();
            
            // Show chord name in the chord finder
            const chordFinder = document.getElementById('chordFinder');
            chordFinder.textContent = `Chord: ${root} ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            chordFinder.classList.add('visible');
            
            // Hide chord finder after a delay
            setTimeout(() => {
                chordFinder.classList.remove('visible');
            }, 2000);
            
            // Update VU meter
            updateVUMeter(0.9);
        }
        
        function detectChord(notes) {
            // Get note letters and octaves
            const noteLetters = notes.map(note => note.replace(/\d+/, ''));
            
            // Map note names to semitone values
            const noteValues = {
                'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5, 
                'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11
            };
            
            // Convert notes to semitone values
            const semitonesValues = noteLetters.map(note => noteValues[note]);
            
            // Sort the semitone values
            semitonesValues.sort((a, b) => a - b);
            
            // Calculate the intervals between notes (relative to the lowest note)
            const intervals = semitonesValues.map(val => val - semitonesValues[0]);
            
            // Common chord structures
            const chordStructures = {
                '0,4,7': { name: 'Major', shortName: 'maj' },
                '0,3,7': { name: 'Minor', shortName: 'min' },
                '0,3,6': { name: 'Diminished', shortName: 'dim' },
                '0,4,8': { name: 'Augmented', shortName: 'aug' },
                '0,4,7,11': { name: 'Major 7th', shortName: 'maj7' },
                '0,3,7,10': { name: 'Minor 7th', shortName: 'min7' },
                '0,4,7,10': { name: 'Dominant 7th', shortName: '7' },
                '0,3,6,10': { name: 'Half-Diminished', shortName: 'm7b5' },
                '0,5,7': { name: 'Suspended 4th', shortName: 'sus4' },
                '0,2,7': { name: 'Suspended 2nd', shortName: 'sus2' }
            };
            
            // Match intervals to chord structures
            const intervalString = intervals.toString();
            const matchedChord = chordStructures[intervalString];
            
            if (matchedChord) {
                // Get the root note name
                const rootIndex = semitonesValues[0] % 12;
                const rootNote = Object.keys(noteValues).find(key => noteValues[key] === rootIndex);
                
                return `${rootNote} ${matchedChord.name}`;
            } else {
                // If no match, return some generic description
                return "Unrecognized Chord";
            }
        }
        
        function playDrumSound(drum) {
            if (!audioInitialized) return;
            
            // Create a drum sound based on the type
            let sound;
            
            switch(drum) {
                case 'kick':
                    sound = new Tone.MembraneSynth({
                        pitchDecay: 0.05,
                        octaves: 5,
                        oscillator: { type: 'sine' },
                        envelope: {
                            attack: 0.001,
                            decay: 0.2,
                            sustain: 0,
                            release: 0.2
                        }
                    }).toDestination();
                    sound.triggerAttackRelease('C1', '8n');
                    break;
                    
                case 'snare':
                    sound = new Tone.NoiseSynth({
                        noise: { type: 'white' },
                        envelope: {
                            attack: 0.001,
                            decay: 0.2,
                            sustain: 0,
                            release: 0.2
                        }
                    }).toDestination();
                    sound.triggerAttackRelease('16n');
                    break;
                    
                case 'hihat':
                    sound = new Tone.MetalSynth({
                        frequency: 200,
                        envelope: {
                            attack: 0.001,
                            decay: 0.1,
                            release: 0.1
                        },
                        harmonicity: 5.1,
                        modulationIndex: 32,
                        resonance: 4000,
                        octaves: 1.5
                    }).toDestination();
                    sound.volume.value = -20;
                    sound.triggerAttackRelease('32n');
                    break;
                    
                case 'clap':
                    sound = new Tone.NoiseSynth({
                        noise: { type: 'pink' },
                        envelope: {
                            attack: 0.001,
                            decay: 0.15,
                            sustain: 0,
                            release: 0.1
                        }
                    }).toDestination();
                    sound.triggerAttackRelease('16n');
                    break;
                    
                case 'tom1':
                    sound = new Tone.MembraneSynth({
                        pitchDecay: 0.05,
                        octaves: 3,
                        oscillator: { type: 'sine' },
                        envelope: {
                            attack: 0.001,
                            decay: 0.3,
                            sustain: 0,
                            release: 0.3
                        }
                    }).toDestination();
                    sound.triggerAttackRelease('A2', '8n');
                    break;
                    
                case 'tom2':
                    sound = new Tone.MembraneSynth({
                        pitchDecay: 0.05,
                        octaves: 3,
                        oscillator: { type: 'sine' },
                        envelope: {
                            attack: 0.001,
                            decay: 0.3,
                            sustain: 0,
                            release: 0.3
                        }
                    }).toDestination();
                    sound.triggerAttackRelease('D2', '8n');
                    break;
                    
                case 'crash':
                    sound = new Tone.MetalSynth({
                        frequency: 300,
                        envelope: {
                            attack: 0.001,
                            decay: 1,
                            release: 1
                        },
                        harmonicity: 1,
                        modulationIndex: 16,
                        resonance: 8000,
                        octaves: 1.5
                    }).toDestination();
                    sound.volume.value = -15;
                    sound.triggerAttackRelease('8n');
                    break;
                    
                case 'ride':
                    sound = new Tone.MetalSynth({
                        frequency: 800,
                        envelope: {
                            attack: 0.001,
                            decay: 0.3,
                            release: 0.8
                        },
                        harmonicity: 3.1,
                        modulationIndex: 32,
                        resonance: 4000,
                        octaves: 0.8
                    }).toDestination();
                    sound.volume.value = -20;
                    sound.triggerAttackRelease('8n');
                    break;
            }
            
            // Visual feedback on VU meter
            updateVUMeter(0.9);
            setTimeout(() => {
                if (activeNotes.size === 0) {
                    updateVUMeter(0);
                }
            }, 200);
        }
        
        // Setup chord buttons
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.chord-button').forEach(button => {
                button.addEventListener('click', function() {
                    const chordType = this.getAttribute('data-chord');
                    
                    // Initialize audio if needed
                    if (!audioInitialized) {
                        initAudio().then(() => {
                            playChord('C', chordType);
                        });
                    } else {
                        playChord('C', chordType);
                    }
                });
            });
            
            // Initialize octave buttons
            document.getElementById('octaveDown').addEventListener('click', function() {
                const octaveDisplay = document.getElementById('currentOctave');
                const currentOctave = octaveDisplay.textContent.slice(-1);
                if (parseInt(currentOctave) > 1) {
                    octaveDisplay.textContent = `C${parseInt(currentOctave) - 1}`;
                }
            });
            
            document.getElementById('octaveUp').addEventListener('click', function() {
                const octaveDisplay = document.getElementById('currentOctave');
                const currentOctave = octaveDisplay.textContent.slice(-1);
                if (parseInt(currentOctave) < 7) {
                    octaveDisplay.textContent = `C${parseInt(currentOctave) + 1}`;
                }
            });
            
            // Initialize drum pads
            document.querySelectorAll('.drum-pad').forEach(pad => {
                pad.addEventListener('mousedown', function() {
                    const sound = this.getAttribute('data-sound');
                    
                    // Initialize audio if needed
                    if (!audioInitialized) {
                        initAudio().then(() => {
                            playDrumSound(sound);
                        });
                    } else {
                        playDrumSound(sound);
                    }
                });
            });
            
            // Initialize recording functionality
            document.getElementById('recordDrumButton').addEventListener('click', function() {
                this.classList.toggle('active');
                const isRecording = this.classList.contains('active');
                
                if (isRecording) {
                    // Start recording
                    showNotification('info', 'Recording started...');
                    document.getElementById('recordTime').classList.add('recording');
                    startRecordTimer();
                } else {
                    // Stop recording
                    showNotification('success', 'Recording completed!');
                    document.getElementById('recordTime').classList.remove('recording');
                    stopRecordTimer();
                }
            });
            
            document.getElementById('stopRecordButton').addEventListener('click', function() {
                const recordButton = document.getElementById('recordDrumButton');
                if (recordButton.classList.contains('active')) {
                    recordButton.classList.remove('active');
                    document.getElementById('recordTime').classList.remove('recording');
                    stopRecordTimer();
                    showNotification('success', 'Recording stopped!');
                }
            });
            
            document.getElementById('playRecordButton').addEventListener('click', function() {
                showNotification('info', 'Playing recording...');
                
                // Initialize audio if needed
                if (!audioInitialized) {
                    initAudio().then(() => {
                        playRecordedSequence();
                    });
                } else {
                    playRecordedSequence();
                }
            });
            
            // Initialize microphone input
            document.getElementById('micRecordButton').addEventListener('click', function() {
                this.classList.toggle('active');
                
                if (this.classList.contains('active')) {
                    // Initialize audio if needed
                    if (!audioInitialized) {
                        initAudio().then(() => {
                            startMicInput();
                        });
                    } else {
                        startMicInput();
                    }
                } else {
                    stopMicInput();
                }
            });
            
            // Initialize audio/microphone input button
            document.getElementById('recButton').addEventListener('click', function() {
                showNotification('info', 'Requesting audio input access...');
                
                // Initialize audio if needed
                if (!audioInitialized) {
                    initAudio().then(() => {
                        startMicInput();
                        
                        // Simulate clicking the mic record button
                        document.getElementById('micRecordButton').classList.add('active');
                    });
                } else {
                    startMicInput();
                    
                    // Simulate clicking the mic record button
                    document.getElementById('micRecordButton').classList.add('active');
                }
            });
        });
        
        function playRecordedSequence() {
            // Simulate random drum hits for demo
            let hits = 0;
            const maxHits = 8 + Math.floor(Math.random() * 8); // 8-16 hits
            const drums = ['kick', 'snare', 'hihat', 'clap', 'tom1', 'tom2', 'crash', 'ride'];
            
            const playInterval = setInterval(() => {
                if (hits >= maxHits) {
                    clearInterval(playInterval);
                    return;
                }
                
                const randomDrum = drums[Math.floor(Math.random() * drums.length)];
                const drumPad = document.querySelector(`.drum-pad[data-sound="${randomDrum}"]`);
                
                if (drumPad) {
                    drumPad.classList.add('active');
                    setTimeout(() => drumPad.classList.remove('active'), 100);
                    
                    playDrumSound(randomDrum);
                }
                
                hits++;
            }, 200);
        }
        
        function startMicInput() {
            if (!audioInitialized) return;
            
            showNotification('info', 'Microphone access requested...');
            
            // Request microphone access
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                // Set up microphone input
                const mic = new Tone.UserMedia();
                
                mic.open().then(() => {
                    showNotification('success', 'Microphone connected');
                    
                    // Create an analyzer for the microphone input level
                    const micAnalyzer = new Tone.Analyser('waveform', 128);
                    mic.connect(micAnalyzer);
                    
                    // Animate the mic level indicator
                    startMicLevelAnimation(micAnalyzer);
                    
                    // Process the mic input
                    const micFilter = new Tone.Filter(2000, "lowpass");
                    const micReverb = new Tone.Reverb(1.5);
                    
                    // Connect mic to effects and output
                    mic.connect(micFilter);
                    micFilter.connect(micReverb);
                    micReverb.connect(masterVolNode);
                    
                    // Store references for cleanup
                    window.micInput = {
                        mic: mic,
                        analyzer: micAnalyzer,
                        filter: micFilter,
                        reverb: micReverb
                    };
                    
                }).catch(err => {
                    console.error("Could not open microphone", err);
                    showNotification('error', 'Could not access microphone');
                    document.getElementById('micRecordButton').classList.remove('active');
                });
                
            }).catch(err => {
                console.error("Error accessing media devices", err);
                showNotification('error', 'Microphone access denied');
                document.getElementById('micRecordButton').classList.remove('active');
            });
        }
        
        function stopMicInput() {
            if (window.micInput && window.micInput.mic) {
                window.micInput.mic.close();
                
                // Disconnect everything
                window.micInput.mic.disconnect();
                window.micInput.filter.disconnect();
                window.micInput.reverb.disconnect();
                
                // Stop the level animation
                stopMicLevelAnimation();
                
                showNotification('success', 'Microphone disconnected');
            }
        }
        
        let recordTimerInterval;
        function startRecordTimer() {
            const timerElement = document.getElementById('recordTime');
            let seconds = 0;
            
            recordTimerInterval = setInterval(() => {
                seconds += 0.1;
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                const ms = Math.floor((seconds * 1000) % 1000);
                
                timerElement.textContent = `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
            }, 100);
        }
        
        function stopRecordTimer() {
            clearInterval(recordTimerInterval);
        }
        
        let micLevelAnimationId;
        function startMicLevelAnimation(analyzer) {
            const micLevelElement = document.getElementById('micLevel');
            
            const updateMicLevel = () => {
                if (!analyzer) {
                    // Generate a random "breathing" level for the microphone input
                    const now = Date.now() / 1000;
                    const breath = (Math.sin(now * 2) + 1) / 2; // 0-1 slow breathing
                    
                    // Add some random noise for realism
                    const noise = Math.random() * 0.3;
                    
                    // Combine for natural-looking mic level
                    const level = Math.min(1, breath * 0.7 + noise);
                    
                    micLevelElement.style.width = `${level * 100}%`;
                } else {
                    // Get actual mic level from analyzer
                    const waveform = analyzer.getValue();
                    
                    // Calculate RMS level
                    let sum = 0;
                    for (let i = 0; i < waveform.length; i++) {
                        sum += waveform[i] * waveform[i];
                    }
                    const rms = Math.sqrt(sum / waveform.length);
                    
                    // Scale to a reasonable range and apply some smoothing
                    const level = Math.min(1, rms * 5);
                    
                    micLevelElement.style.width = `${level * 100}%`;
                }
                
                micLevelAnimationId = requestAnimationFrame(updateMicLevel);
            };
            
            updateMicLevel();
        }
        
        function stopMicLevelAnimation() {
            cancelAnimationFrame(micLevelAnimationId);
            document.getElementById('micLevel').style.width = '0%';
        }
        
        // Setup sequencer UI
        function setupSequencerUI() {
            // Add event listeners for step buttons
            document.querySelectorAll('.step-button').forEach(button => {
                button.addEventListener('click', function() {
                    if (audioInitialized) {
                        // Toggle the active class
                        this.classList.toggle('active');
                    }
                });
            });
        }

        // Add this to your JavaScript (either inline or in your external JS file)
        document.addEventListener('DOMContentLoaded', function() {
            // Fix for step disabling issue
            const sequencerSteps = document.querySelectorAll('.sequencer-step');
            
            sequencerSteps.forEach(step => {
                step.addEventListener('click', function(e) {
                    // Toggle active class immediately for visual feedback
                    this.classList.toggle('disabled');
                });
            });
        });
    </script>


</body>
</html>
